
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Luthien Control Documentation</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="css/custom_toc.css">
    
      <link rel="stylesheet" href="css/api_styles.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="Luthien Control Documentation" class="md-header__button md-logo" aria-label="Luthien Control Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Luthien Control Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Home
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Luthien Control Documentation" class="md-nav__button md-logo" aria-label="Luthien Control Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Luthien Control Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#luthien_control.admin" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;admin
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" admin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.auth" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;auth
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" auth">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.auth.AdminAuthService" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AdminAuthService
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AdminAuthService">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.auth.AdminAuthService.authenticate" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;authenticate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.auth.AdminAuthService.create_session" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;create_session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.auth.AdminAuthService.ensure_default_admin" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;ensure_default_admin
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.auth.AdminAuthService.get_user_from_session" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_user_from_session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.auth.AdminAuthService.logout" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;logout
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;crud
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" crud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;admin_user
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" admin_user">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminSessionCRUD" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AdminSessionCRUD
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AdminSessionCRUD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminSessionCRUD.cleanup_expired_sessions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;cleanup_expired_sessions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminSessionCRUD.create_session" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;create_session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminSessionCRUD.delete_session" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;delete_session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminSessionCRUD.get_valid_session" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_valid_session
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AdminUserCRUD
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AdminUserCRUD">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD.create" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;create
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD.get_by_id" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_by_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD.get_by_username" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_by_username
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD.list_all" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;list_all
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD.verify_password" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;verify_password
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;dependencies
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" dependencies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.dependencies.CSRFProtection" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;CSRFProtection
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" CSRFProtection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.dependencies.CSRFProtection.generate_token" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;generate_token
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.dependencies.get_current_admin" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_current_admin
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.router" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;router
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" router">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.router.admin_home" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;admin_home
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.router.create_policy_handler" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;create_policy_handler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.router.edit_policy_page" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;edit_policy_page
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.router.login" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;login
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.router.login_page" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;login_page
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.router.logout" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;logout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.router.new_policy_page" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;new_policy_page
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.router.policies_list" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;policies_list
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.admin.router.update_policy_handler" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;update_policy_handler
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.api" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;api
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" api">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;openai_chat_completions
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" openai_chat_completions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.Choice" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Choice
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.CompletionTokensDetails" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;CompletionTokensDetails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.ContentPartImage" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ContentPartImage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.ContentPartText" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ContentPartText
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.FunctionDefinition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;FunctionDefinition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.ImageUrl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ImageUrl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.LogProbs" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LogProbs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.Message" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Message
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.OpenAIChatCompletionsRequest" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;OpenAIChatCompletionsRequest
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.OpenAIChatCompletionsResponse" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;OpenAIChatCompletionsResponse
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.PromptTokensDetails" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;PromptTokensDetails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.ResponseFormat" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ResponseFormat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.ToolChoice" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ToolChoice
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.ToolChoiceFunction" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ToolChoiceFunction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.ToolDefinition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ToolDefinition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.Usage" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;datatypes
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" datatypes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.Choice" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Choice
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.CompletionTokensDetails" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;CompletionTokensDetails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.ContentPartImage" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ContentPartImage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.ContentPartText" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ContentPartText
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.FunctionDefinition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;FunctionDefinition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.ImageUrl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ImageUrl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.LogProbs" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LogProbs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.Message" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Message
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.PromptTokensDetails" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;PromptTokensDetails
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.RequestFunctionCall" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;RequestFunctionCall
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.ResponseFormat" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ResponseFormat
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.ToolChoice" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ToolChoice
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.ToolChoiceFunction" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ToolChoiceFunction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.ToolDefinition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ToolDefinition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.datatypes.Usage" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.request" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;request
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" request">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.request.OpenAIChatCompletionsRequest" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;OpenAIChatCompletionsRequest
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.response" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;response
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" response">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.api.openai_chat_completions.response.OpenAIChatCompletionsResponse" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;OpenAIChatCompletionsResponse
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.control_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control_policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" control_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.add_api_key_header" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;add_api_key_header
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" add_api_key_header">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.add_api_key_header.AddApiKeyHeaderPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AddApiKeyHeaderPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AddApiKeyHeaderPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.add_api_key_header.AddApiKeyHeaderPolicy.apply" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;apply
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.add_api_key_header_from_env" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;add_api_key_header_from_env
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" add_api_key_header_from_env">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.add_api_key_header_from_env.AddApiKeyHeaderFromEnvPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AddApiKeyHeaderFromEnvPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AddApiKeyHeaderFromEnvPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.add_api_key_header_from_env.AddApiKeyHeaderFromEnvPolicy.apply" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;apply
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.backend_call_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;backend_call_policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" backend_call_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.backend_call_policy.BackendCallPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;BackendCallPolicy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.branching_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;branching_policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" branching_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;BranchingPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" BranchingPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy.apply" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;apply
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy.from_serialized" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;from_serialized
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy.serialize" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy.validate_cond_to_policy_map" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_cond_to_policy_map
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy.validate_default_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_default_policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.client_api_key_auth" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;client_api_key_auth
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" client_api_key_auth">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.client_api_key_auth.ClientApiKeyAuthPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ClientApiKeyAuthPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ClientApiKeyAuthPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.client_api_key_auth.ClientApiKeyAuthPolicy.apply" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;apply
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;conditions
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" conditions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.AllCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AllCondition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AllCondition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.AllCondition.serialize_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize_conditions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.AllCondition.validate_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_conditions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.AnyCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AnyCondition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AnyCondition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.AnyCondition.serialize_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize_conditions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.AnyCondition.validate_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_conditions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.Condition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Condition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" Condition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.Condition.from_serialized" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;from_serialized
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.Condition.serialize" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.ContainsCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ContainsCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.EqualsCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;EqualsCondition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" EqualsCondition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.EqualsCondition--traditional" class="md-nav__link">
    <span class="md-ellipsis">
      Traditional
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.EqualsCondition--dynamic" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.EqualsCondition--static-vs-dynamic" class="md-nav__link">
    <span class="md-ellipsis">
      Static vs dynamic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.GreaterThanCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;GreaterThanCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.GreaterThanOrEqualCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;GreaterThanOrEqualCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.LessThanCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LessThanCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.LessThanOrEqualCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LessThanOrEqualCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.NotCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NotCondition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" NotCondition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.NotCondition.serialize_cond" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize_cond
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.NotCondition.validate_cond" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_cond
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.NotEqualsCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NotEqualsCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.RegexMatchCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;RegexMatchCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.path" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;path
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.all_cond" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;all_cond
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" all_cond">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.all_cond.AllCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AllCondition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AllCondition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.all_cond.AllCondition.serialize_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize_conditions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.all_cond.AllCondition.validate_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_conditions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.any_cond" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;any_cond
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" any_cond">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.any_cond.AnyCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AnyCondition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AnyCondition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.any_cond.AnyCondition.serialize_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize_conditions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.any_cond.AnyCondition.validate_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_conditions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;comparison_conditions
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" comparison_conditions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions--pyright-type-checker-suppression" class="md-nav__link">
    <span class="md-ellipsis">
      Pyright Type Checker Suppression
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions--why-this-is-necessary" class="md-nav__link">
    <span class="md-ellipsis">
      Why This Is Necessary
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions--safety-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Safety Considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions--for-users-of-this-module" class="md-nav__link">
    <span class="md-ellipsis">
      For Users of This Module
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ComparisonCondition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ComparisonCondition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--constructor-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Constructor Usage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--positional-arguments-recommended-for-brevity" class="md-nav__link">
    <span class="md-ellipsis">
      Positional Arguments (Recommended for brevity)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--keyword-arguments-explicit-type-safe" class="md-nav__link">
    <span class="md-ellipsis">
      Keyword Arguments (Explicit, type-safe)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--pyright-type-checker-warning" class="md-nav__link">
    <span class="md-ellipsis">
      Pyright Type Checker Warning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--how-to-suppress-the-warning" class="md-nav__link">
    <span class="md-ellipsis">
      How to Suppress the Warning
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--when-to-use-each-approach" class="md-nav__link">
    <span class="md-ellipsis">
      When to Use Each Approach
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;evaluate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.from_legacy_format" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;from_legacy_format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.serialize_value_resolver" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize_value_resolver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.validate_value_resolver" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_value_resolver
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.ContainsCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ContainsCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.EqualsCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;EqualsCondition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" EqualsCondition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.EqualsCondition--traditional" class="md-nav__link">
    <span class="md-ellipsis">
      Traditional
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.EqualsCondition--dynamic" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.EqualsCondition--static-vs-dynamic" class="md-nav__link">
    <span class="md-ellipsis">
      Static vs dynamic
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.GreaterThanCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;GreaterThanCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.GreaterThanOrEqualCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;GreaterThanOrEqualCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.LessThanCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LessThanCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.LessThanOrEqualCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LessThanOrEqualCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.NotEqualsCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NotEqualsCondition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.comparison_conditions.RegexMatchCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;RegexMatchCondition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.condition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;condition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" condition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.condition.Condition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Condition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" Condition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.condition.Condition.from_serialized" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;from_serialized
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.condition.Condition.serialize" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.not_cond" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;not_cond
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" not_cond">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.not_cond.NotCondition" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NotCondition
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" NotCondition">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.not_cond.NotCondition.serialize_cond" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize_cond
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.not_cond.NotCondition.validate_cond" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_cond
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.util" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;util
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" util">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.util.get_transaction_value" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_transaction_value
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;value_resolvers
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" value_resolvers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.StaticValue" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;StaticValue
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" StaticValue">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.StaticValue.__eq__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__eq__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.StaticValue.resolve" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;resolve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.TransactionPath" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;TransactionPath
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" TransactionPath">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.TransactionPath.__eq__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__eq__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.TransactionPath.resolve" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;resolve
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ValueResolver
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ValueResolver">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver.from_serialized" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;from_serialized
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver.resolve" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;resolve
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver.serialize" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.auto_resolve_value" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;auto_resolve_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.create_value_resolver" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;create_value_resolver
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.conditions.value_resolvers.path" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;path
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.control_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control_policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" control_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.control_policy.ControlPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ControlPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ControlPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.control_policy.ControlPolicy.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.control_policy.ControlPolicy.apply" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;apply
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.control_policy.ControlPolicy.from_serialized" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;from_serialized
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.control_policy.ControlPolicy.get_policy_type_name" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_policy_type_name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.control_policy.ControlPolicy.serialize" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;serialize
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;exceptions
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" exceptions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.ApiKeyNotFoundError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ApiKeyNotFoundError
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ApiKeyNotFoundError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.ApiKeyNotFoundError.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.ClientAuthenticationError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ClientAuthenticationError
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ClientAuthenticationError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.ClientAuthenticationError.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.ClientAuthenticationNotFoundError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ClientAuthenticationNotFoundError
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ClientAuthenticationNotFoundError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.ClientAuthenticationNotFoundError.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.ControlPolicyError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ControlPolicyError
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ControlPolicyError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.ControlPolicyError.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.LeakedApiKeyError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LeakedApiKeyError
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" LeakedApiKeyError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.LeakedApiKeyError.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.NoRequestError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NoRequestError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.PolicyLoadError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;PolicyLoadError
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" PolicyLoadError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.exceptions.PolicyLoadError.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.leaked_api_key_detection" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;leaked_api_key_detection
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" leaked_api_key_detection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LeakedApiKeyDetectionPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" LeakedApiKeyDetectionPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy.apply" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;apply
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy.compile_patterns" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;compile_patterns
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy.validate_patterns" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_patterns
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.loader" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;loader
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" loader">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.loader.load_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.loader.load_policy_from_file" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_policy_from_file
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.model_name_replacement" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;model_name_replacement
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" model_name_replacement">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.model_name_replacement.ModelNameReplacementPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ModelNameReplacementPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ModelNameReplacementPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.model_name_replacement.ModelNameReplacementPolicy.apply" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;apply
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.noop_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;noop_policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" noop_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.noop_policy.NoopPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NoopPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" NoopPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.noop_policy.NoopPolicy.apply" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;apply
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.send_backend_request" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;send_backend_request
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" send_backend_request">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.send_backend_request.SendBackendRequestPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SendBackendRequestPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" SendBackendRequestPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.send_backend_request.SendBackendRequestPolicy.apply" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;apply
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.serial_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;serial_policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" serial_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.serial_policy.SerialPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SerialPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" SerialPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.serial_policy.SerialPolicy.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__repr__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.serial_policy.SerialPolicy.apply" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;apply
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.serial_policy.SerialPolicy.from_serialized" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;from_serialized
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.serialization" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;serialization
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" serialization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.serialization.SerializedPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SerializedPolicy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.serialization.safe_model_dump" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;safe_model_dump
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.serialization.safe_model_validate" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;safe_model_validate
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.set_backend_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;set_backend_policy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" set_backend_policy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.control_policy.set_backend_policy.SetBackendPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;SetBackendPolicy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.core" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;core
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;dependencies
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" dependencies">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.dependencies.get_db_session" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_db_session
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.dependencies.get_dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_dependencies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.dependencies.get_main_control_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_main_control_policy
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.dependencies.initialize_app_dependencies" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;initialize_app_dependencies
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.dependency_container" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;dependency_container
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" dependency_container">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.dependency_container.DependencyContainer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;DependencyContainer
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" DependencyContainer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.dependency_container.DependencyContainer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.dependency_container.DependencyContainer.create_openai_client" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;create_openai_client
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.generic_events" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;generic_events
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" generic_events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.generic_events.Event" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Event
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" Event">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.generic_events.Event.listener_count" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-property"></code>&nbsp;listener_count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.generic_events.Event.listener_count" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;listener_count
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.generic_events.Event.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.generic_events.Event.dispatch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;dispatch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.generic_events.Event.get_listeners" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_listeners
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.generic_events.Event.register" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;register
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.generic_events.Event.unregister" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;unregister
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.logging" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;logging
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" logging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.logging.setup_logging" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;setup_logging
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.request" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;request
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" request">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.request.Request" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Request
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.response" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;response
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" response">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.response.Response" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Response
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;tracked_context
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" tracked_context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;TrackedContext
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" TrackedContext">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.request" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-property"></code>&nbsp;request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.request" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.response" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-property"></code>&nbsp;response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.response" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.transaction_id" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-property"></code>&nbsp;transaction_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.transaction_id" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;transaction_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.get_all_data" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_all_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.get_data" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.set_data" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;set_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.update_request" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;update_request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.TrackedContext.update_response" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;update_response
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.get_tx_value" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_tx_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;tracked_context
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" tracked_context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.MutationEventPayload" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;MutationEventPayload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;TrackedContext
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" TrackedContext">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.request" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-property"></code>&nbsp;request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.request" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.response" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-property"></code>&nbsp;response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.response" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.transaction_id" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-property"></code>&nbsp;transaction_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.transaction_id" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;transaction_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.get_all_data" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_all_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.get_data" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.set_data" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;set_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.update_request" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;update_request
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.update_response" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;update_response
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.util" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;util
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" util">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.tracked_context.util.get_tx_value" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_tx_value
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.transaction" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;transaction
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" transaction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.transaction.Transaction" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Transaction
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.transaction_context" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;transaction_context
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" transaction_context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.transaction_context.TransactionContext" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;TransactionContext
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.core.transaction_context.get_tx_value" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_tx_value
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.custom_openapi_schema" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;custom_openapi_schema
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" custom_openapi_schema">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.custom_openapi_schema.create_custom_openapi" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;create_custom_openapi
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.db" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;db
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" db">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.ControlPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ControlPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ControlPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.ControlPolicy.__tablename__" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;__tablename__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.ControlPolicy.__tablename__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;__tablename__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.ControlPolicy.validate_timestamps" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_timestamps
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.LuthienLog" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LuthienLog
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" LuthienLog">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.LuthienLog.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.client_api_key_crud" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;client_api_key_crud
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" client_api_key_crud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.client_api_key_crud.create_api_key" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;create_api_key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.client_api_key_crud.get_api_key_by_value" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_api_key_by_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.client_api_key_crud.list_api_keys" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;list_api_keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.client_api_key_crud.update_api_key" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;update_api_key
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.control_policy_crud" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;control_policy_crud
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" control_policy_crud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.control_policy_crud.get_policy_by_name" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_policy_by_name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.control_policy_crud.get_policy_config_by_name" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_policy_config_by_name
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.control_policy_crud.list_policies" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;list_policies
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.control_policy_crud.load_policy_from_db" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;load_policy_from_db
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.control_policy_crud.save_policy_to_db" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;save_policy_to_db
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.control_policy_crud.update_policy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;update_policy
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.database_async" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;database_async
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" database_async">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.database_async.close_db_engine" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;close_db_engine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.database_async.create_db_engine" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;create_db_engine
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.database_async.get_db_session" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_db_session
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;exceptions
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" exceptions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.exceptions.LuthienDBIntegrityError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LuthienDBIntegrityError
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" LuthienDBIntegrityError">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.exceptions.LuthienDBIntegrityError.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.exceptions.LuthienDBOperationError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LuthienDBOperationError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.exceptions.LuthienDBQueryError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LuthienDBQueryError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.exceptions.LuthienDBTransactionError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LuthienDBTransactionError
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.luthien_log_crud" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;luthien_log_crud
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" luthien_log_crud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.luthien_log_crud.count_logs" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;count_logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.luthien_log_crud.get_log_by_id" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_log_by_id
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.luthien_log_crud.get_unique_datatypes" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_unique_datatypes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.luthien_log_crud.get_unique_transaction_ids" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_unique_transaction_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.luthien_log_crud.list_logs" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;list_logs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.naive_datetime" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;naive_datetime
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" naive_datetime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.naive_datetime.NaiveDatetime" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;NaiveDatetime
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" NaiveDatetime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.naive_datetime.NaiveDatetime.__get_pydantic_core_schema__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__get_pydantic_core_schema__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.naive_datetime.NaiveDatetime.now" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;now
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.sqlmodel_models" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;sqlmodel_models
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" sqlmodel_models">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.sqlmodel_models.AdminSession" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AdminSession
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.sqlmodel_models.AdminUser" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AdminUser
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.sqlmodel_models.ControlPolicy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;ControlPolicy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" ControlPolicy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.sqlmodel_models.ControlPolicy.__tablename__" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;__tablename__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.sqlmodel_models.ControlPolicy.__tablename__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;__tablename__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.sqlmodel_models.ControlPolicy.validate_timestamps" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;validate_timestamps
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.sqlmodel_models.JsonBOrJson" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;JsonBOrJson
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.sqlmodel_models.LuthienLog" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LuthienLog
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" LuthienLog">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.db.sqlmodel_models.LuthienLog.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.exceptions" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;exceptions
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" exceptions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.exceptions.LuthienDBConfigurationError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LuthienDBConfigurationError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.exceptions.LuthienDBConnectionError" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LuthienDBConnectionError
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.exceptions.LuthienDBException" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LuthienDBException
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.exceptions.LuthienException" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LuthienException
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.logs" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;logs
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" logs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.logs.router" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;router
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" router">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.logs.router.get_datatypes" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_datatypes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.logs.router.get_log" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_log
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.logs.router.get_logs" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_logs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.logs.router.get_transaction_ids" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_transaction_ids
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.logs.router.logs_ui" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;logs_ui
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.main" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;main
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" main">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.main.health_check" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;health_check
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.main.lifespan" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;lifespan
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.main.read_root" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;read_root
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.proxy" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;proxy
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" proxy">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.debugging" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;debugging
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" debugging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.debugging.DebugLoggingMiddleware" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;DebugLoggingMiddleware
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.debugging.create_debug_response" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;create_debug_response
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.debugging.log_policy_execution" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;log_policy_execution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.debugging.log_transaction_state" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;log_transaction_state
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.orchestration" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;orchestration
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" orchestration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.orchestration.run_policy_flow" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;run_policy_flow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.server" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;server
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" server">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.server.api_proxy_endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;api_proxy_endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.server.api_proxy_get_endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;api_proxy_get_endpoint
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.proxy.server.api_proxy_options_handler" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;api_proxy_options_handler
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.settings" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;settings
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" settings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Settings
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" Settings">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.admin_dsn" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-property"></code>&nbsp;admin_dsn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.admin_dsn" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;admin_dsn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.base_dsn" class="md-nav__link">
    <span class="md-ellipsis">
      &lt;code class=&#34;doc-symbol doc-symbol-toc doc-symbol-property"></code>&nbsp;base_dsn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.base_dsn" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;base_dsn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.dev_mode" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;dev_mode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_app_host" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_app_host
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_app_port" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_app_port
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_app_reload" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_app_reload
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_backend_url" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_backend_url
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_database_url" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_database_url
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_db_dsn" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_db_dsn
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_log_level" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_log_level
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_main_db_pool_max_size" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_main_db_pool_max_size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_main_db_pool_min_size" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_main_db_pool_min_size
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_openai_api_key" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_openai_api_key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_policy_filepath" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_policy_filepath
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_postgres_port" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_postgres_port
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_run_mode" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_run_mode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.settings.Settings.get_top_level_policy_name" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_top_level_policy_name
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#luthien_control.utils" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;utils
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" utils">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.utils.DeepEventedModel" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;DeepEventedModel
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.utils.backend_call_spec" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;backend_call_spec
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" backend_call_spec">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.utils.backend_call_spec.BackendCallSpec" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;BackendCallSpec
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#luthien_control.utils.deep_evented_model" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;deep_evented_model
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" deep_evented_model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#luthien_control.utils.deep_evented_model.DeepEventedModel" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;DeepEventedModel
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="api-reference">API Reference</h1>


<div class="doc doc-object doc-module">




    <div class="doc doc-contents first">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h2 id="luthien_control.admin" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>admin</code>


</h2>

    <div class="doc doc-contents ">

        <p>Admin module for Luthien Control.</p>









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="luthien_control.admin.auth" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>auth</code>


</h3>

    <div class="doc doc-contents ">

        <p>Authentication logic for admin users.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.admin.auth.AdminAuthService" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.admin.auth.AdminAuthService" class="doc-anchor"><code>AdminAuthService</code></a>


</h4>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/admin/auth.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdminAuthService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Service for admin authentication operations.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ensure_default_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure a default admin user exists.&quot;&quot;&quot;</span>
        <span class="c1"># Check if any admin users exist</span>
        <span class="n">admins</span> <span class="o">=</span> <span class="k">await</span> <span class="n">admin_user_crud</span><span class="o">.</span><span class="n">list_all</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">admins</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># Create default admin from environment variables</span>
        <span class="n">default_username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ADMIN_USERNAME&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">)</span>
        <span class="n">default_password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ADMIN_PASSWORD&quot;</span><span class="p">,</span> <span class="s2">&quot;changeme&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating default admin user &#39;</span><span class="si">{</span><span class="n">default_username</span><span class="si">}</span><span class="s2">&#39;. Please change the password immediately!&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">admin_user_crud</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">db</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="n">default_username</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">default_password</span><span class="p">,</span>
            <span class="n">is_superuser</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Authenticate admin user.&quot;&quot;&quot;</span>
        <span class="c1"># Clean up expired sessions</span>
        <span class="k">await</span> <span class="n">admin_session_crud</span><span class="o">.</span><span class="n">cleanup_expired_sessions</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

        <span class="c1"># Verify credentials</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">admin_user_crud</span><span class="o">.</span><span class="n">verify_password</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">admin_user</span><span class="p">:</span> <span class="n">AdminUser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdminSession</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new session for authenticated user.&quot;&quot;&quot;</span>
        <span class="n">session_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ADMIN_SESSION_HOURS&quot;</span><span class="p">,</span> <span class="s2">&quot;24&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">admin_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Admin user ID is None&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">admin_session_crud</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">admin_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">session_hours</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_from_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">session_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get admin user from session token.&quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">admin_session_crud</span><span class="o">.</span><span class="n">get_valid_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session_token</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">admin_user_crud</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">admin_user_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">user</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">session_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Logout by deleting session.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">admin_session_crud</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session_token</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Service for admin authentication operations.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.admin.auth.AdminAuthService.authenticate" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.auth.AdminAuthService.authenticate" class="doc-anchor"><code class="highlight language-python"><span class="n">authenticate</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/auth.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Authenticate admin user.&quot;&quot;&quot;</span>
    <span class="c1"># Clean up expired sessions</span>
    <span class="k">await</span> <span class="n">admin_session_crud</span><span class="o">.</span><span class="n">cleanup_expired_sessions</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>

    <span class="c1"># Verify credentials</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">admin_user_crud</span><span class="o">.</span><span class="n">verify_password</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Authenticate admin user.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.admin.auth.AdminAuthService.create_session" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.auth.AdminAuthService.create_session" class="doc-anchor"><code class="highlight language-python"><span class="n">create_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">admin_user</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/auth.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">admin_user</span><span class="p">:</span> <span class="n">AdminUser</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdminSession</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new session for authenticated user.&quot;&quot;&quot;</span>
    <span class="n">session_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ADMIN_SESSION_HOURS&quot;</span><span class="p">,</span> <span class="s2">&quot;24&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">admin_user</span><span class="o">.</span><span class="n">id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Admin user ID is None&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">admin_session_crud</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">admin_user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="n">session_hours</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create a new session for authenticated user.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.admin.auth.AdminAuthService.ensure_default_admin" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.auth.AdminAuthService.ensure_default_admin" class="doc-anchor"><code class="highlight language-python"><span class="n">ensure_default_admin</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/auth.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ensure_default_admin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure a default admin user exists.&quot;&quot;&quot;</span>
    <span class="c1"># Check if any admin users exist</span>
    <span class="n">admins</span> <span class="o">=</span> <span class="k">await</span> <span class="n">admin_user_crud</span><span class="o">.</span><span class="n">list_all</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">admins</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Create default admin from environment variables</span>
    <span class="n">default_username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ADMIN_USERNAME&quot;</span><span class="p">,</span> <span class="s2">&quot;admin&quot;</span><span class="p">)</span>
    <span class="n">default_password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ADMIN_PASSWORD&quot;</span><span class="p">,</span> <span class="s2">&quot;changeme&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating default admin user &#39;</span><span class="si">{</span><span class="n">default_username</span><span class="si">}</span><span class="s2">&#39;. Please change the password immediately!&quot;</span><span class="p">)</span>

    <span class="k">await</span> <span class="n">admin_user_crud</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
        <span class="n">db</span><span class="p">,</span>
        <span class="n">username</span><span class="o">=</span><span class="n">default_username</span><span class="p">,</span>
        <span class="n">password</span><span class="o">=</span><span class="n">default_password</span><span class="p">,</span>
        <span class="n">is_superuser</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Ensure a default admin user exists.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.admin.auth.AdminAuthService.get_user_from_session" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.auth.AdminAuthService.get_user_from_session" class="doc-anchor"><code class="highlight language-python"><span class="n">get_user_from_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session_token</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/auth.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_user_from_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">session_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get admin user from session token.&quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">admin_session_crud</span><span class="o">.</span><span class="n">get_valid_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session_token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">admin_user_crud</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session</span><span class="o">.</span><span class="n">admin_user_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">user</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get admin user from session token.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.admin.auth.AdminAuthService.logout" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.auth.AdminAuthService.logout" class="doc-anchor"><code class="highlight language-python"><span class="n">logout</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session_token</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/auth.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">session_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Logout by deleting session.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">admin_session_crud</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session_token</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Logout by deleting session.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.admin.crud" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>crud</code>


</h3>

    <div class="doc doc-contents ">

        <p>Admin CRUD operations.</p>









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h4 id="luthien_control.admin.crud.admin_user" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>admin_user</code>


</h4>

    <div class="doc doc-contents ">

        <p>CRUD operations for admin users.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.admin.crud.admin_user.AdminSessionCRUD" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminSessionCRUD" class="doc-anchor"><code>AdminSessionCRUD</code></a>


</h5>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdminSessionCRUD</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CRUD operations for admin sessions.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">admin_user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdminSession</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new admin session.&quot;&quot;&quot;</span>
        <span class="n">session_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
        <span class="n">expires_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>

        <span class="n">session</span> <span class="o">=</span> <span class="n">AdminSession</span><span class="p">(</span>
            <span class="n">session_token</span><span class="o">=</span><span class="n">session_token</span><span class="p">,</span>
            <span class="n">admin_user_id</span><span class="o">=</span><span class="n">admin_user_id</span><span class="p">,</span>
            <span class="n">expires_at</span><span class="o">=</span><span class="n">expires_at</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">session</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_valid_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">session_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminSession</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a valid (non-expired) session by token.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">AdminSession</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">and_</span><span class="p">(</span>
                    <span class="n">AdminSession</span><span class="o">.</span><span class="n">session_token</span> <span class="o">==</span> <span class="n">session_token</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                    <span class="n">AdminSession</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>  <span class="c1"># type: ignore</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">session_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete a session (logout).&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">AdminSession</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AdminSession</span><span class="o">.</span><span class="n">session_token</span> <span class="o">==</span> <span class="n">session_token</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_expired_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up expired sessions.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">AdminSession</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AdminSession</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
        <span class="p">)</span>
        <span class="n">expired_sessions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expired_sessions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">expired_sessions</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">count</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>CRUD operations for admin sessions.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.admin.crud.admin_user.AdminSessionCRUD.cleanup_expired_sessions" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminSessionCRUD.cleanup_expired_sessions" class="doc-anchor"><code class="highlight language-python"><span class="n">cleanup_expired_sessions</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_expired_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clean up expired sessions.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">select</span><span class="p">(</span><span class="n">AdminSession</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AdminSession</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">&lt;=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
    <span class="p">)</span>
    <span class="n">expired_sessions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

    <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expired_sessions</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="n">expired_sessions</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">count</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Clean up expired sessions.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.admin.crud.admin_user.AdminSessionCRUD.create_session" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminSessionCRUD.create_session" class="doc-anchor"><code class="highlight language-python"><span class="n">create_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">admin_user_id</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">admin_user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdminSession</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new admin session.&quot;&quot;&quot;</span>
    <span class="n">session_token</span> <span class="o">=</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
    <span class="n">expires_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="n">hours</span><span class="p">)</span>

    <span class="n">session</span> <span class="o">=</span> <span class="n">AdminSession</span><span class="p">(</span>
        <span class="n">session_token</span><span class="o">=</span><span class="n">session_token</span><span class="p">,</span>
        <span class="n">admin_user_id</span><span class="o">=</span><span class="n">admin_user_id</span><span class="p">,</span>
        <span class="n">expires_at</span><span class="o">=</span><span class="n">expires_at</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">session</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create a new admin session.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.admin.crud.admin_user.AdminSessionCRUD.delete_session" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminSessionCRUD.delete_session" class="doc-anchor"><code class="highlight language-python"><span class="n">delete_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session_token</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">delete_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">session_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete a session (logout).&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">AdminSession</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AdminSession</span><span class="o">.</span><span class="n">session_token</span> <span class="o">==</span> <span class="n">session_token</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Delete a session (logout).</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.admin.crud.admin_user.AdminSessionCRUD.get_valid_session" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminSessionCRUD.get_valid_session" class="doc-anchor"><code class="highlight language-python"><span class="n">get_valid_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session_token</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_valid_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">session_token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminSession</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a valid (non-expired) session by token.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">select</span><span class="p">(</span><span class="n">AdminSession</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">and_</span><span class="p">(</span>
                <span class="n">AdminSession</span><span class="o">.</span><span class="n">session_token</span> <span class="o">==</span> <span class="n">session_token</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="n">AdminSession</span><span class="o">.</span><span class="n">expires_at</span> <span class="o">&gt;</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a valid (non-expired) session by token.</p>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.admin.crud.admin_user.AdminUserCRUD" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD" class="doc-anchor"><code>AdminUserCRUD</code></a>


</h5>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdminUserCRUD</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CRUD operations for admin users.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get admin user by username.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">AdminUser</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AdminUser</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get admin user by ID.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">AdminUser</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AdminUser</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
        <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">is_superuser</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdminUser</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a new admin user.&quot;&quot;&quot;</span>
        <span class="n">password_hash</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">())</span>

        <span class="n">admin_user</span> <span class="o">=</span> <span class="n">AdminUser</span><span class="p">(</span>
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">password_hash</span><span class="o">=</span><span class="n">password_hash</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
            <span class="n">is_superuser</span><span class="o">=</span><span class="n">is_superuser</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">admin_user</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">admin_user</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">admin_user</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Verify username and password.&quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by_username</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">user</span><span class="o">.</span><span class="n">password_hash</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)):</span>
            <span class="c1"># Update last login</span>
            <span class="n">user</span><span class="o">.</span><span class="n">last_login</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">user</span>

        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;List all admin users.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">AdminUser</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">AdminUser</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>CRUD operations for admin users.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.admin.crud.admin_user.AdminUserCRUD.create" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD.create" class="doc-anchor"><code class="highlight language-python"><span class="n">create</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">is_superuser</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">is_superuser</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdminUser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new admin user.&quot;&quot;&quot;</span>
    <span class="n">password_hash</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">())</span>

    <span class="n">admin_user</span> <span class="o">=</span> <span class="n">AdminUser</span><span class="p">(</span>
        <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
        <span class="n">password_hash</span><span class="o">=</span><span class="n">password_hash</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span>
        <span class="n">is_superuser</span><span class="o">=</span><span class="n">is_superuser</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">admin_user</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">admin_user</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">admin_user</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create a new admin user.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.admin.crud.admin_user.AdminUserCRUD.get_by_id" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD.get_by_id" class="doc-anchor"><code class="highlight language-python"><span class="n">get_by_id</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get admin user by ID.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">AdminUser</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AdminUser</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get admin user by ID.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.admin.crud.admin_user.AdminUserCRUD.get_by_username" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD.get_by_username" class="doc-anchor"><code class="highlight language-python"><span class="n">get_by_username</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_by_username</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get admin user by username.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">AdminUser</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AdminUser</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">username</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get admin user by username.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.admin.crud.admin_user.AdminUserCRUD.list_all" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD.list_all" class="doc-anchor"><code class="highlight language-python"><span class="n">list_all</span><span class="p">(</span><span class="n">db</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all admin users.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">AdminUser</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">AdminUser</span><span class="o">.</span><span class="n">created_at</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>List all admin users.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.admin.crud.admin_user.AdminUserCRUD.verify_password" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.crud.admin_user.AdminUserCRUD.verify_password" class="doc-anchor"><code class="highlight language-python"><span class="n">verify_password</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/crud/admin_user.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">verify_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verify username and password.&quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by_username</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">user</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">),</span> <span class="n">user</span><span class="o">.</span><span class="n">password_hash</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)):</span>
        <span class="c1"># Update last login</span>
        <span class="n">user</span><span class="o">.</span><span class="n">last_login</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Verify username and password.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.admin.dependencies" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>dependencies</code>


</h3>

    <div class="doc doc-contents ">

        <p>Dependencies for admin authentication.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.admin.dependencies.CSRFProtection" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.admin.dependencies.CSRFProtection" class="doc-anchor"><code>CSRFProtection</code></a>


</h4>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/admin/dependencies.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CSRFProtection</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;CSRF protection for forms.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token_name</span> <span class="o">=</span> <span class="s2">&quot;csrf_token&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate CSRF token.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>

        <span class="k">return</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>CSRF protection for forms.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.admin.dependencies.CSRFProtection.generate_token" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.admin.dependencies.CSRFProtection.generate_token" class="doc-anchor"><code class="highlight language-python"><span class="n">generate_token</span><span class="p">()</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/dependencies.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">generate_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate CSRF token.&quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>

    <span class="k">return</span> <span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Generate CSRF token.</p>


    </div>

</div>



  </div>


    </div>

</div>
  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.admin.dependencies.get_current_admin" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.admin.dependencies.get_current_admin" class="doc-anchor"><code class="highlight language-python"><span class="n">get_current_admin</span><span class="p">(</span><span class="n">session_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/dependencies.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_current_admin</span><span class="p">(</span>
    <span class="n">session_token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Cookie</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AdminUser</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get current authenticated admin user from session cookie.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">session_token</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not authenticated&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">admin_auth_service</span><span class="o">.</span><span class="n">get_user_from_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session_token</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_401_UNAUTHORIZED</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid or expired session&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">user</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get current authenticated admin user from session cookie.</p>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.admin.router" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>router</code>


</h3>

    <div class="doc doc-contents ">

        <p>Admin router for authentication and policy management.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.admin.router.admin_home" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.admin.router.admin_home" class="doc-anchor"><code class="highlight language-python"><span class="n">admin_home</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">current_admin</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HTMLResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">admin_home</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">current_admin</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_admin</span><span class="p">)],</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HTMLResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Admin dashboard hub.&quot;&quot;&quot;</span>
    <span class="c1"># Get some basic stats for the dashboard</span>
    <span class="n">policies</span> <span class="o">=</span> <span class="k">await</span> <span class="n">list_policies</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">active_policies</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">policies</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_active</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;dashboard.html&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;current_admin&quot;</span><span class="p">:</span> <span class="n">current_admin</span><span class="p">,</span>
            <span class="s2">&quot;total_policies&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">policies</span><span class="p">),</span>
            <span class="s2">&quot;active_policies&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_policies</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Admin dashboard hub.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.admin.router.create_policy_handler" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.admin.router.create_policy_handler" class="doc-anchor"><code class="highlight language-python"><span class="n">create_policy_handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">current_admin</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">csrf_token</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/policies/new&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_policy_handler</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Form</span><span class="p">()],</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Form</span><span class="p">()],</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Form</span><span class="p">()],</span>
    <span class="n">current_admin</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_admin</span><span class="p">)],</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Form</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Form</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">csrf_token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Form</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle new policy creation.&quot;&quot;&quot;</span>
    <span class="c1"># Validate CSRF token</span>
    <span class="n">cookie_csrf</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cookie_csrf</span> <span class="ow">or</span> <span class="n">cookie_csrf</span> <span class="o">!=</span> <span class="n">csrf_token</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid request&quot;</span><span class="p">)</span>

    <span class="c1"># Parse and validate JSON config</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">new_csrf</span> <span class="o">=</span> <span class="k">await</span> <span class="n">csrf_protection</span><span class="o">.</span><span class="n">generate_token</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;policy_new.html&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;current_admin&quot;</span><span class="p">:</span> <span class="n">current_admin</span><span class="p">,</span>
                <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="n">new_csrf</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid JSON: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;form_data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                    <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                    <span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="n">is_active</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">new_csrf</span><span class="p">,</span>
            <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">secure</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
            <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># Create new policy</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">ControlPolicy</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config_dict</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="n">description</span><span class="p">,</span>
            <span class="n">is_active</span><span class="o">=</span><span class="n">is_active</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">await</span> <span class="n">save_policy_to_db</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">new_csrf</span> <span class="o">=</span> <span class="k">await</span> <span class="n">csrf_protection</span><span class="o">.</span><span class="n">generate_token</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;policy_new.html&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;current_admin&quot;</span><span class="p">:</span> <span class="n">current_admin</span><span class="p">,</span>
                <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="n">new_csrf</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Creation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;form_data&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">,</span>
                    <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                    <span class="s2">&quot;is_active&quot;</span><span class="p">:</span> <span class="n">is_active</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">},</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">new_csrf</span><span class="p">,</span>
            <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">secure</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
            <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>  <span class="c1"># type: ignore</span>

    <span class="n">redirect</span> <span class="o">=</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;/admin/policies&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">303</span><span class="p">)</span>
    <span class="n">redirect</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Handle new policy creation.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.admin.router.edit_policy_page" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.admin.router.edit_policy_page" class="doc-anchor"><code class="highlight language-python"><span class="n">edit_policy_page</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">,</span> <span class="n">current_admin</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/policies/</span><span class="si">{policy_name}</span><span class="s2">/edit&quot;</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HTMLResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">edit_policy_page</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">current_admin</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_admin</span><span class="p">)],</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HTMLResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display policy edit page.&quot;&quot;&quot;</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_policy_by_name</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Policy not found&quot;</span><span class="p">)</span>

    <span class="n">csrf_token</span> <span class="o">=</span> <span class="k">await</span> <span class="n">csrf_protection</span><span class="o">.</span><span class="n">generate_token</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;policy_edit.html&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;current_admin&quot;</span><span class="p">:</span> <span class="n">current_admin</span><span class="p">,</span>
            <span class="s2">&quot;policy&quot;</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span>
            <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="n">csrf_token</span><span class="p">,</span>
            <span class="s2">&quot;config_json&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">policy</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">csrf_token</span><span class="p">,</span>
        <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">secure</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
        <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Display policy edit page.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.admin.router.login" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.admin.router.login" class="doc-anchor"><code class="highlight language-python"><span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">csrf_token</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span>
    <span class="n">username</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Form</span><span class="p">()],</span>
    <span class="n">password</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Form</span><span class="p">()],</span>
    <span class="n">csrf_token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Form</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">)],</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle login form submission.&quot;&quot;&quot;</span>
    <span class="c1"># Validate CSRF token</span>
    <span class="n">cookie_csrf</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cookie_csrf</span> <span class="ow">or</span> <span class="n">cookie_csrf</span> <span class="o">!=</span> <span class="n">csrf_token</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;login.html&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="k">await</span> <span class="n">csrf_protection</span><span class="o">.</span><span class="n">generate_token</span><span class="p">(),</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid request. Please try again.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Authenticate user</span>
    <span class="n">user</span> <span class="o">=</span> <span class="k">await</span> <span class="n">admin_auth_service</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>
        <span class="n">new_csrf</span> <span class="o">=</span> <span class="k">await</span> <span class="n">csrf_protection</span><span class="o">.</span><span class="n">generate_token</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;login.html&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="n">new_csrf</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid username or password&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">new_csrf</span><span class="p">,</span>
            <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">secure</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
            <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># Create session</span>
    <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">admin_auth_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

    <span class="n">redirect</span> <span class="o">=</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;/admin/policies&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">303</span><span class="p">)</span>
    <span class="n">redirect</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;session_token&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">session</span><span class="o">.</span><span class="n">session_token</span><span class="p">,</span>
        <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">secure</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
        <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
        <span class="n">max_age</span><span class="o">=</span><span class="mi">86400</span><span class="p">,</span>  <span class="c1"># 24 hours</span>
    <span class="p">)</span>
    <span class="n">redirect</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">redirect</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Handle login form submission.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.admin.router.login_page" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.admin.router.login_page" class="doc-anchor"><code class="highlight language-python"><span class="n">login_page</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/login&quot;</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HTMLResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">login_page</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HTMLResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display login page.&quot;&quot;&quot;</span>
    <span class="n">csrf_token</span> <span class="o">=</span> <span class="k">await</span> <span class="n">csrf_protection</span><span class="o">.</span><span class="n">generate_token</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;login.html&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="n">csrf_token</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">csrf_token</span><span class="p">,</span>
        <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">secure</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
        <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Display login page.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.admin.router.logout" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.admin.router.logout" class="doc-anchor"><code class="highlight language-python"><span class="n">logout</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/logout&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Logout and redirect to login page.&quot;&quot;&quot;</span>
    <span class="n">session_token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;session_token&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">session_token</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">admin_auth_service</span><span class="o">.</span><span class="n">logout</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">session_token</span><span class="p">)</span>

    <span class="n">redirect</span> <span class="o">=</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;/admin/login&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">303</span><span class="p">)</span>
    <span class="n">redirect</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;session_token&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Logout and redirect to login page.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.admin.router.new_policy_page" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.admin.router.new_policy_page" class="doc-anchor"><code class="highlight language-python"><span class="n">new_policy_page</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">current_admin</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/policies/new&quot;</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HTMLResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">new_policy_page</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">current_admin</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_admin</span><span class="p">)],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HTMLResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display new policy creation page.&quot;&quot;&quot;</span>
    <span class="n">csrf_token</span> <span class="o">=</span> <span class="k">await</span> <span class="n">csrf_protection</span><span class="o">.</span><span class="n">generate_token</span><span class="p">()</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;policy_new.html&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;current_admin&quot;</span><span class="p">:</span> <span class="n">current_admin</span><span class="p">,</span>
            <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="n">csrf_token</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
        <span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">csrf_token</span><span class="p">,</span>
        <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">secure</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
        <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Display new policy creation page.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.admin.router.policies_list" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.admin.router.policies_list" class="doc-anchor"><code class="highlight language-python"><span class="n">policies_list</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">current_admin</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/policies&quot;</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HTMLResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">policies_list</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">current_admin</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_admin</span><span class="p">)],</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HTMLResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;List all control policies.&quot;&quot;&quot;</span>
    <span class="n">policies</span> <span class="o">=</span> <span class="k">await</span> <span class="n">list_policies</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
        <span class="n">request</span><span class="p">,</span>
        <span class="s2">&quot;policies.html&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;current_admin&quot;</span><span class="p">:</span> <span class="n">current_admin</span><span class="p">,</span>
            <span class="s2">&quot;policies&quot;</span><span class="p">:</span> <span class="n">policies</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>List all control policies.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.admin.router.update_policy_handler" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.admin.router.update_policy_handler" class="doc-anchor"><code class="highlight language-python"><span class="n">update_policy_handler</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">current_admin</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span> <span class="n">description</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_active</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">csrf_token</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/admin/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/policies/</span><span class="si">{policy_name}</span><span class="s2">/edit&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_policy_handler</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Form</span><span class="p">()],</span>
    <span class="n">current_admin</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">AdminUser</span><span class="p">,</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_current_admin</span><span class="p">)],</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Form</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Form</span><span class="p">()]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">csrf_token</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Form</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle policy update form submission.&quot;&quot;&quot;</span>
    <span class="c1"># Validate CSRF token</span>
    <span class="n">cookie_csrf</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cookie_csrf</span> <span class="ow">or</span> <span class="n">cookie_csrf</span> <span class="o">!=</span> <span class="n">csrf_token</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid request&quot;</span><span class="p">)</span>

    <span class="c1"># Get the policy first</span>
    <span class="n">policy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_policy_by_name</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Policy not found&quot;</span><span class="p">)</span>

    <span class="c1"># Parse and validate JSON config</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">config_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">new_csrf</span> <span class="o">=</span> <span class="k">await</span> <span class="n">csrf_protection</span><span class="o">.</span><span class="n">generate_token</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;policy_edit.html&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;current_admin&quot;</span><span class="p">:</span> <span class="n">current_admin</span><span class="p">,</span>
                <span class="s2">&quot;policy&quot;</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span>
                <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="n">new_csrf</span><span class="p">,</span>
                <span class="s2">&quot;config_json&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Invalid JSON: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">new_csrf</span><span class="p">,</span>
            <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">secure</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
            <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>  <span class="c1"># type: ignore</span>

    <span class="c1"># Update policy</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config_dict</span>
        <span class="k">if</span> <span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">policy</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">description</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="n">is_active</span>

        <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">db</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">new_csrf</span> <span class="o">=</span> <span class="k">await</span> <span class="n">csrf_protection</span><span class="o">.</span><span class="n">generate_token</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;policy_edit.html&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;current_admin&quot;</span><span class="p">:</span> <span class="n">current_admin</span><span class="p">,</span>
                <span class="s2">&quot;policy&quot;</span><span class="p">:</span> <span class="n">policy</span><span class="p">,</span>
                <span class="s2">&quot;csrf_token&quot;</span><span class="p">:</span> <span class="n">new_csrf</span><span class="p">,</span>
                <span class="s2">&quot;config_json&quot;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Update failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">new_csrf</span><span class="p">,</span>
            <span class="n">httponly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">secure</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">scheme</span> <span class="o">==</span> <span class="s2">&quot;https&quot;</span><span class="p">,</span>
            <span class="n">samesite</span><span class="o">=</span><span class="s2">&quot;strict&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>  <span class="c1"># type: ignore</span>

    <span class="n">redirect</span> <span class="o">=</span> <span class="n">RedirectResponse</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s2">&quot;/admin/policies&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">303</span><span class="p">)</span>
    <span class="n">redirect</span><span class="o">.</span><span class="n">delete_cookie</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;csrf_token&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">redirect</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Handle policy update form submission.</p>


    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.api" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>api</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="luthien_control.api.openai_chat_completions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>openai_chat_completions</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.Choice" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.Choice" class="doc-anchor"><code>Choice</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Choice</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single choice in a chat completion response.&quot;&quot;&quot;</span>

    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Message</span><span class="p">)</span>
    <span class="n">finish_reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LogProbs</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A single choice in a chat completion response.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.CompletionTokensDetails" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.CompletionTokensDetails" class="doc-anchor"><code>CompletionTokensDetails</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompletionTokensDetails</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Details about completion token usage.&quot;&quot;&quot;</span>

    <span class="n">reasoning_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">audio_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">accepted_prediction_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rejected_prediction_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Details about completion token usage.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.ContentPartImage" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.ContentPartImage" class="doc-anchor"><code>ContentPartImage</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ContentPartImage</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An image content part.&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;image_url&quot;</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">image_url</span><span class="p">:</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>An image content part.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.ContentPartText" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.ContentPartText" class="doc-anchor"><code>ContentPartText</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ContentPartText</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A text content part.&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A text content part.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.FunctionDefinition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.FunctionDefinition" class="doc-anchor"><code>FunctionDefinition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FunctionDefinition</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The definition of a function that can be called by the model.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">EDict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>The definition of a function that can be called by the model.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.ImageUrl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.ImageUrl" class="doc-anchor"><code>ImageUrl</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ImageUrl</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The image URL details.&quot;&quot;&quot;</span>

    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">detail</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>The image URL details.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.LogProbs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.LogProbs" class="doc-anchor"><code>LogProbs</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LogProbs</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log probability information for the choice.&quot;&quot;&quot;</span>

    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="n">EDict</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">EDict</span><span class="p">]())</span>
    <span class="n">refusal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="n">EDict</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">EDict</span><span class="p">]())</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Log probability information for the choice.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.Message" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.Message" class="doc-anchor"><code>Message</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Message</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A message in a chat completion.&quot;&quot;&quot;</span>

    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">refusal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">annotations</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">Annotation</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">Annotation</span><span class="p">]())</span>
    <span class="n">audio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Audio</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">function_call</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FunctionCall</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]())</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A message in a chat completion.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.OpenAIChatCompletionsRequest" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.OpenAIChatCompletionsRequest" class="doc-anchor"><code>OpenAIChatCompletionsRequest</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/request.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OpenAIChatCompletionsRequest</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request context for OpenAI chat completions.</span>

<span class="sd">    Based on the OpenAI API reference:</span>
<span class="sd">    https://platform.openai.com/docs/api-reference/chat/create?lang=python</span>
<span class="sd">    (retrieved 2025-06-16)</span>

<span class="sd">    This model is evented and will emit a `changed` signal on any modification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">audio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Audio</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">frequency_penalty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">function_call</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RequestFunctionCallSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># deprecated</span>
    <span class="n">functions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="n">FunctionDefinition</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># deprecated</span>
    <span class="n">logit_bias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">max_completion_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">max_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># deprecated</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">modalities</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">n</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parallel_tool_calls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Prediction</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">presence_penalty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># &quot;low&quot;, &quot;medium&quot;, &quot;high&quot;</span>
    <span class="n">response_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ResponseFormat</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">service_tier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">EList</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">stream</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">stream_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StreamOptions</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolChoice</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="n">ToolDefinition</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">top_logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">top_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">web_search_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WebSearchOptions</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Request context for OpenAI chat completions.</p>
<p>Based on the OpenAI API reference:
https://platform.openai.com/docs/api-reference/chat/create?lang=python
(retrieved 2025-06-16)</p>
<p>This model is evented and will emit a <code>changed</code> signal on any modification.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.OpenAIChatCompletionsResponse" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.OpenAIChatCompletionsResponse" class="doc-anchor"><code>OpenAIChatCompletionsResponse</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/response.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OpenAIChatCompletionsResponse</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The request for a chat completion.&quot;&quot;&quot;</span>

    <span class="n">choices</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">Choice</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">Choice</span><span class="p">]())</span>
    <span class="n">created</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="nb">object</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;chat.completion&quot;</span><span class="p">)</span>
    <span class="n">service_tier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">system_fingerprint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">usage</span><span class="p">:</span> <span class="n">Usage</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Usage</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>The request for a chat completion.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.PromptTokensDetails" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.PromptTokensDetails" class="doc-anchor"><code>PromptTokensDetails</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PromptTokensDetails</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Details about prompt token usage.&quot;&quot;&quot;</span>

    <span class="n">cached_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">audio_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Details about prompt token usage.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.ResponseFormat" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.ResponseFormat" class="doc-anchor"><code>ResponseFormat</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ResponseFormat</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An object specifying the format that the model must output.</span>

<span class="sd">    See https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;json_object&quot;</span><span class="p">,</span> <span class="s2">&quot;json_schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
    <span class="n">json_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>An object specifying the format that the model must output.</p>
<p>See https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.ToolChoice" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.ToolChoice" class="doc-anchor"><code>ToolChoice</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ToolChoice</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A specific tool choice.&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">ToolChoiceFunction</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A specific tool choice.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.ToolChoiceFunction" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.ToolChoiceFunction" class="doc-anchor"><code>ToolChoiceFunction</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ToolChoiceFunction</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function to call in a tool choice.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>The function to call in a tool choice.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.ToolDefinition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.ToolDefinition" class="doc-anchor"><code>ToolDefinition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ToolDefinition</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A tool that can be used by the model.&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">FunctionDefinition</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A tool that can be used by the model.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.api.openai_chat_completions.Usage" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.Usage" class="doc-anchor"><code>Usage</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Usage</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Token usage statistics for the chat completion request.&quot;&quot;&quot;</span>

    <span class="n">prompt_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">completion_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">total_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">prompt_tokens_details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PromptTokensDetails</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">PromptTokensDetails</span><span class="p">)</span>
    <span class="n">completion_tokens_details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompletionTokensDetails</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">CompletionTokensDetails</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Token usage statistics for the chat completion request.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>



<div class="doc doc-object doc-module">



<h4 id="luthien_control.api.openai_chat_completions.datatypes" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>datatypes</code>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.Choice" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.Choice" class="doc-anchor"><code>Choice</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Choice</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A single choice in a chat completion response.&quot;&quot;&quot;</span>

    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">Message</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Message</span><span class="p">)</span>
    <span class="n">finish_reason</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LogProbs</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A single choice in a chat completion response.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.CompletionTokensDetails" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.CompletionTokensDetails" class="doc-anchor"><code>CompletionTokensDetails</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompletionTokensDetails</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Details about completion token usage.&quot;&quot;&quot;</span>

    <span class="n">reasoning_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">audio_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">accepted_prediction_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">rejected_prediction_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Details about completion token usage.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.ContentPartImage" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.ContentPartImage" class="doc-anchor"><code>ContentPartImage</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ContentPartImage</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An image content part.&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;image_url&quot;</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">image_url</span><span class="p">:</span> <span class="n">ImageUrl</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>An image content part.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.ContentPartText" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.ContentPartText" class="doc-anchor"><code>ContentPartText</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ContentPartText</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A text content part.&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A text content part.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.FunctionDefinition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.FunctionDefinition" class="doc-anchor"><code>FunctionDefinition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FunctionDefinition</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The definition of a function that can be called by the model.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">EDict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>The definition of a function that can be called by the model.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.ImageUrl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.ImageUrl" class="doc-anchor"><code>ImageUrl</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ImageUrl</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The image URL details.&quot;&quot;&quot;</span>

    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">detail</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">,</span> <span class="s2">&quot;high&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>The image URL details.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.LogProbs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.LogProbs" class="doc-anchor"><code>LogProbs</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LogProbs</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log probability information for the choice.&quot;&quot;&quot;</span>

    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="n">EDict</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">EDict</span><span class="p">]())</span>
    <span class="n">refusal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="n">EDict</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">EDict</span><span class="p">]())</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Log probability information for the choice.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.Message" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.Message" class="doc-anchor"><code>Message</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Message</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A message in a chat completion.&quot;&quot;&quot;</span>

    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">refusal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">annotations</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">Annotation</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">Annotation</span><span class="p">]())</span>
    <span class="n">audio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Audio</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">function_call</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FunctionCall</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">tool_calls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">ToolCall</span><span class="p">]())</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A message in a chat completion.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.PromptTokensDetails" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.PromptTokensDetails" class="doc-anchor"><code>PromptTokensDetails</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PromptTokensDetails</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Details about prompt token usage.&quot;&quot;&quot;</span>

    <span class="n">cached_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">audio_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Details about prompt token usage.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.RequestFunctionCall" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.RequestFunctionCall" class="doc-anchor"><code>RequestFunctionCall</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RequestFunctionCall</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A function call in a request.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A function call in a request.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.ResponseFormat" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.ResponseFormat" class="doc-anchor"><code>ResponseFormat</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ResponseFormat</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An object specifying the format that the model must output.</span>

<span class="sd">    See https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;json_object&quot;</span><span class="p">,</span> <span class="s2">&quot;json_schema&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">)</span>
    <span class="n">json_schema</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>An object specifying the format that the model must output.</p>
<p>See https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.ToolChoice" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.ToolChoice" class="doc-anchor"><code>ToolChoice</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ToolChoice</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A specific tool choice.&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">ToolChoiceFunction</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A specific tool choice.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.ToolChoiceFunction" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.ToolChoiceFunction" class="doc-anchor"><code>ToolChoiceFunction</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ToolChoiceFunction</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The function to call in a tool choice.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>The function to call in a tool choice.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.ToolDefinition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.ToolDefinition" class="doc-anchor"><code>ToolDefinition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ToolDefinition</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A tool that can be used by the model.&quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;function&quot;</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">function</span><span class="p">:</span> <span class="n">FunctionDefinition</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A tool that can be used by the model.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.datatypes.Usage" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.datatypes.Usage" class="doc-anchor"><code>Usage</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/datatypes.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Usage</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Token usage statistics for the chat completion request.&quot;&quot;&quot;</span>

    <span class="n">prompt_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">completion_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">total_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">prompt_tokens_details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">PromptTokensDetails</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">PromptTokensDetails</span><span class="p">)</span>
    <span class="n">completion_tokens_details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CompletionTokensDetails</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">CompletionTokensDetails</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Token usage statistics for the chat completion request.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="luthien_control.api.openai_chat_completions.request" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>request</code>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.request.OpenAIChatCompletionsRequest" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.request.OpenAIChatCompletionsRequest" class="doc-anchor"><code>OpenAIChatCompletionsRequest</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/request.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OpenAIChatCompletionsRequest</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request context for OpenAI chat completions.</span>

<span class="sd">    Based on the OpenAI API reference:</span>
<span class="sd">    https://platform.openai.com/docs/api-reference/chat/create?lang=python</span>
<span class="sd">    (retrieved 2025-06-16)</span>

<span class="sd">    This model is evented and will emit a `changed` signal on any modification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">messages</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">Message</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">audio</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Audio</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">frequency_penalty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">function_call</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RequestFunctionCallSpec</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># deprecated</span>
    <span class="n">functions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="n">FunctionDefinition</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># deprecated</span>
    <span class="n">logit_bias</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">max_completion_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">max_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># deprecated</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">modalities</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">n</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">parallel_tool_calls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Prediction</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">presence_penalty</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">reasoning_effort</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># &quot;low&quot;, &quot;medium&quot;, &quot;high&quot;</span>
    <span class="n">response_format</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ResponseFormat</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">seed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">service_tier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">stop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="n">EList</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">stream</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">stream_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">StreamOptions</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">tool_choice</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ToolChoice</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">tools</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">EList</span><span class="p">[</span><span class="n">ToolDefinition</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">top_logprobs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">top_p</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">web_search_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WebSearchOptions</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Request context for OpenAI chat completions.</p>
<p>Based on the OpenAI API reference:
https://platform.openai.com/docs/api-reference/chat/create?lang=python
(retrieved 2025-06-16)</p>
<p>This model is evented and will emit a <code>changed</code> signal on any modification.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="luthien_control.api.openai_chat_completions.response" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>response</code>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.api.openai_chat_completions.response.OpenAIChatCompletionsResponse" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.api.openai_chat_completions.response.OpenAIChatCompletionsResponse" class="doc-anchor"><code>OpenAIChatCompletionsResponse</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.deep_evented_model.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/api/openai_chat_completions/response.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OpenAIChatCompletionsResponse</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The request for a chat completion.&quot;&quot;&quot;</span>

    <span class="n">choices</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">Choice</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">EList</span><span class="p">[</span><span class="n">Choice</span><span class="p">]())</span>
    <span class="n">created</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="nb">object</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;chat.completion&quot;</span><span class="p">)</span>
    <span class="n">service_tier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">system_fingerprint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">usage</span><span class="p">:</span> <span class="n">Usage</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Usage</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>The request for a chat completion.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.control_policy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control_policy</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.add_api_key_header" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>add_api_key_header</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.add_api_key_header.AddApiKeyHeaderPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.add_api_key_header.AddApiKeyHeaderPolicy" class="doc-anchor"><code>AddApiKeyHeaderPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/add_api_key_header.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AddApiKeyHeaderPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds the configured OpenAI API key to the request Authorization header.</span>

<span class="sd">    This policy reads the API key from the application settings and adds it</span>
<span class="sd">    to the request. It has no policy-specific configuration beyond its name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;AddApiKeyHeaderPolicy&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the API key on the transaction&#39;s request.</span>

<span class="sd">        Reads OpenAI API key from settings via the container.</span>
<span class="sd">        Requires the DependencyContainer and AsyncSession in signature for interface compliance,</span>
<span class="sd">        but session is not directly used in this policy&#39;s logic.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NoRequestError if the request is not found in the transaction.</span>
<span class="sd">            ApiKeyNotFoundError if the OpenAI API key is not configured.</span>

<span class="sd">        Args:</span>
<span class="sd">            transaction: The current transaction.</span>
<span class="sd">            container: The application dependency container.</span>
<span class="sd">            session: An active SQLAlchemy AsyncSession (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The potentially modified transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoRequestError</span><span class="p">(</span><span class="s2">&quot;No request in transaction.&quot;</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get_openai_api_key</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ApiKeyNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAI API key not configured (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting API key from settings (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>

        <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Adds the configured OpenAI API key to the request Authorization header.</p>
<p>This policy reads the API key from the application settings and adds it
to the request. It has no policy-specific configuration beyond its name.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.add_api_key_header.AddApiKeyHeaderPolicy.apply" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.add_api_key_header.AddApiKeyHeaderPolicy.apply" class="doc-anchor"><code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/add_api_key_header.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the API key on the transaction&#39;s request.</span>

<span class="sd">    Reads OpenAI API key from settings via the container.</span>
<span class="sd">    Requires the DependencyContainer and AsyncSession in signature for interface compliance,</span>
<span class="sd">    but session is not directly used in this policy&#39;s logic.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NoRequestError if the request is not found in the transaction.</span>
<span class="sd">        ApiKeyNotFoundError if the OpenAI API key is not configured.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The current transaction.</span>
<span class="sd">        container: The application dependency container.</span>
<span class="sd">        session: An active SQLAlchemy AsyncSession (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The potentially modified transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoRequestError</span><span class="p">(</span><span class="s2">&quot;No request in transaction.&quot;</span><span class="p">)</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get_openai_api_key</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ApiKeyNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAI API key not configured (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting API key from settings (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>

    <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Sets the API key on the transaction's request.</p>
<p>Reads OpenAI API key from settings via the container.
Requires the DependencyContainer and AsyncSession in signature for interface compliance,
but session is not directly used in this policy's logic.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current transaction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The application dependency container.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An active SQLAlchemy AsyncSession (unused).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The potentially modified transaction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.add_api_key_header_from_env" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>add_api_key_header_from_env</code>


</h3>

    <div class="doc doc-contents ">

        <p>Add an API key header, where the key is sourced from a configured environment variable.</p>
<p>This policy is used to add an API key to the request Authorization header.
The API key is read from an environment variable whose name is configured
when the policy is instantiated.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.add_api_key_header_from_env.AddApiKeyHeaderFromEnvPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.add_api_key_header_from_env.AddApiKeyHeaderFromEnvPolicy" class="doc-anchor"><code>AddApiKeyHeaderFromEnvPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/add_api_key_header_from_env.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AddApiKeyHeaderFromEnvPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Adds an API key to the request Authorization header from an environment variable.</span>

<span class="sd">    The API key is read from an environment variable whose name is configured</span>
<span class="sd">    when the policy is instantiated. This allows different API keys to be used</span>
<span class="sd">    based on deployment environment.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">api_key_env_var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the API key on the transaction&#39;s request.</span>

<span class="sd">        The API key is read from the environment variable specified by self.api_key_env_var_name.</span>
<span class="sd">        Requires DependencyContainer and AsyncSession for interface compliance, but they are not</span>
<span class="sd">        directly used in this policy&#39;s primary logic beyond what ControlPolicy might require.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NoRequestError if the request is not found in the transaction.</span>
<span class="sd">            ApiKeyNotFoundError if the configured environment variable is not set or is empty.</span>

<span class="sd">        Args:</span>
<span class="sd">            transaction: The current transaction.</span>
<span class="sd">            container: The application dependency container (unused).</span>
<span class="sd">            session: An active SQLAlchemy AsyncSession (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The potentially modified transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoRequestError</span><span class="p">(</span><span class="s2">&quot;No request in transaction.&quot;</span><span class="p">)</span>

        <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_env_var_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;API key not found. Environment variable &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_env_var_name</span><span class="si">}</span><span class="s2">&#39; is not set or is empty.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ApiKeyNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting API key from env var &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_env_var_name</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>

        <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Adds an API key to the request Authorization header from an environment variable.</p>
<p>The API key is read from an environment variable whose name is configured
when the policy is instantiated. This allows different API keys to be used
based on deployment environment.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.add_api_key_header_from_env.AddApiKeyHeaderFromEnvPolicy.apply" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.add_api_key_header_from_env.AddApiKeyHeaderFromEnvPolicy.apply" class="doc-anchor"><code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/add_api_key_header_from_env.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets the API key on the transaction&#39;s request.</span>

<span class="sd">    The API key is read from the environment variable specified by self.api_key_env_var_name.</span>
<span class="sd">    Requires DependencyContainer and AsyncSession for interface compliance, but they are not</span>
<span class="sd">    directly used in this policy&#39;s primary logic beyond what ControlPolicy might require.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NoRequestError if the request is not found in the transaction.</span>
<span class="sd">        ApiKeyNotFoundError if the configured environment variable is not set or is empty.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The current transaction.</span>
<span class="sd">        container: The application dependency container (unused).</span>
<span class="sd">        session: An active SQLAlchemy AsyncSession (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The potentially modified transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoRequestError</span><span class="p">(</span><span class="s2">&quot;No request in transaction.&quot;</span><span class="p">)</span>

    <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_env_var_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
        <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;API key not found. Environment variable &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_env_var_name</span><span class="si">}</span><span class="s2">&#39; is not set or is empty.&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ApiKeyNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Setting API key from env var &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key_env_var_name</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>

    <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Sets the API key on the transaction's request.</p>
<p>The API key is read from the environment variable specified by self.api_key_env_var_name.
Requires DependencyContainer and AsyncSession for interface compliance, but they are not
directly used in this policy's primary logic beyond what ControlPolicy might require.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current transaction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The application dependency container (unused).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An active SQLAlchemy AsyncSession (unused).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The potentially modified transaction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.backend_call_policy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>backend_call_policy</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.backend_call_policy.BackendCallPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.backend_call_policy.BackendCallPolicy" class="doc-anchor"><code>BackendCallPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/backend_call_policy.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BackendCallPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This policy makes a backend LLM call.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;BackendCallPolicy&quot;</span><span class="p">)</span>
    <span class="n">backend_call_spec</span><span class="p">:</span> <span class="n">BackendCallSpec</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_call_spec</span><span class="o">.</span><span class="n">api_key_env_var</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">api_key</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_call_spec</span><span class="o">.</span><span class="n">api_endpoint</span>

        <span class="c1"># Update the request payload with all arguments from backend_call_spec.request_args</span>
        <span class="c1"># Use model_validate to properly handle nested pydantic models and EventedList/EventedDict</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_call_spec</span><span class="o">.</span><span class="n">request_args</span><span class="p">:</span>
            <span class="n">current_data</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="n">current_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_call_spec</span><span class="o">.</span><span class="n">request_args</span><span class="p">)</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">current_data</span><span class="p">)</span>

        <span class="c1"># Set the model if specified</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_call_spec</span><span class="o">.</span><span class="n">model</span><span class="p">:</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_call_spec</span><span class="o">.</span><span class="n">model</span>

        <span class="n">openai_client</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">create_openai_client</span><span class="p">(</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_endpoint</span><span class="p">,</span> <span class="n">api_key</span> <span class="ow">or</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response_payload</span> <span class="o">=</span> <span class="k">await</span> <span class="n">openai_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">response_payload</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">api_endpoint</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_endpoint</span>
        <span class="k">except</span> <span class="n">openai</span><span class="o">.</span><span class="n">APITimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">openai</span><span class="o">.</span><span class="n">APIConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">openai</span><span class="o">.</span><span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAI API error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>This policy makes a backend LLM call.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.branching_policy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>branching_policy</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.branching_policy.BranchingPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy" class="doc-anchor"><code>BranchingPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/branching_policy.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BranchingPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Control Policy that conditionally applies different policies based on transaction evaluation.</span>

<span class="sd">    This policy evaluates conditions in order and applies the policy associated with the first</span>
<span class="sd">    matching condition. If no conditions match, it applies the default policy (if configured).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;BranchingPolicy&quot;</span><span class="p">)</span>
    <span class="n">cond_to_policy_map</span><span class="p">:</span> <span class="n">OrderedDict</span><span class="p">[</span><span class="n">Condition</span><span class="p">,</span> <span class="n">ControlPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">OrderedDict</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">default_policy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ControlPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;cond_to_policy_map&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_cond_to_policy_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate and convert condition-to-policy mapping.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cond_to_policy_map must be a dict or OrderedDict&quot;</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;default_policy&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_default_policy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate default policy field.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the first policy that matches the condition. If no condition matches, apply the default policy (if set).</span>

<span class="sd">        Args:</span>
<span class="sd">            transaction: The transaction to apply the policy to.</span>
<span class="sd">            container: The dependency container.</span>
<span class="sd">            session: The database session.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The potentially modified transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cond</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond_to_policy_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cond</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">transaction</span><span class="p">):</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">policy</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">transaction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override serialize to handle complex condition-to-policy mapping.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cond_to_policy_map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cond</span><span class="o">.</span><span class="n">serialize</span><span class="p">()):</span> <span class="n">policy</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="k">for</span> <span class="n">cond</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond_to_policy_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;default_policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;default_policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BranchingPolicy&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom from_serialized to handle JSON-serialized condition keys.&quot;&quot;&quot;</span>
        <span class="n">config_copy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="n">cond_to_policy_map</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="n">serialized_cond_map</span> <span class="o">=</span> <span class="n">config_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cond_to_policy_map&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">serialized_cond_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">serialized_cond_map</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected &#39;cond_to_policy_map&#39; to be a dict in BranchingPolicy config, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">serialized_cond_map</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">for</span> <span class="n">cond_json_str</span><span class="p">,</span> <span class="n">policy_config</span> <span class="ow">in</span> <span class="n">serialized_cond_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond_json_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Condition key in &#39;cond_to_policy_map&#39; must be a JSON string, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cond_json_str</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">policy_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Policy config for condition &#39;</span><span class="si">{</span><span class="n">cond_json_str</span><span class="si">}</span><span class="s2">&#39; must be a dict, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">policy_config</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">condition_serializable_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cond_json_str</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse condition JSON string &#39;</span><span class="si">{</span><span class="n">cond_json_str</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition_serializable_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Deserialized condition config for &#39;</span><span class="si">{</span><span class="n">cond_json_str</span><span class="si">}</span><span class="s2">&#39; must be a dict, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">condition_serializable_dict</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="n">condition</span> <span class="o">=</span> <span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">condition_serializable_dict</span><span class="p">)</span>
                <span class="n">policy</span> <span class="o">=</span> <span class="n">ControlPolicy</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">policy_config</span><span class="p">)</span>
                <span class="n">cond_to_policy_map</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy</span>

        <span class="n">default_policy</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">default_policy_serializable</span> <span class="o">=</span> <span class="n">config_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default_policy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">default_policy_serializable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_policy_serializable</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Expected &#39;default_policy&#39; config to be a dict, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">default_policy_serializable</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">default_policy</span> <span class="o">=</span> <span class="n">ControlPolicy</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">default_policy_serializable</span><span class="p">)</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">config_copy</span><span class="p">)</span>

        <span class="n">instance</span><span class="o">.</span><span class="n">cond_to_policy_map</span> <span class="o">=</span> <span class="n">cond_to_policy_map</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">default_policy</span> <span class="o">=</span> <span class="n">default_policy</span>

        <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A Control Policy that conditionally applies different policies based on transaction evaluation.</p>
<p>This policy evaluates conditions in order and applies the policy associated with the first
matching condition. If no conditions match, it applies the default policy (if configured).</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.branching_policy.BranchingPolicy.apply" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy.apply" class="doc-anchor"><code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/branching_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the first policy that matches the condition. If no condition matches, apply the default policy (if set).</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The transaction to apply the policy to.</span>
<span class="sd">        container: The dependency container.</span>
<span class="sd">        session: The database session.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The potentially modified transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">cond</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond_to_policy_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">cond</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">transaction</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">policy</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Apply the first policy that matches the condition. If no condition matches, apply the default policy (if set).</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The transaction to apply the policy to.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dependency container.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The potentially modified transaction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.branching_policy.BranchingPolicy.from_serialized" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy.from_serialized" class="doc-anchor"><code class="highlight language-python"><span class="n">from_serialized</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/branching_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;BranchingPolicy&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom from_serialized to handle JSON-serialized condition keys.&quot;&quot;&quot;</span>
    <span class="n">config_copy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">cond_to_policy_map</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
    <span class="n">serialized_cond_map</span> <span class="o">=</span> <span class="n">config_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;cond_to_policy_map&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">serialized_cond_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">serialized_cond_map</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected &#39;cond_to_policy_map&#39; to be a dict in BranchingPolicy config, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">serialized_cond_map</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">cond_json_str</span><span class="p">,</span> <span class="n">policy_config</span> <span class="ow">in</span> <span class="n">serialized_cond_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cond_json_str</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Condition key in &#39;cond_to_policy_map&#39; must be a JSON string, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">cond_json_str</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">policy_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Policy config for condition &#39;</span><span class="si">{</span><span class="n">cond_json_str</span><span class="si">}</span><span class="s2">&#39; must be a dict, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">policy_config</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">condition_serializable_dict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">cond_json_str</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse condition JSON string &#39;</span><span class="si">{</span><span class="n">cond_json_str</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">condition_serializable_dict</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Deserialized condition config for &#39;</span><span class="si">{</span><span class="n">cond_json_str</span><span class="si">}</span><span class="s2">&#39; must be a dict, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">condition_serializable_dict</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="n">condition</span> <span class="o">=</span> <span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">condition_serializable_dict</span><span class="p">)</span>
            <span class="n">policy</span> <span class="o">=</span> <span class="n">ControlPolicy</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">policy_config</span><span class="p">)</span>
            <span class="n">cond_to_policy_map</span><span class="p">[</span><span class="n">condition</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy</span>

    <span class="n">default_policy</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">default_policy_serializable</span> <span class="o">=</span> <span class="n">config_copy</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;default_policy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">default_policy_serializable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">default_policy_serializable</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected &#39;default_policy&#39; config to be a dict, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">default_policy_serializable</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">default_policy</span> <span class="o">=</span> <span class="n">ControlPolicy</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">default_policy_serializable</span><span class="p">)</span>

    <span class="n">instance</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">config_copy</span><span class="p">)</span>

    <span class="n">instance</span><span class="o">.</span><span class="n">cond_to_policy_map</span> <span class="o">=</span> <span class="n">cond_to_policy_map</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">default_policy</span> <span class="o">=</span> <span class="n">default_policy</span>

    <span class="k">return</span> <span class="n">instance</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom from_serialized to handle JSON-serialized condition keys.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.branching_policy.BranchingPolicy.serialize" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy.serialize" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize</span><span class="p">()</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/branching_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Override serialize to handle complex condition-to-policy mapping.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cond_to_policy_map&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">cond</span><span class="o">.</span><span class="n">serialize</span><span class="p">()):</span> <span class="n">policy</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="k">for</span> <span class="n">cond</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond_to_policy_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;default_policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_policy</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;default_policy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Override serialize to handle complex condition-to-policy mapping.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.branching_policy.BranchingPolicy.validate_cond_to_policy_map" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy.validate_cond_to_policy_map" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_cond_to_policy_map</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/branching_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;cond_to_policy_map&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_cond_to_policy_map</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate and convert condition-to-policy mapping.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">OrderedDict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cond_to_policy_map must be a dict or OrderedDict&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Validate and convert condition-to-policy mapping.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.branching_policy.BranchingPolicy.validate_default_policy" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.branching_policy.BranchingPolicy.validate_default_policy" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_default_policy</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/branching_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;default_policy&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_default_policy</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate default policy field.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Validate default policy field.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.client_api_key_auth" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>client_api_key_auth</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.client_api_key_auth.ClientApiKeyAuthPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.client_api_key_auth.ClientApiKeyAuthPolicy" class="doc-anchor"><code>ClientApiKeyAuthPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/client_api_key_auth.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ClientApiKeyAuthPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verifies the client API key from the transaction&#39;s request.</span>

<span class="sd">    This policy authenticates clients by checking their API key against</span>
<span class="sd">    the database. It ensures the key exists and is active.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): The name of this policy instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;ClientApiKeyAuthPolicy&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Verifies the API key from the transaction&#39;s request.</span>
<span class="sd">        Requires the DependencyContainer and an active SQLAlchemy AsyncSession.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NoRequestError: If transaction.request is None.</span>
<span class="sd">            ClientAuthenticationError: If the key is missing, invalid, or inactive.</span>

<span class="sd">        Args:</span>
<span class="sd">            transaction: The current transaction.</span>
<span class="sd">            container: The application dependency container.</span>
<span class="sd">            session: An active SQLAlchemy AsyncSession.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The unmodified transaction if authentication is successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoRequestError</span><span class="p">(</span><span class="s2">&quot;No request in transaction for API key auth.&quot;</span><span class="p">)</span>

        <span class="n">api_key_value</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Missing API key in transaction request.&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ClientAuthenticationNotFoundError</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not authenticated: Missing API key.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">db_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_api_key_by_value</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">api_key_value</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">LuthienDBQueryError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid API key provided (key starts with: </span><span class="si">{</span><span class="n">api_key_value</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">...) (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ClientAuthenticationError</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid API Key&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">db_key</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Inactive API key provided (Name: </span><span class="si">{</span><span class="n">db_key</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, ID: </span><span class="si">{</span><span class="n">db_key</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">). (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ClientAuthenticationError</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive API Key&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Client API key authenticated successfully &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;(Name: </span><span class="si">{</span><span class="n">db_key</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, ID: </span><span class="si">{</span><span class="n">db_key</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">). (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Verifies the client API key from the transaction's request.</p>
<p>This policy authenticates clients by checking their API key against
the database. It ensures the key exists and is active.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.client_api_key_auth.ClientApiKeyAuthPolicy.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of this policy instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.client_api_key_auth.ClientApiKeyAuthPolicy.apply" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.client_api_key_auth.ClientApiKeyAuthPolicy.apply" class="doc-anchor"><code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/client_api_key_auth.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Verifies the API key from the transaction&#39;s request.</span>
<span class="sd">    Requires the DependencyContainer and an active SQLAlchemy AsyncSession.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NoRequestError: If transaction.request is None.</span>
<span class="sd">        ClientAuthenticationError: If the key is missing, invalid, or inactive.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The current transaction.</span>
<span class="sd">        container: The application dependency container.</span>
<span class="sd">        session: An active SQLAlchemy AsyncSession.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The unmodified transaction if authentication is successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoRequestError</span><span class="p">(</span><span class="s2">&quot;No request in transaction for API key auth.&quot;</span><span class="p">)</span>

    <span class="n">api_key_value</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key_value</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Missing API key in transaction request.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ClientAuthenticationNotFoundError</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Not authenticated: Missing API key.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">db_key</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_api_key_by_value</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">api_key_value</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LuthienDBQueryError</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid API key provided (key starts with: </span><span class="si">{</span><span class="n">api_key_value</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">...) (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">ClientAuthenticationError</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Invalid API Key&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">db_key</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Inactive API key provided (Name: </span><span class="si">{</span><span class="n">db_key</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, ID: </span><span class="si">{</span><span class="n">db_key</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">). (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">ClientAuthenticationError</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Inactive API Key&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Client API key authenticated successfully &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;(Name: </span><span class="si">{</span><span class="n">db_key</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, ID: </span><span class="si">{</span><span class="n">db_key</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">). (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">).&quot;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Verifies the API key from the transaction's request.
Requires the DependencyContainer and an active SQLAlchemy AsyncSession.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    NoRequestError" href="#luthien_control.control_policy.exceptions.NoRequestError">NoRequestError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If transaction.request is None.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ClientAuthenticationError" href="#luthien_control.control_policy.exceptions.ClientAuthenticationError">ClientAuthenticationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the key is missing, invalid, or inactive.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current transaction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The application dependency container.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An active SQLAlchemy AsyncSession.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The unmodified transaction if authentication is successful.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.conditions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>conditions</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.AllCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.AllCondition" class="doc-anchor"><code>AllCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    Condition" href="#luthien_control.control_policy.conditions.condition.Condition">Condition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/all_cond.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AllCondition</span><span class="p">(</span><span class="n">Condition</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom serializer for conditions field.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">condition</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_conditions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize conditions from dicts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Condition</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>










  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.AllCondition.serialize_conditions" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.AllCondition.serialize_conditions" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize_conditions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/all_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">serialize_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom serializer for conditions field.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">condition</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom serializer for conditions field.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.AllCondition.validate_conditions" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.AllCondition.validate_conditions" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_conditions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/all_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_conditions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize conditions from dicts.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Condition</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom validator to deserialize conditions from dicts.</p>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.AnyCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.AnyCondition" class="doc-anchor"><code>AnyCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    Condition" href="#luthien_control.control_policy.conditions.condition.Condition">Condition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/any_cond.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AnyCondition</span><span class="p">(</span><span class="n">Condition</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;any&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;any&quot;</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom serializer for conditions field.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">condition</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_conditions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize conditions from dicts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Condition</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>










  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.AnyCondition.serialize_conditions" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.AnyCondition.serialize_conditions" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize_conditions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/any_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">serialize_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom serializer for conditions field.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">condition</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom serializer for conditions field.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.AnyCondition.validate_conditions" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.AnyCondition.validate_conditions" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_conditions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/any_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_conditions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize conditions from dicts.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Condition</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom validator to deserialize conditions from dicts.</p>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.Condition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.Condition" class="doc-anchor"><code>Condition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code>, <code><span title="abc.ABC">ABC</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/condition.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Condition</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for conditions in control policies.</span>

<span class="sd">    Conditions are used to evaluate whether a policy should be applied based on</span>
<span class="sd">    the current transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Allow any string type including Literal types</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize using Pydantic model_dump through SerializableDict validation.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">safe_model_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Condition&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a condition from a serialized configuration.</span>

<span class="sd">        This method acts as a dispatcher. It looks up the concrete condition class</span>
<span class="sd">        based on the &#39;type&#39; field in the config and delegates to its from_serialized method.</span>

<span class="sd">        Args:</span>
<span class="sd">            serialized: The condition-specific configuration dictionary. It must contain</span>
<span class="sd">                        a &#39;type&#39; key that maps to a registered condition type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An instance of the concrete condition class.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the &#39;type&#39; key is missing in config or the type is not registered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Moved import inside the method to break circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.conditions.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">NAME_TO_CONDITION_CLASS</span>

        <span class="n">condition_type_name_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span>

        <span class="n">target_condition_class</span> <span class="o">=</span> <span class="n">NAME_TO_CONDITION_CLASS</span><span class="p">[</span><span class="n">condition_type_name_val</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">safe_model_validate</span><span class="p">(</span><span class="n">target_condition_class</span><span class="p">,</span> <span class="n">serialized</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Abstract base class for conditions in control policies.</p>
<p>Conditions are used to evaluate whether a policy should be applied based on
the current transaction.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.Condition.from_serialized" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.Condition.from_serialized" class="doc-anchor"><code class="highlight language-python"><span class="n">from_serialized</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/condition.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Condition&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a condition from a serialized configuration.</span>

<span class="sd">    This method acts as a dispatcher. It looks up the concrete condition class</span>
<span class="sd">    based on the &#39;type&#39; field in the config and delegates to its from_serialized method.</span>

<span class="sd">    Args:</span>
<span class="sd">        serialized: The condition-specific configuration dictionary. It must contain</span>
<span class="sd">                    a &#39;type&#39; key that maps to a registered condition type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An instance of the concrete condition class.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the &#39;type&#39; key is missing in config or the type is not registered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Moved import inside the method to break circular dependency</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.conditions.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">NAME_TO_CONDITION_CLASS</span>

    <span class="n">condition_type_name_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span>

    <span class="n">target_condition_class</span> <span class="o">=</span> <span class="n">NAME_TO_CONDITION_CLASS</span><span class="p">[</span><span class="n">condition_type_name_val</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">safe_model_validate</span><span class="p">(</span><span class="n">target_condition_class</span><span class="p">,</span> <span class="n">serialized</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Construct a condition from a serialized configuration.</p>
<p>This method acts as a dispatcher. It looks up the concrete condition class
based on the 'type' field in the config and delegates to its from_serialized method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>serialized</code>
            </td>
            <td>
                  <code><span title="luthien_control.control_policy.serialization.SerializableDict">SerializableDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The condition-specific configuration dictionary. It must contain
        a 'type' key that maps to a registered condition type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Condition" href="#luthien_control.control_policy.conditions.condition.Condition">Condition</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the concrete condition class.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the 'type' key is missing in config or the type is not registered.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.Condition.serialize" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.Condition.serialize" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize</span><span class="p">()</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/condition.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serialize using Pydantic model_dump through SerializableDict validation.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_model_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Serialize using Pydantic model_dump through SerializableDict validation.</p>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.ContainsCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.ContainsCondition" class="doc-anchor"><code>ContainsCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ContainsCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value contains the right value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;contains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">contains</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value contains the right value.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.EqualsCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.EqualsCondition" class="doc-anchor"><code>EqualsCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EqualsCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if two values are equal.</span>

<span class="sd">    Examples:</span>
<span class="sd">        # Traditional</span>
<span class="sd">        EqualsCondition(path(&quot;request.payload.model&quot;), &quot;gpt-4o&quot;)</span>

<span class="sd">        # Dynamic</span>
<span class="sd">        EqualsCondition(path(&quot;request.payload.model&quot;), path(&quot;data.preferred_model&quot;))</span>

<span class="sd">        # Static vs dynamic</span>
<span class="sd">        EqualsCondition(&quot;gpt-4o&quot;, path(&quot;request.payload.model&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;equals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;equals&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">equals</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if two values are equal.</p>


<p><span class="doc-section-title">Examples:</span></p>
    <h5 id="luthien_control.control_policy.conditions.EqualsCondition--traditional">Traditional</h5>
<p>EqualsCondition(path("request.payload.model"), "gpt-4o")</p>
<h5 id="luthien_control.control_policy.conditions.EqualsCondition--dynamic">Dynamic</h5>
<p>EqualsCondition(path("request.payload.model"), path("data.preferred_model"))</p>
<h5 id="luthien_control.control_policy.conditions.EqualsCondition--static-vs-dynamic">Static vs dynamic</h5>
<p>EqualsCondition("gpt-4o", path("request.payload.model"))</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.GreaterThanCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.GreaterThanCondition" class="doc-anchor"><code>GreaterThanCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GreaterThanCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value is greater than the right value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;greater_than&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;greater_than&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">greater_than</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value is greater than the right value.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.GreaterThanOrEqualCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.GreaterThanOrEqualCondition" class="doc-anchor"><code>GreaterThanOrEqualCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GreaterThanOrEqualCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value is greater than or equal to the right value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;greater_than_or_equal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;greater_than_or_equal&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">greater_than_or_equal</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value is greater than or equal to the right value.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.LessThanCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.LessThanCondition" class="doc-anchor"><code>LessThanCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LessThanCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value is less than the right value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;less_than&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;less_than&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">less_than</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value is less than the right value.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.LessThanOrEqualCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.LessThanOrEqualCondition" class="doc-anchor"><code>LessThanOrEqualCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LessThanOrEqualCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value is less than or equal to the right value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;less_than_or_equal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;less_than_or_equal&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">less_than_or_equal</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value is less than or equal to the right value.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.NotCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.NotCondition" class="doc-anchor"><code>NotCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    Condition" href="#luthien_control.control_policy.conditions.condition.Condition">Condition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/not_cond.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NotCondition</span><span class="p">(</span><span class="n">Condition</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;not&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span>
    <span class="n">cond</span><span class="p">:</span> <span class="n">Condition</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;cond&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Condition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom serializer for cond field.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;cond&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_cond</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize condition from dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(value=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="si">!r}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>










  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.NotCondition.serialize_cond" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.NotCondition.serialize_cond" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize_cond</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/not_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;cond&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">serialize_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Condition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom serializer for cond field.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom serializer for cond field.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.NotCondition.validate_cond" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.NotCondition.validate_cond" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_cond</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/not_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;cond&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_cond</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize condition from dict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom validator to deserialize condition from dict.</p>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.NotEqualsCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.NotEqualsCondition" class="doc-anchor"><code>NotEqualsCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NotEqualsCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if two values are NOT equal.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;not_equals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;not_equals&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">not_equals</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if two values are NOT equal.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.conditions.RegexMatchCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.RegexMatchCondition" class="doc-anchor"><code>RegexMatchCondition</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RegexMatchCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value matches a regex pattern.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;regex_match&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;regex_match&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">regex_match</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value matches a regex pattern.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>
  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.control_policy.conditions.path" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.control_policy.conditions.path" class="doc-anchor"><code class="highlight language-python"><span class="n">path</span><span class="p">(</span><span class="n">transaction_path</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">path</span><span class="p">(</span><span class="n">transaction_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionPath</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function to create a TransactionPath.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction_path: The path to the value in the transaction</span>

<span class="sd">    Returns:</span>
<span class="sd">        A TransactionPath instance</span>

<span class="sd">    Example:</span>
<span class="sd">        path(&quot;request.payload.model&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">TransactionPath</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">transaction_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Convenience function to create a TransactionPath.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the value in the transaction</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    TransactionPath" href="#luthien_control.control_policy.conditions.value_resolvers.TransactionPath">TransactionPath</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A TransactionPath instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>path("request.payload.model")</p>
</details>

    </div>

</div>


<div class="doc doc-object doc-module">



<h4 id="luthien_control.control_policy.conditions.all_cond" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>all_cond</code>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.all_cond.AllCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.all_cond.AllCondition" class="doc-anchor"><code>AllCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    Condition" href="#luthien_control.control_policy.conditions.condition.Condition">Condition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/all_cond.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AllCondition</span><span class="p">(</span><span class="n">Condition</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom serializer for conditions field.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">condition</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_conditions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize conditions from dicts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Condition</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>










  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.all_cond.AllCondition.serialize_conditions" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.all_cond.AllCondition.serialize_conditions" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize_conditions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/all_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">serialize_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom serializer for conditions field.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">condition</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom serializer for conditions field.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.all_cond.AllCondition.validate_conditions" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.all_cond.AllCondition.validate_conditions" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_conditions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/all_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_conditions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize conditions from dicts.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Condition</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom validator to deserialize conditions from dicts.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="luthien_control.control_policy.conditions.any_cond" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>any_cond</code>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.any_cond.AnyCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.any_cond.AnyCondition" class="doc-anchor"><code>AnyCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    Condition" href="#luthien_control.control_policy.conditions.condition.Condition">Condition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/any_cond.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AnyCondition</span><span class="p">(</span><span class="n">Condition</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;any&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;any&quot;</span>
    <span class="n">conditions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom serializer for conditions field.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">condition</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_conditions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize conditions from dicts.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Condition</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">condition</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conditions</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>










  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.any_cond.AnyCondition.serialize_conditions" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.any_cond.AnyCondition.serialize_conditions" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize_conditions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/any_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">serialize_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Condition</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom serializer for conditions field.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">condition</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="k">for</span> <span class="n">condition</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom serializer for conditions field.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.any_cond.AnyCondition.validate_conditions" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.any_cond.AnyCondition.validate_conditions" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_conditions</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/any_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;conditions&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_conditions</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize conditions from dicts.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Condition</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom validator to deserialize conditions from dicts.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="luthien_control.control_policy.conditions.comparison_conditions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>comparison_conditions</code>


</h4>

    <div class="doc doc-contents ">

        <p>Comparison conditions for control policies.</p>
<p>This module implements comparison-based conditions (equals, contains, greater than, etc.)
using a clean ValueResolver pattern for flexible value resolution.</p>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions--pyright-type-checker-suppression">Pyright Type Checker Suppression</h6>
<p>The <code># pyright: reportCallIssue=false</code> comment at the top of this file suppresses type
checker warnings for positional argument usage in comparison condition constructors.</p>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions--why-this-is-necessary">Why This Is Necessary</h6>
<p>All comparison conditions inherit from Pydantic's BaseModel, which enforces keyword-only
constructors. However, we provide a more natural API with positional arguments:</p>
<pre><code class="language-python"># Natural, concise syntax (what we want)
EqualsCondition(path(&quot;request.payload.model&quot;), &quot;gpt-4o&quot;)

# Verbose but type-safe (what Pydantic expects)
EqualsCondition(left=path(&quot;request.payload.model&quot;), right=&quot;gpt-4o&quot;)
</code></pre>
<p>Our custom <code>__init__</code> methods handle both patterns correctly at runtime, but static
analysis tools like pyright cannot see through the Pydantic inheritance to understand
this flexibility.</p>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions--safety-considerations">Safety Considerations</h6>
<p>This suppression is safe because:
1. We only suppress <code>reportCallIssue</code> (constructor signature mismatches)
2. Our overload definitions provide proper type hints
3. Runtime behavior is thoroughly tested
4. Other type checking (return types, field access, etc.) remains active</p>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions--for-users-of-this-module">For Users of This Module</h6>
<p>When using these comparison conditions in your code, you may encounter pyright warnings.
See the <code>ComparisonCondition</code> class documentation for guidance on suppressing these
warnings appropriately in your own files.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition" class="doc-anchor"><code>ComparisonCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    Condition" href="#luthien_control.control_policy.conditions.condition.Condition">Condition</a></code>, <code><span title="abc.ABC">ABC</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ComparisonCondition</span><span class="p">(</span><span class="n">Condition</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clean comparison condition that uses ValueResolver objects for flexible value resolution.</span>

<span class="sd">    This approach eliminates the need for is_dynamic_* flags by using explicit types.</span>

<span class="sd">    ## Constructor Usage</span>

<span class="sd">    This class supports both positional and keyword argument patterns:</span>

<span class="sd">    ### Positional Arguments (Recommended for brevity)</span>
<span class="sd">    ```python</span>
<span class="sd">    EqualsCondition(path(&quot;request.payload.model&quot;), &quot;gpt-4o&quot;)</span>
<span class="sd">    EqualsCondition(path(&quot;left_path&quot;), path(&quot;right_path&quot;))  # Dynamic comparison</span>
<span class="sd">    EqualsCondition(&quot;static_left&quot;, &quot;static_right&quot;)          # Static comparison</span>
<span class="sd">    ```</span>

<span class="sd">    ### Keyword Arguments (Explicit, type-safe)</span>
<span class="sd">    ```python</span>
<span class="sd">    EqualsCondition(left=path(&quot;request.payload.model&quot;), right=&quot;gpt-4o&quot;)</span>
<span class="sd">    EqualsCondition(left=path(&quot;left_path&quot;), right=path(&quot;right_path&quot;))</span>
<span class="sd">    ```</span>

<span class="sd">    ## Pyright Type Checker Warning</span>

<span class="sd">    **Important**: When using positional arguments, pyright may show this error:</span>
<span class="sd">    ```</span>
<span class="sd">    Expected 0 positional arguments (reportCallIssue)</span>
<span class="sd">    ```</span>

<span class="sd">    This is a known issue due to the underlying Pydantic BaseModel inheritance. The code</span>
<span class="sd">    works correctly at runtime, but pyright&#39;s static analysis doesn&#39;t recognize our</span>
<span class="sd">    custom `__init__` override.</span>

<span class="sd">    ### How to Suppress the Warning</span>

<span class="sd">    Add this comment to suppress the specific error on individual calls:</span>
<span class="sd">    ```python</span>
<span class="sd">    condition = EqualsCondition(path(&quot;test&quot;), &quot;value&quot;)  # pyright: ignore[reportCallIssue]</span>
<span class="sd">    ```</span>

<span class="sd">    Or add this at the top of your file to suppress all such errors in that file:</span>
<span class="sd">    ```python</span>
<span class="sd">    # pyright: reportCallIssue=false</span>
<span class="sd">    ```</span>

<span class="sd">    ### When to Use Each Approach</span>

<span class="sd">    - **Use positional**: For concise, readable condition creation in tests and simple cases</span>
<span class="sd">    - **Use keywords**: When you need full type safety or when working in strict typing environments</span>
<span class="sd">    - **Suppress warnings**: When you prefer the positional syntax and understand the trade-off</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">comparator</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Comparator</span><span class="p">]</span>

    <span class="n">left</span><span class="p">:</span> <span class="n">ValueResolver</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">ValueResolver</span>
    <span class="n">comparator_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="s2">&quot;comparator&quot;</span><span class="p">)</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ValueResolver</span><span class="p">],</span> <span class="n">right</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ValueResolver</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="nd">@overload</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="n">ValueResolver</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">ValueResolver</span><span class="p">,</span> <span class="n">comparator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">left</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ValueResolver</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">right</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ValueResolver</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="c1"># Pydantic keyword-only arguments</span>
        <span class="n">comparator</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize with both positional and keyword argument support.&quot;&quot;&quot;</span>
        <span class="c1"># Handle positional arguments</span>
        <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auto_resolve_value</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auto_resolve_value</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">comparator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COMPARATOR_TO_NAME</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">comparator</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comparator</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_value_resolver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">ValueResolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom serializer for ValueResolver fields.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_value_resolver</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">StaticValue</span> <span class="o">|</span> <span class="n">ValueResolver</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize ValueResolver from dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StaticValue</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">create_value_resolver</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">auto_resolve_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate the condition against the transaction.&quot;&quot;&quot;</span>
        <span class="n">left_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="n">right_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">left_value</span><span class="p">,</span> <span class="n">right_value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="si">!r}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="si">!r}</span><span class="s2">)&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_legacy_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ComparisonCondition&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a condition from legacy ComparisonCondition format.</span>

<span class="sd">        Args:</span>
<span class="sd">            key: Transaction path (e.g., &quot;request.payload.model&quot;)</span>
<span class="sd">            value: Static value to compare against</span>

<span class="sd">        Returns:</span>
<span class="sd">            A ComparisonCondition instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">path</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Clean comparison condition that uses ValueResolver objects for flexible value resolution.</p>
<p>This approach eliminates the need for is_dynamic_* flags by using explicit types.</p>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--constructor-usage">Constructor Usage</h6>
<p>This class supports both positional and keyword argument patterns:</p>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--positional-arguments-recommended-for-brevity">Positional Arguments (Recommended for brevity)</h6>
<pre><code class="language-python">EqualsCondition(path(&quot;request.payload.model&quot;), &quot;gpt-4o&quot;)
EqualsCondition(path(&quot;left_path&quot;), path(&quot;right_path&quot;))  # Dynamic comparison
EqualsCondition(&quot;static_left&quot;, &quot;static_right&quot;)          # Static comparison
</code></pre>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--keyword-arguments-explicit-type-safe">Keyword Arguments (Explicit, type-safe)</h6>
<pre><code class="language-python">EqualsCondition(left=path(&quot;request.payload.model&quot;), right=&quot;gpt-4o&quot;)
EqualsCondition(left=path(&quot;left_path&quot;), right=path(&quot;right_path&quot;))
</code></pre>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--pyright-type-checker-warning">Pyright Type Checker Warning</h6>
<p><strong>Important</strong>: When using positional arguments, pyright may show this error:</p>
<pre><code>Expected 0 positional arguments (reportCallIssue)
</code></pre>
<p>This is a known issue due to the underlying Pydantic BaseModel inheritance. The code
works correctly at runtime, but pyright's static analysis doesn't recognize our
custom <code>__init__</code> override.</p>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--how-to-suppress-the-warning">How to Suppress the Warning</h6>
<p>Add this comment to suppress the specific error on individual calls:</p>
<pre><code class="language-python">condition = EqualsCondition(path(&quot;test&quot;), &quot;value&quot;)  # pyright: ignore[reportCallIssue]
</code></pre>
<p>Or add this at the top of your file to suppress all such errors in that file:</p>
<pre><code class="language-python"># pyright: reportCallIssue=false
</code></pre>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition--when-to-use-each-approach">When to Use Each Approach</h6>
<ul>
<li><strong>Use positional</strong>: For concise, readable condition creation in tests and simple cases</li>
<li><strong>Use keywords</strong>: When you need full type safety or when working in strict typing environments</li>
<li><strong>Suppress warnings</strong>: When you prefer the positional syntax and understand the trade-off</li>
</ul>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">comparator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code></a>


</h6>
          <div class="doc-overloads">
<div class="doc-signature highlight"><pre><span></span><code><span class="fm">__init__</span><span class="p">(</span>
    <span class="nf">left</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ValueResolver</span><span class="p">],</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ValueResolver</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div><div class="doc-signature highlight"><pre><span></span><code><span class="fm">__init__</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="nf">left</span><span class="p">:</span> <span class="n">ValueResolver</span><span class="p">,</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">ValueResolver</span><span class="p">,</span>
    <span class="n">comparator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span>
</code></pre></div>          </div>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ValueResolver</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">right</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">ValueResolver</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="c1"># Pydantic keyword-only arguments</span>
    <span class="n">comparator</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize with both positional and keyword argument support.&quot;&quot;&quot;</span>
    <span class="c1"># Handle positional arguments</span>
    <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">right</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auto_resolve_value</span><span class="p">(</span><span class="n">left</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">auto_resolve_value</span><span class="p">(</span><span class="n">right</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comparator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">COMPARATOR_TO_NAME</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">comparator</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;comparator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comparator</span>

    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initialize with both positional and keyword argument support.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.evaluate" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.evaluate" class="doc-anchor"><code class="highlight language-python"><span class="n">evaluate</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate the condition against the transaction.&quot;&quot;&quot;</span>
    <span class="n">left_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">left</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
    <span class="n">right_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">right</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">comparator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">left_value</span><span class="p">,</span> <span class="n">right_value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Evaluate the condition against the transaction.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.from_legacy_format" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.from_legacy_format" class="doc-anchor"><code class="highlight language-python"><span class="n">from_legacy_format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_legacy_format</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ComparisonCondition&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a condition from legacy ComparisonCondition format.</span>

<span class="sd">    Args:</span>
<span class="sd">        key: Transaction path (e.g., &quot;request.payload.model&quot;)</span>
<span class="sd">        value: Static value to compare against</span>

<span class="sd">    Returns:</span>
<span class="sd">        A ComparisonCondition instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">path</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create a condition from legacy ComparisonCondition format.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Transaction path (e.g., "request.payload.model")</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Static value to compare against</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A ComparisonCondition instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.serialize_value_resolver" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.serialize_value_resolver" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize_value_resolver</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">serialize_value_resolver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">ValueResolver</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom serializer for ValueResolver fields.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom serializer for ValueResolver fields.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.validate_value_resolver" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition.validate_value_resolver" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_value_resolver</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_value_resolver</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">StaticValue</span> <span class="o">|</span> <span class="n">ValueResolver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize ValueResolver from dict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">StaticValue</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;type&quot;</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">create_value_resolver</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">auto_resolve_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom validator to deserialize ValueResolver from dict.</p>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.comparison_conditions.ContainsCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.ContainsCondition" class="doc-anchor"><code>ContainsCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ContainsCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value contains the right value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;contains&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;contains&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">contains</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value contains the right value.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.comparison_conditions.EqualsCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.EqualsCondition" class="doc-anchor"><code>EqualsCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EqualsCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if two values are equal.</span>

<span class="sd">    Examples:</span>
<span class="sd">        # Traditional</span>
<span class="sd">        EqualsCondition(path(&quot;request.payload.model&quot;), &quot;gpt-4o&quot;)</span>

<span class="sd">        # Dynamic</span>
<span class="sd">        EqualsCondition(path(&quot;request.payload.model&quot;), path(&quot;data.preferred_model&quot;))</span>

<span class="sd">        # Static vs dynamic</span>
<span class="sd">        EqualsCondition(&quot;gpt-4o&quot;, path(&quot;request.payload.model&quot;))</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;equals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;equals&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">equals</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if two values are equal.</p>


<p><span class="doc-section-title">Examples:</span></p>
    <h6 id="luthien_control.control_policy.conditions.comparison_conditions.EqualsCondition--traditional">Traditional</h6>
<p>EqualsCondition(path("request.payload.model"), "gpt-4o")</p>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions.EqualsCondition--dynamic">Dynamic</h6>
<p>EqualsCondition(path("request.payload.model"), path("data.preferred_model"))</p>
<h6 id="luthien_control.control_policy.conditions.comparison_conditions.EqualsCondition--static-vs-dynamic">Static vs dynamic</h6>
<p>EqualsCondition("gpt-4o", path("request.payload.model"))</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.comparison_conditions.GreaterThanCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.GreaterThanCondition" class="doc-anchor"><code>GreaterThanCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GreaterThanCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value is greater than the right value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;greater_than&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;greater_than&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">greater_than</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value is greater than the right value.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.comparison_conditions.GreaterThanOrEqualCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.GreaterThanOrEqualCondition" class="doc-anchor"><code>GreaterThanOrEqualCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GreaterThanOrEqualCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value is greater than or equal to the right value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;greater_than_or_equal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;greater_than_or_equal&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">greater_than_or_equal</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value is greater than or equal to the right value.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.comparison_conditions.LessThanCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.LessThanCondition" class="doc-anchor"><code>LessThanCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LessThanCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value is less than the right value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;less_than&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;less_than&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">less_than</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value is less than the right value.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.comparison_conditions.LessThanOrEqualCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.LessThanOrEqualCondition" class="doc-anchor"><code>LessThanOrEqualCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LessThanOrEqualCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value is less than or equal to the right value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;less_than_or_equal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;less_than_or_equal&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">less_than_or_equal</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value is less than or equal to the right value.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.comparison_conditions.NotEqualsCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.NotEqualsCondition" class="doc-anchor"><code>NotEqualsCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NotEqualsCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if two values are NOT equal.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;not_equals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;not_equals&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">not_equals</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if two values are NOT equal.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.comparison_conditions.RegexMatchCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.comparison_conditions.RegexMatchCondition" class="doc-anchor"><code>RegexMatchCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ComparisonCondition" href="#luthien_control.control_policy.conditions.comparison_conditions.ComparisonCondition">ComparisonCondition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/comparison_conditions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RegexMatchCondition</span><span class="p">(</span><span class="n">ComparisonCondition</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Condition to check if the left value matches a regex pattern.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;regex_match&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;regex_match&quot;</span><span class="p">)</span>
    <span class="n">comparator</span> <span class="o">=</span> <span class="n">regex_match</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Condition to check if the left value matches a regex pattern.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="luthien_control.control_policy.conditions.condition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>condition</code>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.condition.Condition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.condition.Condition" class="doc-anchor"><code>Condition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code>, <code><span title="abc.ABC">ABC</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/condition.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Condition</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for conditions in control policies.</span>

<span class="sd">    Conditions are used to evaluate whether a policy should be applied based on</span>
<span class="sd">    the current transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Any</span>  <span class="c1"># Allow any string type including Literal types</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize using Pydantic model_dump through SerializableDict validation.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">safe_model_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Condition&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a condition from a serialized configuration.</span>

<span class="sd">        This method acts as a dispatcher. It looks up the concrete condition class</span>
<span class="sd">        based on the &#39;type&#39; field in the config and delegates to its from_serialized method.</span>

<span class="sd">        Args:</span>
<span class="sd">            serialized: The condition-specific configuration dictionary. It must contain</span>
<span class="sd">                        a &#39;type&#39; key that maps to a registered condition type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An instance of the concrete condition class.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the &#39;type&#39; key is missing in config or the type is not registered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Moved import inside the method to break circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.conditions.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">NAME_TO_CONDITION_CLASS</span>

        <span class="n">condition_type_name_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span>

        <span class="n">target_condition_class</span> <span class="o">=</span> <span class="n">NAME_TO_CONDITION_CLASS</span><span class="p">[</span><span class="n">condition_type_name_val</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">safe_model_validate</span><span class="p">(</span><span class="n">target_condition_class</span><span class="p">,</span> <span class="n">serialized</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Abstract base class for conditions in control policies.</p>
<p>Conditions are used to evaluate whether a policy should be applied based on
the current transaction.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.condition.Condition.from_serialized" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.condition.Condition.from_serialized" class="doc-anchor"><code class="highlight language-python"><span class="n">from_serialized</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/condition.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Condition&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Construct a condition from a serialized configuration.</span>

<span class="sd">    This method acts as a dispatcher. It looks up the concrete condition class</span>
<span class="sd">    based on the &#39;type&#39; field in the config and delegates to its from_serialized method.</span>

<span class="sd">    Args:</span>
<span class="sd">        serialized: The condition-specific configuration dictionary. It must contain</span>
<span class="sd">                    a &#39;type&#39; key that maps to a registered condition type.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An instance of the concrete condition class.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the &#39;type&#39; key is missing in config or the type is not registered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Moved import inside the method to break circular dependency</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.conditions.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">NAME_TO_CONDITION_CLASS</span>

    <span class="n">condition_type_name_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">))</span>

    <span class="n">target_condition_class</span> <span class="o">=</span> <span class="n">NAME_TO_CONDITION_CLASS</span><span class="p">[</span><span class="n">condition_type_name_val</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">safe_model_validate</span><span class="p">(</span><span class="n">target_condition_class</span><span class="p">,</span> <span class="n">serialized</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Construct a condition from a serialized configuration.</p>
<p>This method acts as a dispatcher. It looks up the concrete condition class
based on the 'type' field in the config and delegates to its from_serialized method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>serialized</code>
            </td>
            <td>
                  <code><span title="luthien_control.control_policy.serialization.SerializableDict">SerializableDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The condition-specific configuration dictionary. It must contain
        a 'type' key that maps to a registered condition type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Condition" href="#luthien_control.control_policy.conditions.condition.Condition">Condition</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the concrete condition class.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the 'type' key is missing in config or the type is not registered.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.condition.Condition.serialize" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.condition.Condition.serialize" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize</span><span class="p">()</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/condition.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serialize using Pydantic model_dump through SerializableDict validation.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">safe_model_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
    <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Serialize using Pydantic model_dump through SerializableDict validation.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="luthien_control.control_policy.conditions.not_cond" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>not_cond</code>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.not_cond.NotCondition" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.not_cond.NotCondition" class="doc-anchor"><code>NotCondition</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    Condition" href="#luthien_control.control_policy.conditions.condition.Condition">Condition</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/not_cond.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NotCondition</span><span class="p">(</span><span class="n">Condition</span><span class="p">):</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;not&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;not&quot;</span>
    <span class="n">cond</span><span class="p">:</span> <span class="n">Condition</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;cond&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">serialize_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Condition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom serializer for cond field.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;cond&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_cond</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize condition from dict.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">(value=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cond</span><span class="si">!r}</span><span class="s2">)&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>










  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.not_cond.NotCondition.serialize_cond" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.not_cond.NotCondition.serialize_cond" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize_cond</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/not_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_serializer</span><span class="p">(</span><span class="s2">&quot;cond&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">serialize_cond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Condition</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom serializer for cond field.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom serializer for cond field.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.not_cond.NotCondition.validate_cond" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.not_cond.NotCondition.validate_cond" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_cond</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/not_cond.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;cond&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_cond</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom validator to deserialize condition from dict.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Condition</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Custom validator to deserialize condition from dict.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="luthien_control.control_policy.conditions.util" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>util</code>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.util.get_transaction_value" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.control_policy.conditions.util.get_transaction_value" class="doc-anchor"><code class="highlight language-python"><span class="n">get_transaction_value</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/util.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_transaction_value</span><span class="p">(</span><span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a value from the transaction using a path.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The transaction.</span>
<span class="sd">        path: The path to the value e.g. &quot;request.payload.model&quot;, &quot;response.payload.choices&quot;, &quot;data.user_id&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The value at the path.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the path is invalid or the value cannot be accessed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Path must contain at least two components&quot;</span><span class="p">)</span>

    <span class="n">x</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">vals</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Try dict-like access first (includes EventedDict)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;__getitem__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;keys&quot;</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="c1"># Try attribute access</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Try accessing as index for list-like objects</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot access &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; on </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a value from the transaction using a path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The transaction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the value e.g. "request.payload.model", "response.payload.choices", "data.user_id".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value at the path.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path is invalid or the value cannot be accessed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="luthien_control.control_policy.conditions.value_resolvers" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>value_resolvers</code>


</h4>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.value_resolvers.StaticValue" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.StaticValue" class="doc-anchor"><code>StaticValue</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ValueResolver" href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver">ValueResolver</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">StaticValue</span><span class="p">(</span><span class="n">ValueResolver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A static value that doesn&#39;t depend on the transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;static&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;static&quot;</span><span class="p">)</span>
    <span class="n">value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the static value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;StaticValue(value=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">!r}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check equality with another StaticValue.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">StaticValue</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A static value that doesn't depend on the transaction.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.value_resolvers.StaticValue.__eq__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.StaticValue.__eq__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check equality with another StaticValue.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">StaticValue</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Check equality with another StaticValue.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.value_resolvers.StaticValue.resolve" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.StaticValue.resolve" class="doc-anchor"><code class="highlight language-python"><span class="n">resolve</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the static value.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Return the static value.</p>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.value_resolvers.TransactionPath" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.TransactionPath" class="doc-anchor"><code>TransactionPath</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ValueResolver" href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver">ValueResolver</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TransactionPath</span><span class="p">(</span><span class="n">ValueResolver</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A value resolver that extracts a value from a transaction using a path.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;transaction_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;transaction_path&quot;</span><span class="p">)</span>
    <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resolve the value from the transaction using the path.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_transaction_value</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;TransactionPath(path=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="si">!r}</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check equality with another TransactionPath.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TransactionPath</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">path</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A value resolver that extracts a value from a transaction using a path.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.value_resolvers.TransactionPath.__eq__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.TransactionPath.__eq__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check equality with another TransactionPath.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">TransactionPath</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">path</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Check equality with another TransactionPath.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.value_resolvers.TransactionPath.resolve" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.TransactionPath.resolve" class="doc-anchor"><code class="highlight language-python"><span class="n">resolve</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Resolve the value from the transaction using the path.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_transaction_value</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Resolve the value from the transaction using the path.</p>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.control_policy.conditions.value_resolvers.ValueResolver" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver" class="doc-anchor"><code>ValueResolver</code></a>


</h5>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code>, <code><span title="abc.ABC">ABC</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ValueResolver</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract base class for resolving values from transactions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>  <span class="c1"># Allow any string type including Literal types</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Resolve and return a value from the transaction.</span>

<span class="sd">        Args:</span>
<span class="sd">            transaction: The transaction to resolve the value from</span>

<span class="sd">        Returns:</span>
<span class="sd">            The resolved value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize using Pydantic model_dump through SerializableDict validation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">safe_model_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ValueResolver&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a value resolver from a serialized dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            serialized: The serialized representation</span>

<span class="sd">        Returns:</span>
<span class="sd">            A ValueResolver instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">safe_model_validate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">)</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Abstract base class for resolving values from transactions.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.value_resolvers.ValueResolver.from_serialized" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver.from_serialized" class="doc-anchor"><code class="highlight language-python"><span class="n">from_serialized</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ValueResolver&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a value resolver from a serialized dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        serialized: The serialized representation</span>

<span class="sd">    Returns:</span>
<span class="sd">        A ValueResolver instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">safe_model_validate</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">serialized</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create a value resolver from a serialized dictionary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>serialized</code>
            </td>
            <td>
                  <code><span title="luthien_control.control_policy.serialization.SerializableDict">SerializableDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The serialized representation</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ValueResolver" href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver">ValueResolver</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A ValueResolver instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.value_resolvers.ValueResolver.resolve" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver.resolve" class="doc-anchor"><code class="highlight language-python"><span class="n">resolve</span><span class="p">(</span><span class="n">transaction</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Resolve and return a value from the transaction.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The transaction to resolve the value from</span>

<span class="sd">    Returns:</span>
<span class="sd">        The resolved value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Resolve and return a value from the transaction.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The transaction to resolve the value from</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The resolved value</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.control_policy.conditions.value_resolvers.ValueResolver.serialize" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver.serialize" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize</span><span class="p">()</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serialize using Pydantic model_dump through SerializableDict validation.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">safe_model_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Serialize using Pydantic model_dump through SerializableDict validation.</p>


    </div>

</div>



  </div>


    </div>

</div>
  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.value_resolvers.auto_resolve_value" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.auto_resolve_value" class="doc-anchor"><code class="highlight language-python"><span class="n">auto_resolve_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">auto_resolve_value</span><span class="p">(</span><span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValueResolver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automatically convert a value to an appropriate ValueResolver.</span>

<span class="sd">    Args:</span>
<span class="sd">        value: Either a static value or a ValueResolver instance</span>

<span class="sd">    Returns:</span>
<span class="sd">        A ValueResolver instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">ValueResolver</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">StaticValue</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Automatically convert a value to an appropriate ValueResolver.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Either a static value or a ValueResolver instance</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ValueResolver" href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver">ValueResolver</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A ValueResolver instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.value_resolvers.create_value_resolver" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.create_value_resolver" class="doc-anchor"><code class="highlight language-python"><span class="n">create_value_resolver</span><span class="p">(</span><span class="n">serialized</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_value_resolver</span><span class="p">(</span><span class="n">serialized</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValueResolver</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a value resolver from serialized data.</span>

<span class="sd">    Args:</span>
<span class="sd">        serialized: The serialized value resolver data</span>

<span class="sd">    Returns:</span>
<span class="sd">        A ValueResolver instance</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the resolver type is unknown</span>
<span class="sd">        KeyError: If the type field is missing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolver_type</span> <span class="o">=</span> <span class="n">serialized</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">resolver_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALUE_RESOLVER_REGISTRY</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown value resolver type: </span><span class="si">{</span><span class="n">resolver_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">resolver_class</span> <span class="o">=</span> <span class="n">VALUE_RESOLVER_REGISTRY</span><span class="p">[</span><span class="n">resolver_type</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">safe_model_validate</span><span class="p">(</span><span class="n">resolver_class</span><span class="p">,</span> <span class="n">serialized</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create a value resolver from serialized data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>serialized</code>
            </td>
            <td>
                  <code><span title="luthien_control.control_policy.serialization.SerializableDict">SerializableDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The serialized value resolver data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ValueResolver" href="#luthien_control.control_policy.conditions.value_resolvers.ValueResolver">ValueResolver</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A ValueResolver instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the resolver type is unknown</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the type field is missing</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.conditions.value_resolvers.path" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.control_policy.conditions.value_resolvers.path" class="doc-anchor"><code class="highlight language-python"><span class="n">path</span><span class="p">(</span><span class="n">transaction_path</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/conditions/value_resolvers.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">path</span><span class="p">(</span><span class="n">transaction_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TransactionPath</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function to create a TransactionPath.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction_path: The path to the value in the transaction</span>

<span class="sd">    Returns:</span>
<span class="sd">        A TransactionPath instance</span>

<span class="sd">    Example:</span>
<span class="sd">        path(&quot;request.payload.model&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">TransactionPath</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">transaction_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Convenience function to create a TransactionPath.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the value in the transaction</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    TransactionPath" href="#luthien_control.control_policy.conditions.value_resolvers.TransactionPath">TransactionPath</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A TransactionPath instance</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>path("request.payload.model")</p>
</details>

    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.control_policy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control_policy</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.control_policy.ControlPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.control_policy.ControlPolicy" class="doc-anchor"><code>ControlPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code>, <code><span title="abc.ABC">ABC</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/control_policy.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ControlPolicy</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract Base Class defining the interface for a processing step.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (Optional[str]): An optional name for the policy instance.</span>
<span class="sd">            Subclasses are expected to set this, often in their `__init__` method.</span>
<span class="sd">            It&#39;s used for logging and identification purposes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">),</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_policy_type_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the canonical policy type name for serialization.</span>

<span class="sd">        By default, this looks up the class in the registry to get its registered name.</span>
<span class="sd">        Subclasses can override this if they need custom behavior.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The policy type name used in serialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import here to avoid circular imports</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">POLICY_CLASS_TO_NAME</span>

        <span class="n">policy_type</span> <span class="o">=</span> <span class="n">POLICY_CLASS_TO_NAME</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">policy_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not registered in POLICY_CLASS_TO_NAME registry&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">policy_type</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the ControlPolicy.</span>

<span class="sd">        This is an abstract base class, and this constructor typically handles</span>
<span class="sd">        common initialization or can be overridden by subclasses.</span>

<span class="sd">        Args:</span>
<span class="sd">            **data: Arbitrary keyword arguments that subclasses might use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_policy_type_name</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="s2">&quot;Transaction&quot;</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="s2">&quot;DependencyContainer&quot;</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="s2">&quot;AsyncSession&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Transaction&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the policy to the transaction using provided dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            transaction: The current transaction.</span>
<span class="sd">            container: The dependency injection container.</span>
<span class="sd">            session: The database session for the current request. We include this separately because</span>
<span class="sd">                it&#39;s request-scoped rather than application-scoped.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The potentially modified transaction.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Processors may raise exceptions to halt the processing flow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize using Pydantic model_dump through SerializableDict validation.&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">by_alias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">SerializableDictAdapter</span>

        <span class="k">return</span> <span class="n">SerializableDictAdapter</span><span class="o">.</span><span class="n">validate_python</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># construct from serialization</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">PolicyT</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolicyT</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a policy from a serialized configuration and optional dependencies.</span>

<span class="sd">        This method acts as a dispatcher. It looks up the concrete policy class</span>
<span class="sd">        based on the &#39;type&#39; field in the config and delegates to its from_serialized method.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: The policy-specific configuration dictionary. It must contain a &#39;type&#39; key</span>
<span class="sd">                    that maps to a registered policy type.</span>
<span class="sd">            **kwargs: Additional dependencies needed for instantiation, passed to the</span>
<span class="sd">                      concrete policy&#39;s from_serialized method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An instance of the concrete policy class.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the &#39;type&#39; key is missing in config or the type is not registered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Import inside the method to break circular dependency</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">POLICY_NAME_TO_CLASS</span>

        <span class="n">config_copy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

        <span class="n">policy_type_name_val</span> <span class="o">=</span> <span class="n">config_copy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy_type_name_val</span> <span class="ow">and</span> <span class="bp">cls</span> <span class="o">!=</span> <span class="n">ControlPolicy</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">inferred_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_policy_type_name</span><span class="p">()</span>
                <span class="n">config_copy</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inferred_type</span>
                <span class="n">policy_type_name_val</span> <span class="o">=</span> <span class="n">inferred_type</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy_type_name_val</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Policy configuration must include a &#39;type&#39; field&quot;</span><span class="p">)</span>

        <span class="n">target_policy_class</span> <span class="o">=</span> <span class="n">POLICY_NAME_TO_CLASS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">policy_type_name_val</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_policy_class</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown policy type &#39;</span><span class="si">{</span><span class="n">policy_type_name_val</span><span class="si">}</span><span class="s2">&#39;. Ensure it is registered in POLICY_NAME_TO_CLASS.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">PolicyT</span><span class="p">,</span> <span class="n">safe_model_validate</span><span class="p">(</span><span class="n">target_policy_class</span><span class="p">,</span> <span class="n">config_copy</span><span class="p">))</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Abstract Base Class defining the interface for a processing step.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.control_policy.ControlPolicy.name">name</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An optional name for the policy instance.
Subclasses are expected to set this, often in their <code>__init__</code> method.
It's used for logging and identification purposes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.control_policy.ControlPolicy.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.control_policy.ControlPolicy.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/control_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the ControlPolicy.</span>

<span class="sd">    This is an abstract base class, and this constructor typically handles</span>
<span class="sd">    common initialization or can be overridden by subclasses.</span>

<span class="sd">    Args:</span>
<span class="sd">        **data: Arbitrary keyword arguments that subclasses might use.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_policy_type_name</span><span class="p">()</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initializes the ControlPolicy.</p>
<p>This is an abstract base class, and this constructor typically handles
common initialization or can be overridden by subclasses.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>**data</code>
            </td>
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arbitrary keyword arguments that subclasses might use.</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.control_policy.ControlPolicy.apply" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.control_policy.ControlPolicy.apply" class="doc-anchor"><code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/control_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="s2">&quot;Transaction&quot;</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span> <span class="s2">&quot;DependencyContainer&quot;</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="s2">&quot;AsyncSession&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Transaction&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply the policy to the transaction using provided dependencies.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The current transaction.</span>
<span class="sd">        container: The dependency injection container.</span>
<span class="sd">        session: The database session for the current request. We include this separately because</span>
<span class="sd">            it&#39;s request-scoped rather than application-scoped.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The potentially modified transaction.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: Processors may raise exceptions to halt the processing flow.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Apply the policy to the transaction using provided dependencies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current transaction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dependency injection container.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session for the current request. We include this separately because
it's request-scoped rather than application-scoped.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The potentially modified transaction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Processors may raise exceptions to halt the processing flow.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.control_policy.ControlPolicy.from_serialized" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.control_policy.ControlPolicy.from_serialized" class="doc-anchor"><code class="highlight language-python"><span class="n">from_serialized</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/control_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">PolicyT</span><span class="p">],</span> <span class="n">config</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PolicyT</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a policy from a serialized configuration and optional dependencies.</span>

<span class="sd">    This method acts as a dispatcher. It looks up the concrete policy class</span>
<span class="sd">    based on the &#39;type&#39; field in the config and delegates to its from_serialized method.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: The policy-specific configuration dictionary. It must contain a &#39;type&#39; key</span>
<span class="sd">                that maps to a registered policy type.</span>
<span class="sd">        **kwargs: Additional dependencies needed for instantiation, passed to the</span>
<span class="sd">                  concrete policy&#39;s from_serialized method.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An instance of the concrete policy class.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the &#39;type&#39; key is missing in config or the type is not registered.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Import inside the method to break circular dependency</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">POLICY_NAME_TO_CLASS</span>

    <span class="n">config_copy</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="n">policy_type_name_val</span> <span class="o">=</span> <span class="n">config_copy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">policy_type_name_val</span> <span class="ow">and</span> <span class="bp">cls</span> <span class="o">!=</span> <span class="n">ControlPolicy</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">inferred_type</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_policy_type_name</span><span class="p">()</span>
            <span class="n">config_copy</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inferred_type</span>
            <span class="n">policy_type_name_val</span> <span class="o">=</span> <span class="n">inferred_type</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">policy_type_name_val</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Policy configuration must include a &#39;type&#39; field&quot;</span><span class="p">)</span>

    <span class="n">target_policy_class</span> <span class="o">=</span> <span class="n">POLICY_NAME_TO_CLASS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">policy_type_name_val</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_policy_class</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown policy type &#39;</span><span class="si">{</span><span class="n">policy_type_name_val</span><span class="si">}</span><span class="s2">&#39;. Ensure it is registered in POLICY_NAME_TO_CLASS.&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">PolicyT</span><span class="p">,</span> <span class="n">safe_model_validate</span><span class="p">(</span><span class="n">target_policy_class</span><span class="p">,</span> <span class="n">config_copy</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Construct a policy from a serialized configuration and optional dependencies.</p>
<p>This method acts as a dispatcher. It looks up the concrete policy class
based on the 'type' field in the config and delegates to its from_serialized method.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="luthien_control.control_policy.serialization.SerializableDict">SerializableDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The policy-specific configuration dictionary. It must contain a 'type' key
    that maps to a registered policy type.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>**kwargs</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Additional dependencies needed for instantiation, passed to the
      concrete policy's from_serialized method.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="luthien_control.control_policy.control_policy.PolicyT">PolicyT</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of the concrete policy class.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the 'type' key is missing in config or the type is not registered.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.control_policy.ControlPolicy.get_policy_type_name" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.control_policy.ControlPolicy.get_policy_type_name" class="doc-anchor"><code class="highlight language-python"><span class="n">get_policy_type_name</span><span class="p">()</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/control_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_policy_type_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the canonical policy type name for serialization.</span>

<span class="sd">    By default, this looks up the class in the registry to get its registered name.</span>
<span class="sd">    Subclasses can override this if they need custom behavior.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The policy type name used in serialization.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Import here to avoid circular imports</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">POLICY_CLASS_TO_NAME</span>

    <span class="n">policy_type</span> <span class="o">=</span> <span class="n">POLICY_CLASS_TO_NAME</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">policy_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> is not registered in POLICY_CLASS_TO_NAME registry&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">policy_type</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get the canonical policy type name for serialization.</p>
<p>By default, this looks up the class in the registry to get its registered name.
Subclasses can override this if they need custom behavior.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The policy type name used in serialization.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.control_policy.ControlPolicy.serialize" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.control_policy.ControlPolicy.serialize" class="doc-anchor"><code class="highlight language-python"><span class="n">serialize</span><span class="p">()</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/control_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serialize using Pydantic model_dump through SerializableDict validation.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">by_alias</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exclude_none</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.serialization</span><span class="w"> </span><span class="kn">import</span> <span class="n">SerializableDictAdapter</span>

    <span class="k">return</span> <span class="n">SerializableDictAdapter</span><span class="o">.</span><span class="n">validate_python</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Serialize using Pydantic model_dump through SerializableDict validation.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.exceptions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>exceptions</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.exceptions.ApiKeyNotFoundError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.exceptions.ApiKeyNotFoundError" class="doc-anchor"><code>ApiKeyNotFoundError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicyError" href="#luthien_control.control_policy.exceptions.ControlPolicyError">ControlPolicyError</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ApiKeyNotFoundError</span><span class="p">(</span><span class="n">ControlPolicyError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when the API key is not found in the settings.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the ApiKeyNotFoundError.</span>

<span class="sd">        Args:</span>
<span class="sd">            detail (str): A detailed error message explaining the missing API key.</span>
<span class="sd">            status_code (int): The HTTP status code to associate with this error.</span>
<span class="sd">                               Defaults to 500 (Internal Server Error).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Exception raised when the API key is not found in the settings.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.exceptions.ApiKeyNotFoundError.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.exceptions.ApiKeyNotFoundError.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the ApiKeyNotFoundError.</span>

<span class="sd">    Args:</span>
<span class="sd">        detail (str): A detailed error message explaining the missing API key.</span>
<span class="sd">        status_code (int): The HTTP status code to associate with this error.</span>
<span class="sd">                           Defaults to 500 (Internal Server Error).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initializes the ApiKeyNotFoundError.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>detail</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A detailed error message explaining the missing API key.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>status_code</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The HTTP status code to associate with this error.
               Defaults to 500 (Internal Server Error).</p>
              </div>
            </td>
            <td>
                  <code>500</code>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.exceptions.ClientAuthenticationError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.exceptions.ClientAuthenticationError" class="doc-anchor"><code>ClientAuthenticationError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicyError" href="#luthien_control.control_policy.exceptions.ControlPolicyError">ControlPolicyError</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ClientAuthenticationError</span><span class="p">(</span><span class="n">ControlPolicyError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when client API key authentication fails.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">401</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the ClientAuthenticationError.</span>

<span class="sd">        Args:</span>
<span class="sd">            detail (str): A detailed error message explaining the authentication failure.</span>
<span class="sd">            status_code (int): The HTTP status code to associate with this error.</span>
<span class="sd">                               Defaults to 401 (Unauthorized).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Pass detail positionally for Exception.__str__ and keywords for ControlPolicyError attributes</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Exception raised when client API key authentication fails.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.exceptions.ClientAuthenticationError.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.exceptions.ClientAuthenticationError.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">401</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the ClientAuthenticationError.</span>

<span class="sd">    Args:</span>
<span class="sd">        detail (str): A detailed error message explaining the authentication failure.</span>
<span class="sd">        status_code (int): The HTTP status code to associate with this error.</span>
<span class="sd">                           Defaults to 401 (Unauthorized).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Pass detail positionally for Exception.__str__ and keywords for ControlPolicyError attributes</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initializes the ClientAuthenticationError.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>detail</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A detailed error message explaining the authentication failure.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>status_code</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The HTTP status code to associate with this error.
               Defaults to 401 (Unauthorized).</p>
              </div>
            </td>
            <td>
                  <code>401</code>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.exceptions.ClientAuthenticationNotFoundError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.exceptions.ClientAuthenticationNotFoundError" class="doc-anchor"><code>ClientAuthenticationNotFoundError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicyError" href="#luthien_control.control_policy.exceptions.ControlPolicyError">ControlPolicyError</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ClientAuthenticationNotFoundError</span><span class="p">(</span><span class="n">ControlPolicyError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when the client API key is not found in the request.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">401</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the ClientAuthenticationNotFoundError.</span>

<span class="sd">        Args:</span>
<span class="sd">            detail (str): A detailed error message explaining why the key was not found.</span>
<span class="sd">            status_code (int): The HTTP status code to associate with this error.</span>
<span class="sd">                               Defaults to 401 (Unauthorized).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Pass detail positionally for Exception.__str__ and keywords for ControlPolicyError attributes</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Exception raised when the client API key is not found in the request.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.exceptions.ClientAuthenticationNotFoundError.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.exceptions.ClientAuthenticationNotFoundError.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">401</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">401</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the ClientAuthenticationNotFoundError.</span>

<span class="sd">    Args:</span>
<span class="sd">        detail (str): A detailed error message explaining why the key was not found.</span>
<span class="sd">        status_code (int): The HTTP status code to associate with this error.</span>
<span class="sd">                           Defaults to 401 (Unauthorized).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Pass detail positionally for Exception.__str__ and keywords for ControlPolicyError attributes</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initializes the ClientAuthenticationNotFoundError.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>detail</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A detailed error message explaining why the key was not found.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>status_code</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The HTTP status code to associate with this error.
               Defaults to 401 (Unauthorized).</p>
              </div>
            </td>
            <td>
                  <code>401</code>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.exceptions.ControlPolicyError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.exceptions.ControlPolicyError" class="doc-anchor"><code>ControlPolicyError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    LuthienException" href="#luthien_control.exceptions.LuthienException">LuthienException</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ControlPolicyError</span><span class="p">(</span><span class="n">LuthienException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for all control policy errors.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        policy_name (Optional[str]): The name of the policy where the error</span>
<span class="sd">            occurred, if specified.</span>
<span class="sd">        status_code (Optional[int]): An HTTP status code associated with this</span>
<span class="sd">            error, if specified.</span>
<span class="sd">        detail (Optional[str]): A detailed error message. If not provided directly</span>
<span class="sd">            during initialization but other arguments are, the first positional</span>
<span class="sd">            argument is used as the detail.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the ControlPolicyError.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Arguments passed to the base Exception class.</span>
<span class="sd">            policy_name (Optional[str]): The name of the policy where the error occurred.</span>
<span class="sd">            status_code (Optional[int]): An HTTP status code associated with this error.</span>
<span class="sd">            detail (Optional[str]): A detailed error message. If not provided and `args`</span>
<span class="sd">                                    is not empty, the first argument in `args` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">policy_name</span> <span class="o">=</span> <span class="n">policy_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="c1"># Use the first arg as detail if detail kwarg is not provided and args exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="n">detail</span> <span class="ow">or</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Base exception for all control policy errors.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.exceptions.ControlPolicyError.policy_name">policy_name</span></code></td>
            <td>
                  <code><span title="Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the policy where the error
occurred, if specified.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.exceptions.ControlPolicyError.status_code">status_code</span></code></td>
            <td>
                  <code><span title="Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An HTTP status code associated with this
error, if specified.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.exceptions.ControlPolicyError.detail">detail</span></code></td>
            <td>
                  <code><span title="Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A detailed error message. If not provided directly
during initialization but other arguments are, the first positional
argument is used as the detail.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.exceptions.ControlPolicyError.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.exceptions.ControlPolicyError.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">policy_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the ControlPolicyError.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Arguments passed to the base Exception class.</span>
<span class="sd">        policy_name (Optional[str]): The name of the policy where the error occurred.</span>
<span class="sd">        status_code (Optional[int]): An HTTP status code associated with this error.</span>
<span class="sd">        detail (Optional[str]): A detailed error message. If not provided and `args`</span>
<span class="sd">                                is not empty, the first argument in `args` is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">policy_name</span> <span class="o">=</span> <span class="n">policy_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
    <span class="c1"># Use the first arg as detail if detail kwarg is not provided and args exist</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">detail</span> <span class="o">=</span> <span class="n">detail</span> <span class="ow">or</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">args</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initializes the ControlPolicyError.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>*args</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arguments passed to the base Exception class.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>policy_name</code>
            </td>
            <td>
                  <code><span title="Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the policy where the error occurred.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>status_code</code>
            </td>
            <td>
                  <code><span title="Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An HTTP status code associated with this error.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>detail</code>
            </td>
            <td>
                  <code><span title="Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A detailed error message. If not provided and <code>args</code>
                    is not empty, the first argument in <code>args</code> is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.exceptions.LeakedApiKeyError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.exceptions.LeakedApiKeyError" class="doc-anchor"><code>LeakedApiKeyError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicyError" href="#luthien_control.control_policy.exceptions.ControlPolicyError">ControlPolicyError</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LeakedApiKeyError</span><span class="p">(</span><span class="n">ControlPolicyError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when a leaked API key is detected.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">403</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the LeakedApiKeyError.</span>

<span class="sd">        Args:</span>
<span class="sd">            detail (str): A detailed error message explaining the leaked key detection.</span>
<span class="sd">            status_code (int): The HTTP status code to associate with this error.</span>
<span class="sd">                               Defaults to 403 (Forbidden).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Pass detail positionally for Exception.__str__ and keywords for ControlPolicyError attributes</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Exception raised when a leaked API key is detected.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.exceptions.LeakedApiKeyError.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.exceptions.LeakedApiKeyError.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">403</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">403</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the LeakedApiKeyError.</span>

<span class="sd">    Args:</span>
<span class="sd">        detail (str): A detailed error message explaining the leaked key detection.</span>
<span class="sd">        status_code (int): The HTTP status code to associate with this error.</span>
<span class="sd">                           Defaults to 403 (Forbidden).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Pass detail positionally for Exception.__str__ and keywords for ControlPolicyError attributes</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initializes the LeakedApiKeyError.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>detail</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A detailed error message explaining the leaked key detection.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>status_code</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The HTTP status code to associate with this error.
               Defaults to 403 (Forbidden).</p>
              </div>
            </td>
            <td>
                  <code>403</code>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.exceptions.NoRequestError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.exceptions.NoRequestError" class="doc-anchor"><code>NoRequestError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicyError" href="#luthien_control.control_policy.exceptions.ControlPolicyError">ControlPolicyError</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NoRequestError</span><span class="p">(</span><span class="n">ControlPolicyError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when the request object is not found in the context.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Exception raised when the request object is not found in the context.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.exceptions.PolicyLoadError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.exceptions.PolicyLoadError" class="doc-anchor"><code>PolicyLoadError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="ValueError">ValueError</span></code>, <code><a class="autorefs autorefs-internal" title="    ControlPolicyError" href="#luthien_control.control_policy.exceptions.ControlPolicyError">ControlPolicyError</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PolicyLoadError</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ControlPolicyError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom exception for errors during policy loading/instantiation.&quot;&quot;&quot;</span>

    <span class="c1"># Inherit from ValueError for semantic meaning (bad value/config)</span>
    <span class="c1"># Inherit from ControlPolicyError for categorization</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initializes the PolicyLoadError.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Arguments passed to the base Exception class.</span>
<span class="sd">            policy_name (Optional[str]): The name of the policy that failed to load.</span>
<span class="sd">            status_code (Optional[int]): An HTTP status code associated with this error.</span>
<span class="sd">            detail (Optional[str]): A detailed error message. If not provided and `args`</span>
<span class="sd">                                    is not empty, the first argument in `args` is used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Explicitly call ControlPolicyError.__init__ to handle kwargs</span>
        <span class="n">ControlPolicyError</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">policy_name</span><span class="o">=</span><span class="n">policy_name</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Custom exception for errors during policy loading/instantiation.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.exceptions.PolicyLoadError.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.exceptions.PolicyLoadError.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">policy_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/exceptions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">detail</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initializes the PolicyLoadError.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Arguments passed to the base Exception class.</span>
<span class="sd">        policy_name (Optional[str]): The name of the policy that failed to load.</span>
<span class="sd">        status_code (Optional[int]): An HTTP status code associated with this error.</span>
<span class="sd">        detail (Optional[str]): A detailed error message. If not provided and `args`</span>
<span class="sd">                                is not empty, the first argument in `args` is used.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Explicitly call ControlPolicyError.__init__ to handle kwargs</span>
    <span class="n">ControlPolicyError</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">policy_name</span><span class="o">=</span><span class="n">policy_name</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="n">detail</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initializes the PolicyLoadError.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>*args</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Arguments passed to the base Exception class.</p>
              </div>
            </td>
            <td>
                  <code>()</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>policy_name</code>
            </td>
            <td>
                  <code><span title="Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the policy that failed to load.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>status_code</code>
            </td>
            <td>
                  <code><span title="Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An HTTP status code associated with this error.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>detail</code>
            </td>
            <td>
                  <code><span title="Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A detailed error message. If not provided and <code>args</code>
                    is not empty, the first argument in <code>args</code> is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.leaked_api_key_detection" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>leaked_api_key_detection</code>


</h3>

    <div class="doc doc-contents ">

        <p>Control Policy for detecting leaked API keys in LLM message content.</p>
<p>This policy inspects the 'messages' field in request bodies to prevent
sensitive API keys from being sent to language models.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy" class="doc-anchor"><code>LeakedApiKeyDetectionPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/leaked_api_key_detection.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LeakedApiKeyDetectionPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Detects API keys that might be leaked in message content sent to LLMs.</span>

<span class="sd">    This policy scans message content for patterns matching common API key formats</span>
<span class="sd">    to prevent accidental exposure of sensitive credentials to language models.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Common API key patterns</span>
    <span class="n">DEFAULT_PATTERNS</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="sa">r</span><span class="s2">&quot;sk-[a-zA-Z0-9]</span><span class="si">{48}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># OpenAI API key pattern</span>
        <span class="sa">r</span><span class="s2">&quot;xoxb-[a-zA-Z0-9\-]{50,}&quot;</span><span class="p">,</span>  <span class="c1"># Slack bot token pattern</span>
        <span class="sa">r</span><span class="s2">&quot;github_pat_[a-zA-Z0-9]</span><span class="si">{22}</span><span class="s2">_[a-zA-Z0-9]</span><span class="si">{59}</span><span class="s2">&quot;</span><span class="p">,</span>  <span class="c1"># GitHub PAT pattern</span>
    <span class="p">]</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="s2">&quot;LeakedApiKeyDetectionPolicy&quot;</span><span class="p">)</span>
    <span class="n">patterns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">LeakedApiKeyDetectionPolicy</span><span class="o">.</span><span class="n">DEFAULT_PATTERNS</span><span class="p">)</span>
    <span class="n">compiled_patterns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">Pattern</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;patterns&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_patterns</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle patterns validation and fallback to defaults for empty lists.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DEFAULT_PATTERNS</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compile_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compile regex patterns after validation.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compiled_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks message content for potentially leaked API keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            transaction: The current transaction.</span>
<span class="sd">            container: The application dependency container.</span>
<span class="sd">            session: An active SQLAlchemy AsyncSession.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The transaction, potentially with an error response set.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NoRequestError: If the request is not found in the transaction.</span>
<span class="sd">            LeakedApiKeyError: If a potential API key is detected in message content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoRequestError</span><span class="p">(</span><span class="s2">&quot;No request in transaction.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking for leaked API keys in message content (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="p">):</span>
            <span class="n">messages</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">messages</span>

            <span class="c1"># Inspect each message&#39;s content</span>
            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">content</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_text</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
                        <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;Potential API key detected in message content. For security, the request has been blocked.&quot;</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">LeakedApiKeyError</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="n">error_message</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">transaction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the given text contains any patterns matching potential API keys.</span>

<span class="sd">        Args:</span>
<span class="sd">            text: The text to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            True if a potential API key is found, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">compiled_patterns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Detects API keys that might be leaked in message content sent to LLMs.</p>
<p>This policy scans message content for patterns matching common API key formats
to prevent accidental exposure of sensitive credentials to language models.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy.apply" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy.apply" class="doc-anchor"><code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/leaked_api_key_detection.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Checks message content for potentially leaked API keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The current transaction.</span>
<span class="sd">        container: The application dependency container.</span>
<span class="sd">        session: An active SQLAlchemy AsyncSession.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The transaction, potentially with an error response set.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NoRequestError: If the request is not found in the transaction.</span>
<span class="sd">        LeakedApiKeyError: If a potential API key is detected in message content.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoRequestError</span><span class="p">(</span><span class="s2">&quot;No request in transaction.&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Checking for leaked API keys in message content (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="p">):</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">messages</span>

        <span class="c1"># Inspect each message&#39;s content</span>
        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">content</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_text</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
                    <span class="n">error_message</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Potential API key detected in message content. For security, the request has been blocked.&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error_message</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">LeakedApiKeyError</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="n">error_message</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Checks message content for potentially leaked API keys.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current transaction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The application dependency container.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An active SQLAlchemy AsyncSession.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The transaction, potentially with an error response set.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    NoRequestError" href="#luthien_control.control_policy.exceptions.NoRequestError">NoRequestError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the request is not found in the transaction.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LeakedApiKeyError" href="#luthien_control.control_policy.exceptions.LeakedApiKeyError">LeakedApiKeyError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a potential API key is detected in message content.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy.compile_patterns" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy.compile_patterns" class="doc-anchor"><code class="highlight language-python"><span class="n">compile_patterns</span><span class="p">()</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/leaked_api_key_detection.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;after&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compile_patterns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compile regex patterns after validation.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">compiled_patterns</span> <span class="o">=</span> <span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">patterns</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Compile regex patterns after validation.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy.validate_patterns" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.leaked_api_key_detection.LeakedApiKeyDetectionPolicy.validate_patterns" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_patterns</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/leaked_api_key_detection.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@field_validator</span><span class="p">(</span><span class="s2">&quot;patterns&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_patterns</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle patterns validation and fallback to defaults for empty lists.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DEFAULT_PATTERNS</span>
    <span class="k">return</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Handle patterns validation and fallback to defaults for empty lists.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.loader" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>loader</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.control_policy.loader.load_policy" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.control_policy.loader.load_policy" class="doc-anchor"><code class="highlight language-python"><span class="n">load_policy</span><span class="p">(</span><span class="n">serialized_policy</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/loader.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_policy</span><span class="p">(</span><span class="n">serialized_policy</span><span class="p">:</span> <span class="n">SerializedPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ControlPolicy&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads a ControlPolicy instance from a dictionary containing its name and config,</span>
<span class="sd">    injecting required dependencies.</span>

<span class="sd">    Args:</span>
<span class="sd">        serialized_policy: A SerializedPolicy object.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An instantiated ControlPolicy object.</span>

<span class="sd">    Raises:</span>
<span class="sd">        PolicyLoadError: If the policy name is unknown, data is missing/malformed,</span>
<span class="sd">                         or a required dependency is not provided.</span>
<span class="sd">        Exception: Potentially from the policy&#39;s from_serialized method if config is invalid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Import the policy registry here to avoid circular import</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">POLICY_NAME_TO_CLASS</span>  <span class="c1"># noqa: F401</span>

    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

    <span class="n">policy_type</span> <span class="o">=</span> <span class="n">serialized_policy</span><span class="o">.</span><span class="n">type</span>
    <span class="n">policy_config</span> <span class="o">=</span> <span class="n">serialized_policy</span><span class="o">.</span><span class="n">config</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">policy_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Policy &#39;type&#39; must be a string, got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">policy_type</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">policy_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Policy &#39;config&#39; must be a dictionary, got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">policy_config</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">policy_class</span> <span class="o">=</span> <span class="n">POLICY_NAME_TO_CLASS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">policy_type</span><span class="p">)</span>

    <span class="c1"># Explicitly check if the policy type was found in the registry</span>
    <span class="k">if</span> <span class="n">policy_class</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown policy type: &#39;</span><span class="si">{</span><span class="n">policy_type</span><span class="si">}</span><span class="s2">&#39;. Available policies: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">POLICY_NAME_TO_CLASS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">policy_class</span><span class="o">.</span><span class="n">from_serialized</span><span class="p">(</span><span class="n">policy_config</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded policy: </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">policy_type</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instance</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error instantiating policy &#39;</span><span class="si">{</span><span class="n">policy_type</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error instantiating policy &#39;</span><span class="si">{</span><span class="n">policy_type</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Loads a ControlPolicy instance from a dictionary containing its name and config,
injecting required dependencies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>serialized_policy</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    SerializedPolicy


  
      dataclass
  " href="#luthien_control.control_policy.serialization.SerializedPolicy">SerializedPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A SerializedPolicy object.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instantiated ControlPolicy object.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    PolicyLoadError" href="#luthien_control.control_policy.exceptions.PolicyLoadError">PolicyLoadError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the policy name is unknown, data is missing/malformed,
             or a required dependency is not provided.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Potentially from the policy's from_serialized method if config is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.control_policy.loader.load_policy_from_file" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.control_policy.loader.load_policy_from_file" class="doc-anchor"><code class="highlight language-python"><span class="n">load_policy_from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/loader.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_policy_from_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ControlPolicy&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a policy configuration from a file and instantiate it using the control_policy loader.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">raw_policy_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">raw_policy_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Policy data loaded from </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> must be a dictionary, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">raw_policy_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">policy_type</span> <span class="o">=</span> <span class="n">raw_policy_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
    <span class="n">policy_config</span> <span class="o">=</span> <span class="n">raw_policy_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">policy_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Policy file </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> must contain a &#39;type&#39; field as a string. Got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">policy_type</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">policy_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Policy file </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> must contain a &#39;config&#39; field as a dictionary. Got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">policy_config</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">serialized_policy_obj</span> <span class="o">=</span> <span class="n">SerializedPolicy</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">policy_type</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">policy_config</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">load_policy</span><span class="p">(</span><span class="n">serialized_policy_obj</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Load a policy configuration from a file and instantiate it using the control_policy loader.</p>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.model_name_replacement" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>model_name_replacement</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.model_name_replacement.ModelNameReplacementPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.model_name_replacement.ModelNameReplacementPolicy" class="doc-anchor"><code>ModelNameReplacementPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/model_name_replacement.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ModelNameReplacementPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Replaces model names in requests based on a configured mapping.</span>

<span class="sd">    This policy allows clients to use fake model names that will be</span>
<span class="sd">    replaced with real model names before the request is sent to the backend.</span>
<span class="sd">    This is useful for services like Cursor that assume model strings that match</span>
<span class="sd">    known models must route through specific endpoints.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;ModelNameReplacementPolicy&quot;</span><span class="p">)</span>
    <span class="n">model_mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Replaces the model name in the request payload based on the configured mapping.</span>

<span class="sd">        Args:</span>
<span class="sd">            transaction: The current transaction.</span>
<span class="sd">            container: The application dependency container.</span>
<span class="sd">            session: An active SQLAlchemy AsyncSession (unused).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The potentially modified transaction.</span>

<span class="sd">        Raises:</span>
<span class="sd">            NoRequestError: If no request is found in the transaction.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoRequestError</span><span class="p">(</span><span class="s2">&quot;No request in transaction.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">):</span>
            <span class="n">original_model</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">model</span>

            <span class="k">if</span> <span class="n">original_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_mapping</span><span class="p">:</span>
                <span class="n">new_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_mapping</span><span class="p">[</span><span class="n">original_model</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replacing model name: </span><span class="si">{</span><span class="n">original_model</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">new_model</span>

        <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Replaces model names in requests based on a configured mapping.</p>
<p>This policy allows clients to use fake model names that will be
replaced with real model names before the request is sent to the backend.
This is useful for services like Cursor that assume model strings that match
known models must route through specific endpoints.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.model_name_replacement.ModelNameReplacementPolicy.apply" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.model_name_replacement.ModelNameReplacementPolicy.apply" class="doc-anchor"><code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/model_name_replacement.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replaces the model name in the request payload based on the configured mapping.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The current transaction.</span>
<span class="sd">        container: The application dependency container.</span>
<span class="sd">        session: An active SQLAlchemy AsyncSession (unused).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The potentially modified transaction.</span>

<span class="sd">    Raises:</span>
<span class="sd">        NoRequestError: If no request is found in the transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoRequestError</span><span class="p">(</span><span class="s2">&quot;No request in transaction.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">):</span>
        <span class="n">original_model</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">model</span>

        <span class="k">if</span> <span class="n">original_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_mapping</span><span class="p">:</span>
            <span class="n">new_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_mapping</span><span class="p">[</span><span class="n">original_model</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Replacing model name: </span><span class="si">{</span><span class="n">original_model</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">new_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">new_model</span>

    <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Replaces the model name in the request payload based on the configured mapping.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current transaction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The application dependency container.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An active SQLAlchemy AsyncSession (unused).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The potentially modified transaction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    NoRequestError" href="#luthien_control.control_policy.exceptions.NoRequestError">NoRequestError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no request is found in the transaction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.noop_policy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>noop_policy</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.noop_policy.NoopPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.noop_policy.NoopPolicy" class="doc-anchor"><code>NoopPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/noop_policy.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NoopPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A policy that does nothing.</span>

<span class="sd">    This is the simplest possible policy implementation. It passes through</span>
<span class="sd">    the transaction unchanged and has no policy-specific configuration beyond</span>
<span class="sd">    its name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;NoopPolicy&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Simply returns the transaction unchanged.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A policy that does nothing.</p>
<p>This is the simplest possible policy implementation. It passes through
the transaction unchanged and has no policy-specific configuration beyond
its name.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.noop_policy.NoopPolicy.apply" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.noop_policy.NoopPolicy.apply" class="doc-anchor"><code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/noop_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simply returns the transaction unchanged.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Simply returns the transaction unchanged.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.send_backend_request" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>send_backend_request</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.send_backend_request.SendBackendRequestPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.send_backend_request.SendBackendRequestPolicy" class="doc-anchor"><code>SendBackendRequestPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/send_backend_request.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SendBackendRequestPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Policy responsible for sending the chat completions request to the OpenAI-compatible backend</span>
<span class="sd">    using the OpenAI SDK and storing the structured response.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        name (str): The name of this policy instance, used for logging and</span>
<span class="sd">            identification. It defaults to the class name if not provided</span>
<span class="sd">            during initialization.</span>
<span class="sd">        logger (logging.Logger): The logger instance for this policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;SendBackendRequestPolicy&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_debug_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">backend_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">request_payload</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">error</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create debug information for backend request failures.&quot;&quot;&quot;</span>
        <span class="n">debug_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;backend_url&quot;</span><span class="p">:</span> <span class="n">backend_url</span><span class="p">,</span>
            <span class="s2">&quot;request_model&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request_payload</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
            <span class="s2">&quot;request_messages_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">request_payload</span><span class="p">,</span> <span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="p">[])),</span>
            <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">error</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">),</span>
        <span class="p">}</span>

        <span class="c1"># Add OpenAI-specific error details if available</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;response&quot;</span><span class="p">)</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">debug_info</span><span class="p">[</span><span class="s2">&quot;backend_response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">,</span>
                <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="p">{})),</span>
            <span class="p">}</span>
            <span class="c1"># Try to get response body if available</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">):</span>
                <span class="n">debug_info</span><span class="p">[</span><span class="s2">&quot;backend_response&quot;</span><span class="p">][</span><span class="s2">&quot;body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="c1"># For 404 errors, include identifying characters from the API key</span>
            <span class="k">if</span> <span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span> <span class="ow">and</span> <span class="n">api_key</span><span class="p">:</span>
                <span class="n">debug_info</span><span class="p">[</span><span class="s2">&quot;api_key_identifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_api_key_identifier</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">debug_info</span><span class="p">[</span><span class="s2">&quot;backend_error_body&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">debug_info</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_api_key_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get identifying characters from API key for debugging (first 8 and last 4 chars).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;empty&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_key</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="si">{</span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">api_key</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">...</span><span class="si">{</span><span class="n">api_key</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the chat completions request to the OpenAI-compatible backend using the OpenAI SDK.</span>

<span class="sd">        This policy uses the OpenAI SDK to send the structured chat completions request</span>
<span class="sd">        from transaction.request.payload to the backend API endpoint. The response</span>
<span class="sd">        is stored as a structured OpenAIChatCompletionsResponse in transaction.response.payload.</span>

<span class="sd">        Args:</span>
<span class="sd">            transaction: The current transaction, containing the request payload to be sent.</span>
<span class="sd">            container: The application dependency container, providing settings and OpenAI client.</span>
<span class="sd">            session: An active SQLAlchemy AsyncSession. (Unused by this policy but required by the interface).</span>

<span class="sd">        Returns:</span>
<span class="sd">            The Transaction, updated with transaction.response.payload containing the</span>
<span class="sd">            OpenAIChatCompletionsResponse from the backend.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If backend URL or API key is not configured.</span>
<span class="sd">            openai.APIError: For API-related errors from the OpenAI backend.</span>
<span class="sd">            openai.APITimeoutError: If the request to the backend times out.</span>
<span class="sd">            openai.APIConnectionError: For network-related issues during the backend request.</span>
<span class="sd">            Exception: For any other unexpected errors during request execution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create OpenAI client for the backend request</span>
        <span class="n">backend_url</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_endpoint</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">backend_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Backend URL is not configured&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;OpenAI API key is not configured&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating OpenAI client with backend URL: &#39;</span><span class="si">{</span><span class="n">backend_url</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">openai_client</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">create_openai_client</span><span class="p">(</span><span class="n">backend_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>

        <span class="c1"># Get the structured request payload</span>
        <span class="n">request_payload</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Sending chat completions request to backend with model &#39;</span><span class="si">{</span><span class="n">request_payload</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">request_payload</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages. (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">); &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Target url: </span><span class="si">{</span><span class="n">backend_url</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Send request using OpenAI SDK</span>
            <span class="c1"># Use the request payload directly - the OpenAI SDK should accept our Pydantic model</span>
            <span class="n">request_dict</span> <span class="o">=</span> <span class="n">request_payload</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
            <span class="c1"># Remove any None values to avoid issues with the OpenAI SDK</span>
            <span class="n">request_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">request_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

            <span class="n">backend_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">openai_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">request_dict</span><span class="p">)</span>

            <span class="c1"># Convert OpenAI SDK response to our structured response model</span>
            <span class="n">response_payload</span> <span class="o">=</span> <span class="n">OpenAIChatCompletionsResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">backend_response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>

            <span class="c1"># Store the structured response in the transaction</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">response_payload</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">api_endpoint</span> <span class="o">=</span> <span class="n">backend_url</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Received backend response with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response_payload</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span><span class="si">}</span><span class="s2"> choices &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;and usage: </span><span class="si">{</span><span class="n">response_payload</span><span class="o">.</span><span class="n">usage</span><span class="si">}</span><span class="s2">. (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="n">openai</span><span class="o">.</span><span class="n">APITimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="c1"># Store debug information for potential dev mode access</span>
            <span class="n">debug_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_debug_info</span><span class="p">(</span><span class="n">backend_url</span><span class="p">,</span> <span class="n">request_payload</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">debug_info</span> <span class="o">=</span> <span class="n">debug_info</span>  <span class="c1"># type: ignore</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">openai</span><span class="o">.</span><span class="n">APIConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="c1"># Store debug information for potential dev mode access</span>
            <span class="n">debug_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_debug_info</span><span class="p">(</span><span class="n">backend_url</span><span class="p">,</span> <span class="n">request_payload</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">debug_info</span> <span class="o">=</span> <span class="n">debug_info</span>  <span class="c1"># type: ignore</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="n">openai</span><span class="o">.</span><span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAI API error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="c1"># Store debug information for potential dev mode access</span>
            <span class="n">debug_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_debug_info</span><span class="p">(</span><span class="n">backend_url</span><span class="p">,</span> <span class="n">request_payload</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">debug_info</span> <span class="o">=</span> <span class="n">debug_info</span>  <span class="c1"># type: ignore</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="c1"># Store debug information for potential dev mode access</span>
            <span class="n">debug_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_debug_info</span><span class="p">(</span><span class="n">backend_url</span><span class="p">,</span> <span class="n">request_payload</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
            <span class="n">e</span><span class="o">.</span><span class="n">debug_info</span> <span class="o">=</span> <span class="n">debug_info</span>  <span class="c1"># type: ignore</span>
            <span class="k">raise</span>

        <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Policy responsible for sending the chat completions request to the OpenAI-compatible backend
using the OpenAI SDK and storing the structured response.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.send_backend_request.SendBackendRequestPolicy.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of this policy instance, used for logging and
identification. It defaults to the class name if not provided
during initialization.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.send_backend_request.SendBackendRequestPolicy.logger">logger</span></code></td>
            <td>
                  <code><span title="logging.Logger">Logger</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The logger instance for this policy.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.send_backend_request.SendBackendRequestPolicy.apply" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.send_backend_request.SendBackendRequestPolicy.apply" class="doc-anchor"><code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/send_backend_request.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sends the chat completions request to the OpenAI-compatible backend using the OpenAI SDK.</span>

<span class="sd">    This policy uses the OpenAI SDK to send the structured chat completions request</span>
<span class="sd">    from transaction.request.payload to the backend API endpoint. The response</span>
<span class="sd">    is stored as a structured OpenAIChatCompletionsResponse in transaction.response.payload.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The current transaction, containing the request payload to be sent.</span>
<span class="sd">        container: The application dependency container, providing settings and OpenAI client.</span>
<span class="sd">        session: An active SQLAlchemy AsyncSession. (Unused by this policy but required by the interface).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The Transaction, updated with transaction.response.payload containing the</span>
<span class="sd">        OpenAIChatCompletionsResponse from the backend.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If backend URL or API key is not configured.</span>
<span class="sd">        openai.APIError: For API-related errors from the OpenAI backend.</span>
<span class="sd">        openai.APITimeoutError: If the request to the backend times out.</span>
<span class="sd">        openai.APIConnectionError: For network-related issues during the backend request.</span>
<span class="sd">        Exception: For any other unexpected errors during request execution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create OpenAI client for the backend request</span>
    <span class="n">backend_url</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_endpoint</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_key</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">backend_url</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Backend URL is not configured&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;OpenAI API key is not configured&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating OpenAI client with backend URL: &#39;</span><span class="si">{</span><span class="n">backend_url</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="n">openai_client</span> <span class="o">=</span> <span class="n">container</span><span class="o">.</span><span class="n">create_openai_client</span><span class="p">(</span><span class="n">backend_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>

    <span class="c1"># Get the structured request payload</span>
    <span class="n">request_payload</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">payload</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Sending chat completions request to backend with model &#39;</span><span class="si">{</span><span class="n">request_payload</span><span class="o">.</span><span class="n">model</span><span class="si">}</span><span class="s2">&#39; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;and </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">request_payload</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span><span class="si">}</span><span class="s2"> messages. (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">); &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;Target url: </span><span class="si">{</span><span class="n">backend_url</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Send request using OpenAI SDK</span>
        <span class="c1"># Use the request payload directly - the OpenAI SDK should accept our Pydantic model</span>
        <span class="n">request_dict</span> <span class="o">=</span> <span class="n">request_payload</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
        <span class="c1"># Remove any None values to avoid issues with the OpenAI SDK</span>
        <span class="n">request_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">request_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

        <span class="n">backend_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">openai_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">request_dict</span><span class="p">)</span>

        <span class="c1"># Convert OpenAI SDK response to our structured response model</span>
        <span class="n">response_payload</span> <span class="o">=</span> <span class="n">OpenAIChatCompletionsResponse</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">backend_response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">())</span>

        <span class="c1"># Store the structured response in the transaction</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">response_payload</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">api_endpoint</span> <span class="o">=</span> <span class="n">backend_url</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Received backend response with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">response_payload</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span><span class="si">}</span><span class="s2"> choices &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;and usage: </span><span class="si">{</span><span class="n">response_payload</span><span class="o">.</span><span class="n">usage</span><span class="si">}</span><span class="s2">. (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="n">openai</span><span class="o">.</span><span class="n">APITimeoutError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Timeout error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="c1"># Store debug information for potential dev mode access</span>
        <span class="n">debug_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_debug_info</span><span class="p">(</span><span class="n">backend_url</span><span class="p">,</span> <span class="n">request_payload</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">debug_info</span> <span class="o">=</span> <span class="n">debug_info</span>  <span class="c1"># type: ignore</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">openai</span><span class="o">.</span><span class="n">APIConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Connection error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="c1"># Store debug information for potential dev mode access</span>
        <span class="n">debug_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_debug_info</span><span class="p">(</span><span class="n">backend_url</span><span class="p">,</span> <span class="n">request_payload</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">debug_info</span> <span class="o">=</span> <span class="n">debug_info</span>  <span class="c1"># type: ignore</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">openai</span><span class="o">.</span><span class="n">APIError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;OpenAI API error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="c1"># Store debug information for potential dev mode access</span>
        <span class="n">debug_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_debug_info</span><span class="p">(</span><span class="n">backend_url</span><span class="p">,</span> <span class="n">request_payload</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">debug_info</span> <span class="o">=</span> <span class="n">debug_info</span>  <span class="c1"># type: ignore</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during backend request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="c1"># Store debug information for potential dev mode access</span>
        <span class="n">debug_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_debug_info</span><span class="p">(</span><span class="n">backend_url</span><span class="p">,</span> <span class="n">request_payload</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">debug_info</span> <span class="o">=</span> <span class="n">debug_info</span>  <span class="c1"># type: ignore</span>
        <span class="k">raise</span>

    <span class="k">return</span> <span class="n">transaction</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Sends the chat completions request to the OpenAI-compatible backend using the OpenAI SDK.</p>
<p>This policy uses the OpenAI SDK to send the structured chat completions request
from transaction.request.payload to the backend API endpoint. The response
is stored as a structured OpenAIChatCompletionsResponse in transaction.response.payload.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current transaction, containing the request payload to be sent.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The application dependency container, providing settings and OpenAI client.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An active SQLAlchemy AsyncSession. (Unused by this policy but required by the interface).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Transaction, updated with transaction.response.payload containing the</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>OpenAIChatCompletionsResponse from the backend.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If backend URL or API key is not configured.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="openai.APIError">APIError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For API-related errors from the OpenAI backend.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="openai.APITimeoutError">APITimeoutError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the request to the backend times out.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="openai.APIConnectionError">APIConnectionError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For network-related issues during the backend request.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For any other unexpected errors during request execution.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.serial_policy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>serial_policy</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.serial_policy.SerialPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.serial_policy.SerialPolicy" class="doc-anchor"><code>SerialPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/serial_policy.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SerialPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Control Policy that applies an ordered sequence of other policies.</span>

<span class="sd">    Policies are applied sequentially. If any policy raises an exception,</span>
<span class="sd">    the execution stops, and the exception propagates.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        policies (Sequence[ControlPolicy]): The ordered sequence of ControlPolicy</span>
<span class="sd">            instances that this policy will apply.</span>
<span class="sd">        logger (logging.Logger): The logger instance for this policy.</span>
<span class="sd">        name (str): The name of this policy instance, used for logging and</span>
<span class="sd">            identification.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;SerialPolicy&quot;</span><span class="p">)</span>
    <span class="n">policies</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ControlPolicy</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

            <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initializing SerialPolicy &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; with an empty policy list.&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
        <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies the contained policies sequentially to the transaction.</span>
<span class="sd">        Requires the DependencyContainer and an active SQLAlchemy AsyncSession.</span>

<span class="sd">        Args:</span>
<span class="sd">            transaction: The current transaction.</span>
<span class="sd">            container: The application dependency container.</span>
<span class="sd">            session: An active SQLAlchemy AsyncSession, passed to member policies.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The transaction after all contained policies have been applied.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception: Propagates any exception raised by a contained policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entering SerialPolicy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">current_transaction</span> <span class="o">=</span> <span class="n">transaction</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
            <span class="n">member_policy_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Get policy name if available</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying policy </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">)</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">member_policy_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">current_transaction</span> <span class="o">=</span> <span class="k">await</span> <span class="n">policy</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">current_transaction</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error applying policy </span><span class="si">{</span><span class="n">member_policy_name</span><span class="si">}</span><span class="s2"> within </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">raise</span>  <span class="c1"># Re-raise the exception to halt processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exiting SerialPolicy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">current_transaction</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Provides a developer-friendly representation.&quot;&quot;&quot;</span>
        <span class="c1"># Get the name of each policy, using getattr as fallback like in apply</span>
        <span class="n">policy_reprs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">]</span>
        <span class="n">policy_list_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">policy_reprs</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(policies=[</span><span class="si">{</span><span class="n">policy_list_str</span><span class="si">}</span><span class="s2">])&gt;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SerialPolicy&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs a SerialPolicy from serialized data, loading member policies.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: The serialized configuration dictionary. Expects a &#39;policies&#39; key</span>
<span class="sd">                    containing a list of dictionaries, each with &#39;type&#39; and &#39;config&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An instance of SerialPolicy.</span>

<span class="sd">        Raises:</span>
<span class="sd">            PolicyLoadError: If &#39;policies&#39; key is missing, not a list, or if loading</span>
<span class="sd">                             a member policy fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">member_policy_data_list_val</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;policies&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">member_policy_data_list_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span><span class="s2">&quot;SerialPolicy config missing &#39;policies&#39; list (key not found).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member_policy_data_list_val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;SerialPolicy &#39;policies&#39; must be an iterable. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">member_policy_data_list_val</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">instantiated_policies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">member_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">member_policy_data_list_val</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Item at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> in SerialPolicy &#39;policies&#39; is not a dictionary. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">member_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Import load_policy to properly handle member policy loading</span>
                <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_policy</span>

                <span class="c1"># Get the type and config from member_data</span>
                <span class="n">member_type</span> <span class="o">=</span> <span class="n">member_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
                <span class="n">member_config</span> <span class="o">=</span> <span class="n">member_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="p">{})</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Member policy at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> must have a &#39;type&#39; field as string. Got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">member_type</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Member policy at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> must have a &#39;config&#39; field as dict. Got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">member_config</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># If name is at the top level (legacy format), move it to config</span>
                <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">member_data</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">member_config</span><span class="p">:</span>
                    <span class="n">member_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">member_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>

                <span class="c1"># Create SerializedPolicy object from member_data</span>
                <span class="n">serialized_member</span> <span class="o">=</span> <span class="n">SerializedPolicy</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">member_type</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">member_config</span><span class="p">)</span>
                <span class="n">member_policy</span> <span class="o">=</span> <span class="n">load_policy</span><span class="p">(</span><span class="n">serialized_member</span><span class="p">)</span>
                <span class="n">instantiated_policies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">member_policy</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">PolicyLoadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to load member policy at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(name: </span><span class="si">{</span><span class="n">member_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">) &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;within SerialPolicy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unexpected error loading member policy at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;(name: </span><span class="si">{</span><span class="n">member_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">) &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;within SerialPolicy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">policies</span><span class="o">=</span><span class="n">instantiated_policies</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;policies&quot;</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A Control Policy that applies an ordered sequence of other policies.</p>
<p>Policies are applied sequentially. If any policy raises an exception,
the execution stops, and the exception propagates.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.serial_policy.SerialPolicy.policies">policies</span></code></td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[<a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ordered sequence of ControlPolicy
instances that this policy will apply.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.serial_policy.SerialPolicy.logger">logger</span></code></td>
            <td>
                  <code><span title="logging.Logger">Logger</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The logger instance for this policy.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.serial_policy.SerialPolicy.name">name</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of this policy instance, used for logging and
identification.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.serial_policy.SerialPolicy.__repr__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.serial_policy.SerialPolicy.__repr__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/serial_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provides a developer-friendly representation.&quot;&quot;&quot;</span>
    <span class="c1"># Get the name of each policy, using getattr as fallback like in apply</span>
    <span class="n">policy_reprs</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> &lt;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&gt;&quot;</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">]</span>
    <span class="n">policy_list_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">policy_reprs</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">(policies=[</span><span class="si">{</span><span class="n">policy_list_str</span><span class="si">}</span><span class="s2">])&gt;&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Provides a developer-friendly representation.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.serial_policy.SerialPolicy.apply" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.serial_policy.SerialPolicy.apply" class="doc-anchor"><code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/serial_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies the contained policies sequentially to the transaction.</span>
<span class="sd">    Requires the DependencyContainer and an active SQLAlchemy AsyncSession.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction: The current transaction.</span>
<span class="sd">        container: The application dependency container.</span>
<span class="sd">        session: An active SQLAlchemy AsyncSession, passed to member policies.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The transaction after all contained policies have been applied.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Exception: Propagates any exception raised by a contained policy.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entering SerialPolicy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">current_transaction</span> <span class="o">=</span> <span class="n">transaction</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">policy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">):</span>
        <span class="n">member_policy_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">policy</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>  <span class="c1"># Get policy name if available</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying policy </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">policies</span><span class="p">)</span><span class="si">}</span><span class="s2"> in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">member_policy_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">current_transaction</span> <span class="o">=</span> <span class="k">await</span> <span class="n">policy</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">current_transaction</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="n">container</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error applying policy </span><span class="si">{</span><span class="n">member_policy_name</span><span class="si">}</span><span class="s2"> within </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">raise</span>  <span class="c1"># Re-raise the exception to halt processing</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exiting SerialPolicy: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">current_transaction</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Applies the contained policies sequentially to the transaction.
Requires the DependencyContainer and an active SQLAlchemy AsyncSession.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The current transaction.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The application dependency container.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An active SQLAlchemy AsyncSession, passed to member policies.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Transaction" href="#luthien_control.core.transaction.Transaction">Transaction</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The transaction after all contained policies have been applied.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Propagates any exception raised by a contained policy.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.control_policy.serial_policy.SerialPolicy.from_serialized" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.control_policy.serial_policy.SerialPolicy.from_serialized" class="doc-anchor"><code class="highlight language-python"><span class="n">from_serialized</span><span class="p">(</span><span class="n">config</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/serial_policy.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_serialized</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;SerialPolicy&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs a SerialPolicy from serialized data, loading member policies.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: The serialized configuration dictionary. Expects a &#39;policies&#39; key</span>
<span class="sd">                containing a list of dictionaries, each with &#39;type&#39; and &#39;config&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An instance of SerialPolicy.</span>

<span class="sd">    Raises:</span>
<span class="sd">        PolicyLoadError: If &#39;policies&#39; key is missing, not a list, or if loading</span>
<span class="sd">                         a member policy fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">member_policy_data_list_val</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;policies&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">member_policy_data_list_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span><span class="s2">&quot;SerialPolicy config missing &#39;policies&#39; list (key not found).&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member_policy_data_list_val</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SerialPolicy &#39;policies&#39; must be an iterable. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">member_policy_data_list_val</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">instantiated_policies</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">member_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">member_policy_data_list_val</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Item at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> in SerialPolicy &#39;policies&#39; is not a dictionary. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">member_data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Import load_policy to properly handle member policy loading</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">luthien_control.control_policy.loader</span><span class="w"> </span><span class="kn">import</span> <span class="n">load_policy</span>

            <span class="c1"># Get the type and config from member_data</span>
            <span class="n">member_type</span> <span class="o">=</span> <span class="n">member_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>
            <span class="n">member_config</span> <span class="o">=</span> <span class="n">member_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;config&quot;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Member policy at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> must have a &#39;type&#39; field as string. Got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">member_type</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">member_config</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Member policy at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> must have a &#39;config&#39; field as dict. Got: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">member_config</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># If name is at the top level (legacy format), move it to config</span>
            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">member_data</span> <span class="ow">and</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">member_config</span><span class="p">:</span>
                <span class="n">member_config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">member_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>

            <span class="c1"># Create SerializedPolicy object from member_data</span>
            <span class="n">serialized_member</span> <span class="o">=</span> <span class="n">SerializedPolicy</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">member_type</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">member_config</span><span class="p">)</span>
            <span class="n">member_policy</span> <span class="o">=</span> <span class="n">load_policy</span><span class="p">(</span><span class="n">serialized_member</span><span class="p">)</span>
            <span class="n">instantiated_policies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">member_policy</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">PolicyLoadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to load member policy at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(name: </span><span class="si">{</span><span class="n">member_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">) &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;within SerialPolicy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PolicyLoadError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error loading member policy at index </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(name: </span><span class="si">{</span><span class="n">member_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">) &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;within SerialPolicy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">policies</span><span class="o">=</span><span class="n">instantiated_policies</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;policies&quot;</span><span class="p">})</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Constructs a SerialPolicy from serialized data, loading member policies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>config</code>
            </td>
            <td>
                  <code><span title="luthien_control.control_policy.serialization.SerializableDict">SerializableDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The serialized configuration dictionary. Expects a 'policies' key
    containing a list of dictionaries, each with 'type' and 'config'.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    SerialPolicy" href="#luthien_control.control_policy.serial_policy.SerialPolicy">SerialPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An instance of SerialPolicy.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    PolicyLoadError" href="#luthien_control.control_policy.exceptions.PolicyLoadError">PolicyLoadError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If 'policies' key is missing, not a list, or if loading
             a member policy fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.serialization" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>serialization</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.serialization.SerializedPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.serialization.SerializedPolicy" class="doc-anchor"><code>SerializedPolicy</code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/serialization.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SerializedPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents the serialized form of a ControlPolicy.</span>

<span class="sd">    This structure is used to store and transfer policy configurations.</span>
<span class="sd">    The &#39;type&#39; field identifies the specific policy class, and the &#39;config&#39;</span>
<span class="sd">    field contains the parameters needed to reconstruct that policy instance.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        type (str): The registered name of the policy type (e.g., &quot;AddApiKeyHeader&quot;).</span>
<span class="sd">        config (SerializableDict): A dictionary containing the configuration</span>
<span class="sd">                                   parameters for the policy instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">SerializableDict</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Represents the serialized form of a ControlPolicy.</p>
<p>This structure is used to store and transfer policy configurations.
The 'type' field identifies the specific policy class, and the 'config'
field contains the parameters needed to reconstruct that policy instance.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.serialization.SerializedPolicy.type">type</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The registered name of the policy type (e.g., "AddApiKeyHeader").</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.control_policy.serialization.SerializedPolicy.config">config</span></code></td>
            <td>
                  <code><span title="luthien_control.control_policy.serialization.SerializableDict">SerializableDict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary containing the configuration
                       parameters for the policy instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">











  </div>


    </div>

</div>
  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.control_policy.serialization.safe_model_dump" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.control_policy.serialization.safe_model_dump" class="doc-anchor"><code class="highlight language-python"><span class="n">safe_model_dump</span><span class="p">(</span><span class="n">model</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/serialization.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">safe_model_dump</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Safely dump a Pydantic model through SerializableDict validation.&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">model_dump</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">,</span> <span class="n">by_alias</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">SerializableDictAdapter</span><span class="o">.</span><span class="n">validate_python</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Safely dump a Pydantic model through SerializableDict validation.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.control_policy.serialization.safe_model_validate" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.control_policy.serialization.safe_model_validate" class="doc-anchor"><code class="highlight language-python"><span class="n">safe_model_validate</span><span class="p">(</span><span class="n">model_class</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/control_policy/serialization.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">safe_model_validate</span><span class="p">(</span><span class="n">model_class</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">data</span><span class="p">:</span> <span class="n">SerializableDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Safely validate data through SerializableDict before creating model.&quot;&quot;&quot;</span>
    <span class="n">validated_data</span> <span class="o">=</span> <span class="n">SerializableDictAdapter</span><span class="o">.</span><span class="n">validate_python</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model_class</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">validated_data</span><span class="p">,</span> <span class="n">from_attributes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Safely validate data through SerializableDict before creating model.</p>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.control_policy.set_backend_policy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>set_backend_policy</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.control_policy.set_backend_policy.SetBackendPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.control_policy.set_backend_policy.SetBackendPolicy" class="doc-anchor"><code>SetBackendPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/control_policy/set_backend_policy.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SetBackendPolicy</span><span class="p">(</span><span class="n">ControlPolicy</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A policy that sets the backend URL for the transaction.&quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;SetBackendPolicy&quot;</span><span class="p">)</span>
    <span class="n">backend_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">transaction</span><span class="p">:</span> <span class="n">Transaction</span><span class="p">,</span> <span class="n">container</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Transaction</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Set the base URL only - the OpenAI client will append the specific endpoint path</span>
            <span class="c1"># The original api_endpoint (e.g., &quot;chat/completions&quot;) will be used by the OpenAI client</span>
            <span class="n">transaction</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">api_endpoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_url</span>
        <span class="k">return</span> <span class="n">transaction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_policy_specific_config</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SerializableDict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return policy-specific configuration for backward compatibility with tests.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SerializableDict</span><span class="p">(</span>
            <span class="n">backend_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_url</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A policy that sets the backend URL for the transaction.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.core" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>core</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="luthien_control.core.dependencies" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>dependencies</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.core.dependencies.get_db_session" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.core.dependencies.get_db_session" class="doc-anchor"><code class="highlight language-python"><span class="n">get_db_session</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_dependencies</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/dependencies.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_db_session</span><span class="p">(</span>
    <span class="n">dependencies</span><span class="p">:</span> <span class="n">DependencyContainer</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_dependencies</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;FastAPI dependency to get an async database session using the container&#39;s factory.&quot;&quot;&quot;</span>
    <span class="n">session_factory</span> <span class="o">=</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">db_session_factory</span>
    <span class="k">if</span> <span class="n">session_factory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This shouldn&#39;t happen if the container is initialized correctly</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;DB Session Factory not found in DependencyContainer.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Internal server error: Database session factory not available.&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">session_factory</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">session</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># The session context manager should handle commit/close,</span>
            <span class="c1"># but rollback is explicit on exception.</span>
            <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>FastAPI dependency to get an async database session using the container's factory.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.core.dependencies.get_dependencies" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.core.dependencies.get_dependencies" class="doc-anchor"><code class="highlight language-python"><span class="n">get_dependencies</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/dependencies.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_dependencies</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DependencyContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dependency to retrieve the DependencyContainer from application state.&quot;&quot;&quot;</span>
    <span class="n">dependencies</span><span class="p">:</span> <span class="n">DependencyContainer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s2">&quot;dependencies&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dependencies</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span>
            <span class="s2">&quot;DependencyContainer not found in application state. &quot;</span>
            <span class="s2">&quot;This indicates a critical setup error in the application lifespan.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Internal server error: Application dependencies not initialized.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">dependencies</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Dependency to retrieve the DependencyContainer from application state.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.core.dependencies.get_main_control_policy" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.core.dependencies.get_main_control_policy" class="doc-anchor"><code class="highlight language-python"><span class="n">get_main_control_policy</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_dependencies</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/dependencies.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_main_control_policy</span><span class="p">(</span>
    <span class="n">dependencies</span><span class="p">:</span> <span class="n">DependencyContainer</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_dependencies</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ControlPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dependency to load and provide the main ControlPolicy instance.</span>

<span class="sd">    Uses the DependencyContainer to access settings, http_client, and a database session.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">settings</span>
    <span class="n">policy_filepath</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get_policy_filepath</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">policy_filepath</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading main control policy from file: </span><span class="si">{</span><span class="n">policy_filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">load_policy_from_file</span><span class="p">(</span><span class="n">policy_filepath</span><span class="p">)</span>

    <span class="n">top_level_policy_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get_top_level_policy_name</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">top_level_policy_name</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;TOP_LEVEL_POLICY_NAME is not configured in settings.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Internal server error: Control policy name not configured.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get a session using the container&#39;s factory - No longer needed here, load_policy_from_db handles it</span>
        <span class="c1"># async with session_factory() as session:</span>
        <span class="c1"># Pass the container directly to load_policy_from_db</span>
        <span class="n">main_policy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">load_policy_from_db</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">top_level_policy_name</span><span class="p">,</span>
            <span class="n">container</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span>  <span class="c1"># Pass the whole container</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">main_policy</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Main control policy &#39;</span><span class="si">{</span><span class="n">top_level_policy_name</span><span class="si">}</span><span class="s2">&#39; could not be loaded (not found or inactive).&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Internal server error: Main control policy &#39;</span><span class="si">{</span><span class="n">top_level_policy_name</span><span class="si">}</span><span class="s2">&#39; not found or inactive.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">main_policy</span>

    <span class="k">except</span> <span class="n">PolicyLoadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load main control policy &#39;</span><span class="si">{</span><span class="n">top_level_policy_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Internal server error: Could not load main control policy. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HTTPException</span><span class="p">:</span>  <span class="c1"># Re-raise HTTPExceptions from session creation</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error loading main control policy &#39;</span><span class="si">{</span><span class="n">top_level_policy_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Internal server error: Unexpected issue loading main control policy.&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Dependency to load and provide the main ControlPolicy instance.</p>
<p>Uses the DependencyContainer to access settings, http_client, and a database session.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.core.dependencies.initialize_app_dependencies" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.core.dependencies.initialize_app_dependencies" class="doc-anchor"><code class="highlight language-python"><span class="n">initialize_app_dependencies</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/dependencies.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">initialize_app_dependencies</span><span class="p">(</span><span class="n">app_settings</span><span class="p">:</span> <span class="n">Settings</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DependencyContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize and configure core application dependencies.</span>

<span class="sd">    This function sets up essential services required by the application,</span>
<span class="sd">    including an HTTP client and a database connection pool. It encapsulates</span>
<span class="sd">    the creation and configuration of these dependencies into a</span>
<span class="sd">    DependencyContainer instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        app_settings: The application settings instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A DependencyContainer instance populated with initialized dependencies.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If initialization of the HTTP client or database engine fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Initializing core application dependencies...&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize HTTP client</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Timeout</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">connect</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">read</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span> <span class="n">write</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>
    <span class="n">http_client</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HTTP Client initialized for DependencyContainer.&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize Database Engine and Session Factory</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to create main DB engine and session factory for DependencyContainer...&quot;</span><span class="p">)</span>
        <span class="n">_db_engine</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_db_engine</span><span class="p">()</span>  <span class="c1"># Uses app_settings implicitly via global settings instance</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Main DB engine successfully created for DependencyContainer.&quot;</span><span class="p">)</span>
        <span class="c1"># Use the actual session factory from database_async module</span>
        <span class="n">db_session_factory</span> <span class="o">=</span> <span class="n">db_get_session</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DB Session Factory reference obtained for DependencyContainer.&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">db_exc</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize database for DependencyContainer due to exception: </span><span class="si">{</span><span class="n">db_exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">http_client</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>  <span class="c1"># Clean up HTTP client</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HTTP client closed due to DB initialization failure.&quot;</span><span class="p">)</span>
        <span class="c1"># No need to call close_db_engine here, as db_engine might not be valid or fully initialized.</span>
        <span class="c1"># The caller (lifespan) will handle global engine cleanup if needed.</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to initialize database for DependencyContainer: </span><span class="si">{</span><span class="n">db_exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">db_exc</span>

    <span class="c1"># Create and return Dependency Container</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="n">DependencyContainer</span><span class="p">(</span>
            <span class="n">settings</span><span class="o">=</span><span class="n">app_settings</span><span class="p">,</span>
            <span class="n">http_client</span><span class="o">=</span><span class="n">http_client</span><span class="p">,</span>
            <span class="n">db_session_factory</span><span class="o">=</span><span class="n">db_session_factory</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Dependency Container created successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dependencies</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">container_exc</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create Dependency Container instance: </span><span class="si">{</span><span class="n">container_exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Clean up resources created within this helper function</span>
        <span class="k">await</span> <span class="n">http_client</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HTTP client closed due to Dependency Container instantiation failure.&quot;</span><span class="p">)</span>
        <span class="c1"># If db_engine was successfully created, it&#39;s now managed by the global close_db_engine,</span>
        <span class="c1"># which will be called by the lifespan&#39;s shutdown phase.</span>
        <span class="c1"># We don&#39;t call close_db_engine(db_engine_instance_if_any) here because the global one handles it.</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create Dependency Container instance: </span><span class="si">{</span><span class="n">container_exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">container_exc</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initialize and configure core application dependencies.</p>
<p>This function sets up essential services required by the application,
including an HTTP client and a database connection pool. It encapsulates
the creation and configuration of these dependencies into a
DependencyContainer instance.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app_settings</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Settings" href="#luthien_control.settings.Settings">Settings</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The application settings instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A DependencyContainer instance populated with initialized dependencies.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If initialization of the HTTP client or database engine fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.core.dependency_container" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>dependency_container</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.core.dependency_container.DependencyContainer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.core.dependency_container.DependencyContainer" class="doc-anchor"><code>DependencyContainer</code></a>


</h4>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/core/dependency_container.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DependencyContainer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Holds shared dependencies for the application.</span>

<span class="sd">    This class is responsible for holding all shared dependencies for the application.</span>
<span class="sd">    It is used to inject dependencies into the application and to make it easier to mock dependencies for testing.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">settings</span><span class="p">:</span> <span class="n">Settings</span><span class="p">,</span>
        <span class="n">http_client</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">,</span>
        <span class="n">db_session_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">AsyncContextManager</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the container.</span>

<span class="sd">        Args:</span>
<span class="sd">            settings: Application settings.</span>
<span class="sd">            http_client: Shared asynchronous HTTP client.</span>
<span class="sd">            db_session_factory: A factory function that returns an async context manager</span>
<span class="sd">                                yielding an SQLAlchemy AsyncSession.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_client</span> <span class="o">=</span> <span class="n">http_client</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_session_factory</span> <span class="o">=</span> <span class="n">db_session_factory</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_openai_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">openai</span><span class="o">.</span><span class="n">AsyncOpenAI</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an OpenAI client for the specified backend URL and API key.</span>

<span class="sd">        We include this factory here for the sake of consistency with other external dependencies.</span>
<span class="sd">        By maintaining all external dependencies in one place, we can easily mock them for testing</span>
<span class="sd">        and keep track of which parts of the application have external dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            base_url: The base URL for the OpenAI-compatible API endpoint.</span>
<span class="sd">            api_key: The API key for authentication.</span>

<span class="sd">        Returns:</span>
<span class="sd">            An configured OpenAI AsyncClient instance.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the base_url is missing or doesn&#39;t have a valid protocol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Base URL cannot be empty&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;http://&quot;</span><span class="p">,</span> <span class="s2">&quot;https://&quot;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base URL must start with &#39;http://&#39; or &#39;https://&#39;: </span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">openai</span><span class="o">.</span><span class="n">AsyncOpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Holds shared dependencies for the application.</p>
<p>This class is responsible for holding all shared dependencies for the application.
It is used to inject dependencies into the application and to make it easier to mock dependencies for testing.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.dependency_container.DependencyContainer.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.dependency_container.DependencyContainer.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="n">http_client</span><span class="p">,</span> <span class="n">db_session_factory</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/dependency_container.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">settings</span><span class="p">:</span> <span class="n">Settings</span><span class="p">,</span>
    <span class="n">http_client</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">AsyncClient</span><span class="p">,</span>
    <span class="n">db_session_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">AsyncContextManager</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initializes the container.</span>

<span class="sd">    Args:</span>
<span class="sd">        settings: Application settings.</span>
<span class="sd">        http_client: Shared asynchronous HTTP client.</span>
<span class="sd">        db_session_factory: A factory function that returns an async context manager</span>
<span class="sd">                            yielding an SQLAlchemy AsyncSession.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">http_client</span> <span class="o">=</span> <span class="n">http_client</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">db_session_factory</span> <span class="o">=</span> <span class="n">db_session_factory</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initializes the container.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>settings</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    Settings" href="#luthien_control.settings.Settings">Settings</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Application settings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>http_client</code>
            </td>
            <td>
                  <code><span title="httpx.AsyncClient">AsyncClient</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shared asynchronous HTTP client.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>db_session_factory</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[], <span title="typing.AsyncContextManager">AsyncContextManager</span>[<span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A factory function that returns an async context manager
                yielding an SQLAlchemy AsyncSession.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.dependency_container.DependencyContainer.create_openai_client" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.dependency_container.DependencyContainer.create_openai_client" class="doc-anchor"><code class="highlight language-python"><span class="n">create_openai_client</span><span class="p">(</span><span class="n">base_url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/dependency_container.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_openai_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">openai</span><span class="o">.</span><span class="n">AsyncOpenAI</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an OpenAI client for the specified backend URL and API key.</span>

<span class="sd">    We include this factory here for the sake of consistency with other external dependencies.</span>
<span class="sd">    By maintaining all external dependencies in one place, we can easily mock them for testing</span>
<span class="sd">    and keep track of which parts of the application have external dependencies.</span>

<span class="sd">    Args:</span>
<span class="sd">        base_url: The base URL for the OpenAI-compatible API endpoint.</span>
<span class="sd">        api_key: The API key for authentication.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An configured OpenAI AsyncClient instance.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the base_url is missing or doesn&#39;t have a valid protocol.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Base URL cannot be empty&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">base_url</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;http://&quot;</span><span class="p">,</span> <span class="s2">&quot;https://&quot;</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Base URL must start with &#39;http://&#39; or &#39;https://&#39;: </span><span class="si">{</span><span class="n">base_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">openai</span><span class="o">.</span><span class="n">AsyncOpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="n">base_url</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Creates an OpenAI client for the specified backend URL and API key.</p>
<p>We include this factory here for the sake of consistency with other external dependencies.
By maintaining all external dependencies in one place, we can easily mock them for testing
and keep track of which parts of the application have external dependencies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>base_url</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The base URL for the OpenAI-compatible API endpoint.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>api_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The API key for authentication.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="openai.AsyncOpenAI">AsyncOpenAI</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An configured OpenAI AsyncClient instance.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the base_url is missing or doesn't have a valid protocol.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.core.generic_events" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>generic_events</code>


</h3>

    <div class="doc doc-contents ">

        <p>Generic event system with type-safe event dispatching.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.core.generic_events.Event" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.core.generic_events.Event" class="doc-anchor"><code>Event</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="typing.Generic">Generic</span>[<span title="luthien_control.core.generic_events.T">T</span>]</code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/core/generic_events.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Event</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">T</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A generic event that maintains a named registry of typed event listeners to be dispatched on demand.</span>


<span class="sd">    Typical usage:</span>
<span class="sd">        start_policy_event = LuthienEventType(&quot;start_policy&quot;)</span>
<span class="sd">        event: Event[dict] = Event[dict](start_policy_event)</span>
<span class="sd">        data = {&quot;foo&quot;: &quot;bar&quot;}</span>
<span class="sd">        def listener_1(event_type, data):</span>
<span class="sd">            print(f&quot;Listener 1 received event: {event_type} {data}&quot;)</span>
<span class="sd">        def listener_2(event_type, data):</span>
<span class="sd">            print(f&quot;Listener 2 received event: {event_type} {data}&quot;)</span>

<span class="sd">        event.register(&quot;listener_1&quot;, listener_1)</span>
<span class="sd">        event.register(&quot;listener_2&quot;, listener_2)</span>
<span class="sd">        event.dispatch(data)  # Listener 1 and 2 will receive the event</span>
<span class="sd">        event.unregister(&quot;listener_1&quot;)</span>
<span class="sd">        event.dispatch(data)  # Listener 2 will receive the event</span>

<span class="sd">    Type Parameters:</span>
<span class="sd">        T: The type of data that will be passed to event listeners</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize an event with no registered listeners.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_type: The type of event this observer is for</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_type</span> <span class="o">=</span> <span class="n">event_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EventListener</span><span class="p">[</span><span class="n">T</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">listener</span><span class="p">:</span> <span class="n">EventListener</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register a named observer.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: Unique identifier for this listener</span>
<span class="sd">            listener: Callable that accepts an argument of type T</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">listener</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a registered observer by name.</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The name of the listener to remove</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If no listener with the given name exists</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispatch the event to all registered observers.</span>

<span class="sd">        Args:</span>
<span class="sd">            data: The data of type T to pass to all listeners</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">listener</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">listener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_type</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error dispatching event to listener </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">listener_count</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of registered listeners.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_listeners</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EventListener</span><span class="p">[</span><span class="n">T</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a *copy* of the registered listeners dictionary.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A copy of the listeners registry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A generic event that maintains a named registry of typed event listeners to be dispatched on demand.</p>


<details class="typical-usage" open>
  <summary>Typical usage</summary>
  <p>start_policy_event = LuthienEventType("start_policy")
event: Event[dict] = Event<a href="start_policy_event">dict</a>
data = {"foo": "bar"}
def listener_1(event_type, data):
    print(f"Listener 1 received event: {event_type} {data}")
def listener_2(event_type, data):
    print(f"Listener 2 received event: {event_type} {data}")</p>
<p>event.register("listener_1", listener_1)
event.register("listener_2", listener_2)
event.dispatch(data)  # Listener 1 and 2 will receive the event
event.unregister("listener_1")
event.dispatch(data)  # Listener 2 will receive the event</p>
</details>

<details class="type-parameters" open>
  <summary>Type Parameters</summary>
  <p>T: The type of data that will be passed to event listeners</p>
</details>








  <div class="doc doc-children">





<h5 id="luthien_control.core.generic_events.Event.listener_count" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>
</h5>
        <p>Return the number of registered listeners.</p>



<div class="doc doc-object doc-attribute">



<h5 id="luthien_control.core.generic_events.Event.listener_count" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">listener_count</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Return the number of registered listeners.</p>

    </div>

</div>

  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.generic_events.Event.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.generic_events.Event.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">event_type</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/generic_events.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize an event with no registered listeners.</span>

<span class="sd">    Args:</span>
<span class="sd">        event_type: The type of event this observer is for</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_event_type</span> <span class="o">=</span> <span class="n">event_type</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EventListener</span><span class="p">[</span><span class="n">T</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initialize an event with no registered listeners.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>event_type</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The type of event this observer is for</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.generic_events.Event.dispatch" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.generic_events.Event.dispatch" class="doc-anchor"><code class="highlight language-python"><span class="n">dispatch</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/generic_events.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dispatch the event to all registered observers.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: The data of type T to pass to all listeners</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">listener</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">listener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_event_type</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error dispatching event to listener </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Dispatch the event to all registered observers.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="luthien_control.core.generic_events.T">T</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The data of type T to pass to all listeners</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.generic_events.Event.get_listeners" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.generic_events.Event.get_listeners" class="doc-anchor"><code class="highlight language-python"><span class="n">get_listeners</span><span class="p">()</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/generic_events.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_listeners</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">EventListener</span><span class="p">[</span><span class="n">T</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a *copy* of the registered listeners dictionary.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A copy of the listeners registry</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Return a <em>copy</em> of the registered listeners dictionary.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="luthien_control.core.generic_events.EventListener">EventListener</span>[<span title="luthien_control.core.generic_events.T">T</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A copy of the listeners registry</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.generic_events.Event.register" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.generic_events.Event.register" class="doc-anchor"><code class="highlight language-python"><span class="n">register</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">listener</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/generic_events.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">listener</span><span class="p">:</span> <span class="n">EventListener</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register a named observer.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Unique identifier for this listener</span>
<span class="sd">        listener: Callable that accepts an argument of type T</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">listener</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Register a named observer.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for this listener</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>listener</code>
            </td>
            <td>
                  <code><span title="luthien_control.core.generic_events.EventListener">EventListener</span>[<span title="luthien_control.core.generic_events.T">T</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Callable that accepts an argument of type T</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.generic_events.Event.unregister" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.generic_events.Event.unregister" class="doc-anchor"><code class="highlight language-python"><span class="n">unregister</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/generic_events.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">unregister</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove a registered observer by name.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the listener to remove</span>

<span class="sd">    Raises:</span>
<span class="sd">        KeyError: If no listener with the given name exists</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_listeners</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Remove a registered observer by name.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the listener to remove</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="KeyError">KeyError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If no listener with the given name exists</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.core.logging" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>logging</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.core.logging.setup_logging" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.core.logging.setup_logging" class="doc-anchor"><code class="highlight language-python"><span class="n">setup_logging</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/logging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">setup_logging</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configures logging for the application.</span>

<span class="sd">    Reads the desired log level from the LOG_LEVEL environment variable.</span>
<span class="sd">    Defaults to INFO if not set or invalid.</span>
<span class="sd">    Sets a standard format and directs logs to stderr.</span>
<span class="sd">    Sets louder libraries to WARNING level.</span>
<span class="sd">    Optionally configures Loki handler if LOKI_URL is set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
    <span class="n">log_level_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get_log_level</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_LOG_LEVEL</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">log_level_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">VALID_LOG_LEVELS</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;WARNING: Invalid LOG_LEVEL &#39;</span><span class="si">{</span><span class="n">log_level_name</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Defaulting to </span><span class="si">{</span><span class="n">DEFAULT_LOG_LEVEL</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Valid levels are: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">VALID_LOG_LEVELS</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">log_level_name</span> <span class="o">=</span> <span class="n">DEFAULT_LOG_LEVEL</span>

    <span class="n">log_level</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLevelName</span><span class="p">(</span><span class="n">log_level_name</span><span class="p">)</span>

    <span class="c1"># Configure root logger</span>
    <span class="n">root_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
    <span class="n">root_logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>

    <span class="c1"># Clear any existing handlers</span>
    <span class="n">root_logger</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="c1"># Console handler</span>
    <span class="n">console_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">console_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">LOG_FORMAT</span><span class="p">))</span>
    <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console_handler</span><span class="p">)</span>

    <span class="c1"># Loki handler if configured</span>
    <span class="n">loki_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOKI_URL&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loki_url</span><span class="p">:</span>
        <span class="n">loki_handler</span> <span class="o">=</span> <span class="n">_get_loki_handler</span><span class="p">(</span><span class="n">loki_url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">loki_handler</span><span class="p">:</span>
            <span class="n">root_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">loki_handler</span><span class="p">)</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loki logging configured for </span><span class="si">{</span><span class="n">loki_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Quiet down noisy libraries</span>
    <span class="k">for</span> <span class="n">lib_name</span> <span class="ow">in</span> <span class="n">NOISY_LIBRARIES</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">lib_name</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

    <span class="c1"># Log that configuration is complete (useful for debugging setup issues)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Logging configured with level </span><span class="si">{</span><span class="n">log_level_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Configures logging for the application.</p>
<p>Reads the desired log level from the LOG_LEVEL environment variable.
Defaults to INFO if not set or invalid.
Sets a standard format and directs logs to stderr.
Sets louder libraries to WARNING level.
Optionally configures Loki handler if LOKI_URL is set.</p>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.core.request" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>request</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.core.request.Request" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.core.request.Request" class="doc-anchor"><code>Request</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/core/request.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Request</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A request to the Luthien Control API.&quot;&quot;&quot;</span>

    <span class="n">payload</span><span class="p">:</span> <span class="n">OpenAIChatCompletionsRequest</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">api_endpoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">api_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A request to the Luthien Control API.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.core.response" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>response</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.core.response.Response" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.core.response.Response" class="doc-anchor"><code>Response</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/core/response.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Response</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A response from the Luthien Control API.&quot;&quot;&quot;</span>

    <span class="n">payload</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">OpenAIChatCompletionsResponse</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">api_endpoint</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A response from the Luthien Control API.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.core.tracked_context" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>tracked_context</code>


</h3>

    <div class="doc doc-contents ">

        <p>TrackedContext module with explicit mutation API and event tracking.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.core.tracked_context.TrackedContext" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.core.tracked_context.TrackedContext" class="doc-anchor"><code>TrackedContext</code></a>


</h4>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TrackedContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transaction context with explicit mutation API and event tracking.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize tracked context.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span> <span class="o">=</span> <span class="n">transaction_id</span> <span class="ow">or</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">ContextEvents</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">transaction_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get transaction ID.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">from_scratch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_existing_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create or set the request.&quot;&quot;&quot;</span>
        <span class="n">differences</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">from_scratch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Attempted to create new request, but method and url are required&quot;</span><span class="p">)</span>
            <span class="n">method</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
            <span class="n">differences</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">k</span><span class="p">)}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header_diffs</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="p">)</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header_diffs</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">content</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
            <span class="n">MutationEventPayload</span><span class="p">(</span>
                <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_request&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="n">differences</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a copy of the tracked request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">status_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">from_scratch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_existing_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the response.&quot;&quot;&quot;</span>
        <span class="n">differences</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">from_scratch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">status_code</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Attempted to create new response, but status_code is required&quot;</span><span class="p">)</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">differences</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">,</span> <span class="n">k</span><span class="p">)}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">status_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;status_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
            <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">content</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
            <span class="n">MutationEventPayload</span><span class="p">(</span>
                <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_response&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="n">differences</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a copy of the tracked response.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set data value.&quot;&quot;&quot;</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
            <span class="n">MutationEventPayload</span><span class="p">(</span>
                <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_data&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;old_value&quot;</span><span class="p">:</span> <span class="n">old_value</span><span class="p">,</span> <span class="s2">&quot;new_value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get copy of all data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Transaction context with explicit mutation API and event tracking.</p>









  <div class="doc doc-children">





<h5 id="luthien_control.core.tracked_context.TrackedContext.request" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>
</h5>
        <p>Get a copy of the tracked request.</p>



<div class="doc doc-object doc-attribute">



<h5 id="luthien_control.core.tracked_context.TrackedContext.request" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">request</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Get a copy of the tracked request.</p>

    </div>

</div><h5 id="luthien_control.core.tracked_context.TrackedContext.response" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>
</h5>
        <p>Get a copy of the tracked response.</p>



<div class="doc doc-object doc-attribute">



<h5 id="luthien_control.core.tracked_context.TrackedContext.response" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">response</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Get a copy of the tracked response.</p>

    </div>

</div><h5 id="luthien_control.core.tracked_context.TrackedContext.transaction_id" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>
</h5>
        <p>Get transaction ID.</p>



<div class="doc doc-object doc-attribute">



<h5 id="luthien_control.core.tracked_context.TrackedContext.transaction_id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">transaction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Get transaction ID.</p>

    </div>

</div>

  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.tracked_context.TrackedContext.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.TrackedContext.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">transaction_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize tracked context.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span> <span class="o">=</span> <span class="n">transaction_id</span> <span class="ow">or</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">ContextEvents</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initialize tracked context.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.tracked_context.TrackedContext.get_all_data" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.TrackedContext.get_all_data" class="doc-anchor"><code class="highlight language-python"><span class="n">get_all_data</span><span class="p">()</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_all_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get copy of all data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get copy of all data.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.tracked_context.TrackedContext.get_data" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.TrackedContext.get_data" class="doc-anchor"><code class="highlight language-python"><span class="n">get_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get data value.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get data value.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.tracked_context.TrackedContext.set_data" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.TrackedContext.set_data" class="doc-anchor"><code class="highlight language-python"><span class="n">set_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set data value.&quot;&quot;&quot;</span>
    <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
        <span class="n">MutationEventPayload</span><span class="p">(</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_data&quot;</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;old_value&quot;</span><span class="p">:</span> <span class="n">old_value</span><span class="p">,</span> <span class="s2">&quot;new_value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Set data value.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.tracked_context.TrackedContext.update_request" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.TrackedContext.update_request" class="doc-anchor"><code class="highlight language-python"><span class="n">update_request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_request</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">from_scratch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">preserve_existing_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create or set the request.&quot;&quot;&quot;</span>
    <span class="n">differences</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">from_scratch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Attempted to create new request, but method and url are required&quot;</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
        <span class="n">differences</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">k</span><span class="p">)}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header_diffs</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="p">)</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header_diffs</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">content</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
        <span class="n">MutationEventPayload</span><span class="p">(</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_request&quot;</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="n">differences</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create or set the request.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.tracked_context.TrackedContext.update_response" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.TrackedContext.update_response" class="doc-anchor"><code class="highlight language-python"><span class="n">update_response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_response</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">status_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">from_scratch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">preserve_existing_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the response.&quot;&quot;&quot;</span>
    <span class="n">differences</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">from_scratch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_code</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Attempted to create new response, but status_code is required&quot;</span><span class="p">)</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">differences</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">,</span> <span class="n">k</span><span class="p">)}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;status_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">content</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
        <span class="n">MutationEventPayload</span><span class="p">(</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_response&quot;</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="n">differences</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Update the response.</p>


    </div>

</div>



  </div>


    </div>

</div>
  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.core.tracked_context.get_tx_value" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.core.tracked_context.get_tx_value" class="doc-anchor"><code class="highlight language-python"><span class="n">get_tx_value</span><span class="p">(</span><span class="n">tracked_context</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/util.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_tx_value</span><span class="p">(</span><span class="n">tracked_context</span><span class="p">:</span> <span class="n">TrackedContext</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a value from the tracked context using a path.</span>

<span class="sd">    Args:</span>
<span class="sd">        tracked_context: The tracked context.</span>
<span class="sd">        path: The path to the value e.g. &quot;request.headers.user-agent&quot;, &quot;response.status_code&quot;, &quot;data.user_id&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The value at the path.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the path is invalid or the value cannot be accessed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Path must contain at least two components&quot;</span><span class="p">)</span>

    <span class="c1"># Handle the first segment specially for TrackedContext</span>
    <span class="n">first_segment</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">first_segment</span> <span class="o">==</span> <span class="s2">&quot;request&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tracked_context</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Request is None in tracked context&quot;</span><span class="p">)</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">tracked_context</span><span class="o">.</span><span class="n">request</span>
    <span class="k">elif</span> <span class="n">first_segment</span> <span class="o">==</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tracked_context</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Response is None in tracked context&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tracked_context</span><span class="o">.</span><span class="n">response</span>
    <span class="k">elif</span> <span class="n">first_segment</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tracked_context</span><span class="o">.</span><span class="n">get_all_data</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid path segment: </span><span class="si">{</span><span class="n">first_segment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">next_segment</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Wrapping the original error for better diagnostics</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decode JSON content for path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; at segment &#39;</span><span class="si">{</span><span class="n">next_segment</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">next_segment</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">next_segment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a value from the tracked context using a path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tracked_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    TrackedContext" href="#luthien_control.core.tracked_context.tracked_context.TrackedContext">TrackedContext</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tracked context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the value e.g. "request.headers.user-agent", "response.status_code", "data.user_id".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value at the path.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path is invalid or the value cannot be accessed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>


<div class="doc doc-object doc-module">



<h4 id="luthien_control.core.tracked_context.tracked_context" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>tracked_context</code>


</h4>

    <div class="doc doc-contents ">

        <p>TrackedContext with explicit mutation API and event tracking.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.core.tracked_context.tracked_context.MutationEventPayload" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.core.tracked_context.tracked_context.MutationEventPayload" class="doc-anchor"><code>MutationEventPayload</code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MutationEventPayload</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Record of an explicit mutation.&quot;&quot;&quot;</span>

    <span class="n">transaction_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]</span>
    <span class="n">operation</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># e.g., &quot;set_header&quot;, &quot;set_response_status&quot;</span>
    <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Record of an explicit mutation.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h5 id="luthien_control.core.tracked_context.tracked_context.TrackedContext" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext" class="doc-anchor"><code>TrackedContext</code></a>


</h5>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TrackedContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Transaction context with explicit mutation API and event tracking.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize tracked context.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span> <span class="o">=</span> <span class="n">transaction_id</span> <span class="ow">or</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">ContextEvents</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">transaction_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get transaction ID.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">from_scratch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_existing_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create or set the request.&quot;&quot;&quot;</span>
        <span class="n">differences</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">from_scratch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Attempted to create new request, but method and url are required&quot;</span><span class="p">)</span>
            <span class="n">method</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
            <span class="n">differences</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">k</span><span class="p">)}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
            <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">header_diffs</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="p">)</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header_diffs</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">content</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
            <span class="n">MutationEventPayload</span><span class="p">(</span>
                <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_request&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="n">differences</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a copy of the tracked request.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">status_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">from_scratch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">preserve_existing_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the response.&quot;&quot;&quot;</span>
        <span class="n">differences</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">from_scratch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">status_code</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Attempted to create new response, but status_code is required&quot;</span><span class="p">)</span>
            <span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span>
                <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">differences</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">,</span> <span class="n">k</span><span class="p">)}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">status_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;status_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
            <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">content</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
            <span class="n">MutationEventPayload</span><span class="p">(</span>
                <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_response&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="n">differences</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">response</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get a copy of the tracked response.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get data value.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set data value.&quot;&quot;&quot;</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
            <span class="n">MutationEventPayload</span><span class="p">(</span>
                <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
                <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_data&quot;</span><span class="p">,</span>
                <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;old_value&quot;</span><span class="p">:</span> <span class="n">old_value</span><span class="p">,</span> <span class="s2">&quot;new_value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">},</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_all_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get copy of all data.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Transaction context with explicit mutation API and event tracking.</p>









  <div class="doc doc-children">





<h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.request" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>
</h6>
        <p>Get a copy of the tracked request.</p>



<div class="doc doc-object doc-attribute">



<h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.request" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">request</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <p>Get a copy of the tracked request.</p>

    </div>

</div><h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.response" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>
</h6>
        <p>Get a copy of the tracked response.</p>



<div class="doc doc-object doc-attribute">



<h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.response" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">response</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <p>Get a copy of the tracked response.</p>

    </div>

</div><h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.transaction_id" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>
</h6>
        <p>Get transaction ID.</p>



<div class="doc doc-object doc-attribute">



<h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.transaction_id" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">transaction_id</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h6>


    <div class="doc doc-contents ">

        <p>Get transaction ID.</p>

    </div>

</div>

  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">transaction_id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize tracked context.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span> <span class="o">=</span> <span class="n">transaction_id</span> <span class="ow">or</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">ContextEvents</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initialize tracked context.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.get_all_data" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.get_all_data" class="doc-anchor"><code class="highlight language-python"><span class="n">get_all_data</span><span class="p">()</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_all_data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get copy of all data.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get copy of all data.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.get_data" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.get_data" class="doc-anchor"><code class="highlight language-python"><span class="n">get_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get data value.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get data value.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.set_data" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.set_data" class="doc-anchor"><code class="highlight language-python"><span class="n">set_data</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set data value.&quot;&quot;&quot;</span>
    <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
        <span class="n">MutationEventPayload</span><span class="p">(</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_data&quot;</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">key</span><span class="p">,</span> <span class="s2">&quot;old_value&quot;</span><span class="p">:</span> <span class="n">old_value</span><span class="p">,</span> <span class="s2">&quot;new_value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">},</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Set data value.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.update_request" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.update_request" class="doc-anchor"><code class="highlight language-python"><span class="n">update_request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_request</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">from_scratch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">preserve_existing_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create or set the request.&quot;&quot;&quot;</span>
    <span class="n">differences</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">from_scratch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Attempted to create new request, but method and url are required&quot;</span><span class="p">)</span>
        <span class="n">method</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_request</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">)</span>
        <span class="n">differences</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">k</span><span class="p">)}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;url&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">method</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">if</span> <span class="n">url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">URL</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header_diffs</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="p">)</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header_diffs</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_request</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">content</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
        <span class="n">MutationEventPayload</span><span class="p">(</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_request&quot;</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="n">differences</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create or set the request.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h6 id="luthien_control.core.tracked_context.tracked_context.TrackedContext.update_response" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.core.tracked_context.tracked_context.TrackedContext.update_response" class="doc-anchor"><code class="highlight language-python"><span class="n">update_response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">from_scratch</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code></a>


</h6>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/tracked_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">update_response</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">status_code</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">content</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">from_scratch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">preserve_existing_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the response.&quot;&quot;&quot;</span>
    <span class="n">differences</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">from_scratch</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_code</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Attempted to create new response, but status_code is required&quot;</span><span class="p">)</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">status_code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">differences</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">,</span> <span class="n">k</span><span class="p">)}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="s2">&quot;headers&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">]</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">status_code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;status_code&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">status_code</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">status_code</span>
        <span class="k">if</span> <span class="n">headers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;headers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_update_headers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">preserve_existing_headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">differences</span><span class="p">[</span><span class="s2">&quot;content&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response</span><span class="o">.</span><span class="n">_content</span> <span class="o">=</span> <span class="n">content</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">mutation</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span>
        <span class="n">MutationEventPayload</span><span class="p">(</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_transaction_id</span><span class="p">,</span>
            <span class="n">operation</span><span class="o">=</span><span class="s2">&quot;set_response&quot;</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="n">differences</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Update the response.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h4 id="luthien_control.core.tracked_context.util" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>util</code>


</h4>

    <div class="doc doc-contents ">

        <p>Utilities for working with TrackedContext.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.core.tracked_context.util.get_tx_value" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.core.tracked_context.util.get_tx_value" class="doc-anchor"><code class="highlight language-python"><span class="n">get_tx_value</span><span class="p">(</span><span class="n">tracked_context</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/tracked_context/util.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_tx_value</span><span class="p">(</span><span class="n">tracked_context</span><span class="p">:</span> <span class="n">TrackedContext</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a value from the tracked context using a path.</span>

<span class="sd">    Args:</span>
<span class="sd">        tracked_context: The tracked context.</span>
<span class="sd">        path: The path to the value e.g. &quot;request.headers.user-agent&quot;, &quot;response.status_code&quot;, &quot;data.user_id&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The value at the path.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the path is invalid or the value cannot be accessed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Path must contain at least two components&quot;</span><span class="p">)</span>

    <span class="c1"># Handle the first segment specially for TrackedContext</span>
    <span class="n">first_segment</span> <span class="o">=</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">first_segment</span> <span class="o">==</span> <span class="s2">&quot;request&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tracked_context</span><span class="o">.</span><span class="n">request</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Request is None in tracked context&quot;</span><span class="p">)</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">tracked_context</span><span class="o">.</span><span class="n">request</span>
    <span class="k">elif</span> <span class="n">first_segment</span> <span class="o">==</span> <span class="s2">&quot;response&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tracked_context</span><span class="o">.</span><span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Response is None in tracked context&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tracked_context</span><span class="o">.</span><span class="n">response</span>
    <span class="k">elif</span> <span class="n">first_segment</span> <span class="o">==</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">tracked_context</span><span class="o">.</span><span class="n">get_all_data</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid path segment: </span><span class="si">{</span><span class="n">first_segment</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">next_segment</span> <span class="ow">in</span> <span class="n">vals</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># Wrapping the original error for better diagnostics</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decode JSON content for path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; at segment &#39;</span><span class="si">{</span><span class="n">next_segment</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">next_segment</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">next_segment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a value from the tracked context using a path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>tracked_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    TrackedContext" href="#luthien_control.core.tracked_context.tracked_context.TrackedContext">TrackedContext</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tracked context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the value e.g. "request.headers.user-agent", "response.status_code", "data.user_id".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value at the path.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path is invalid or the value cannot be accessed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.core.transaction" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>transaction</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.core.transaction.Transaction" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.core.transaction.Transaction" class="doc-anchor"><code>Transaction</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    DeepEventedModel" href="#luthien_control.utils.DeepEventedModel">DeepEventedModel</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/core/transaction.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Transaction</span><span class="p">(</span><span class="n">DeepEventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A transaction between the Luthien Control API and the client.&quot;&quot;&quot;</span>

    <span class="n">transaction_id</span><span class="p">:</span> <span class="n">UUID</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">uuid4</span><span class="p">)</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Response</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">EventedDict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">EventedDict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A transaction between the Luthien Control API and the client.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.core.transaction_context" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>transaction_context</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.core.transaction_context.TransactionContext" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.core.transaction_context.TransactionContext" class="doc-anchor"><code>TransactionContext</code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/core/transaction_context.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TransactionContext</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Holds the state for a single transaction through the proxy.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        transaction_id: A unique identifier for the transaction.</span>
<span class="sd">        request: The incoming HTTP request object.</span>
<span class="sd">        response: The outgoing HTTP response object.</span>
<span class="sd">        data: A general-purpose dictionary for policies to store and share</span>
<span class="sd">            information related to this transaction.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Core Identifiers and State</span>
    <span class="n">transaction_id</span><span class="p">:</span> <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">)</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Request</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Response</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># General purpose data store for policies to share information</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Holds the state for a single transaction through the proxy.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.core.transaction_context.TransactionContext.transaction_id">transaction_id</span></code></td>
            <td>
                  <code><span title="uuid.UUID">UUID</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A unique identifier for the transaction.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.core.transaction_context.TransactionContext.request">request</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="httpx.Request">Request</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The incoming HTTP request object.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.core.transaction_context.TransactionContext.response">response</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="httpx.Response">Response</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The outgoing HTTP response object.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.core.transaction_context.TransactionContext.data">data</span></code></td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A general-purpose dictionary for policies to store and share
information related to this transaction.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">











  </div>


    </div>

</div>
  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.core.transaction_context.get_tx_value" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.core.transaction_context.get_tx_value" class="doc-anchor"><code class="highlight language-python"><span class="n">get_tx_value</span><span class="p">(</span><span class="n">transaction_context</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/core/transaction_context.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_tx_value</span><span class="p">(</span><span class="n">transaction_context</span><span class="p">:</span> <span class="n">TransactionContext</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a value from the transaction context using a path.</span>

<span class="sd">    Args:</span>
<span class="sd">        transaction_context: The transaction context.</span>
<span class="sd">        path: The path to the value e.g. &quot;request.headers.user-agent&quot;, &quot;response.status_code&quot;, &quot;data.user_id&quot;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The value at the path.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the path is invalid or the value cannot be accessed.</span>
<span class="sd">        TypeError: If the transaction_id is not a UUID.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vals</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Path must contain at least two components&quot;</span><span class="p">)</span>

    <span class="n">x</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">transaction_context</span><span class="p">,</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">while</span> <span class="n">vals</span><span class="p">:</span>
        <span class="c1"># If x is bytes, and we still have path segments to process,</span>
        <span class="c1"># it implies these segments are keys into the JSON content.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="ow">and</span> <span class="n">vals</span><span class="p">:</span>  <span class="c1"># Check if vals is not empty</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">vals</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">x</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a value from the transaction context using a path.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>transaction_context</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    TransactionContext


  
      dataclass
  " href="#luthien_control.core.transaction_context.TransactionContext">TransactionContext</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The transaction context.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the value e.g. "request.headers.user-agent", "response.status_code", "data.user_id".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value at the path.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the path is invalid or the value cannot be accessed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="TypeError">TypeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the transaction_id is not a UUID.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.custom_openapi_schema" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>custom_openapi_schema</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h3 id="luthien_control.custom_openapi_schema.create_custom_openapi" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.custom_openapi_schema.create_custom_openapi" class="doc-anchor"><code class="highlight language-python"><span class="n">create_custom_openapi</span><span class="p">(</span><span class="n">app</span><span class="p">)</span></code></a>


</h3>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/custom_openapi_schema.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_custom_openapi</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate a custom OpenAPI schema for the FastAPI application.</span>

<span class="sd">    This function retrieves the default schema and modifies it, specifically</span>
<span class="sd">    to set `allowReserved=True` for the `full_path` path parameter used</span>
<span class="sd">    in proxy routes. This is necessary for correctly handling URLs containing</span>
<span class="sd">    reserved characters within that path segment.</span>

<span class="sd">    Args:</span>
<span class="sd">        app: The FastAPI application instance.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The modified OpenAPI schema dictionary.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check if schema already exists to avoid redundant generation</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">openapi_schema</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">openapi_schema</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Generating custom OpenAPI schema.&quot;</span><span class="p">)</span>
    <span class="n">openapi_schema</span> <span class="o">=</span> <span class="n">get_openapi</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">routes</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">routes</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Modify the schema for the path parameter</span>
    <span class="n">paths</span> <span class="o">=</span> <span class="n">openapi_schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;paths&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> paths in schema. Searching for &#39;</span><span class="se">{{</span><span class="s2">full_path</span><span class="se">}}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">path_key</span><span class="p">,</span> <span class="n">path_item</span> <span class="ow">in</span> <span class="n">paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s2">&quot;</span><span class="si">{full_path}</span><span class="s2">&quot;</span> <span class="ow">in</span> <span class="n">path_key</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing path: </span><span class="si">{</span><span class="n">path_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># path_item contains methods like &#39;get&#39;, &#39;post&#39;, etc.</span>
            <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">method_item</span> <span class="ow">in</span> <span class="n">path_item</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Ensure &#39;parameters&#39; exists and is a list</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="n">method_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected &#39;parameters&#39; format in </span><span class="si">{</span><span class="n">path_key</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>

                <span class="n">found_param</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                    <span class="c1"># Ensure param is a dictionary and has &#39;name&#39; and &#39;in&#39; keys</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span> <span class="ow">or</span> <span class="s2">&quot;in&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Malformed parameter definition in </span><span class="si">{</span><span class="n">path_key</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">. Skipping param: </span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;full_path&quot;</span> <span class="ow">and</span> <span class="n">param</span><span class="p">[</span><span class="s2">&quot;in&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;path&quot;</span><span class="p">:</span>
                        <span class="n">param</span><span class="p">[</span><span class="s2">&quot;allowReserved&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">found_param</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set allowReserved=true for &#39;full_path&#39; parameter in </span><span class="si">{</span><span class="n">path_key</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="c1"># Assuming only one &#39;full_path&#39; param per method</span>
                        <span class="k">break</span>  <span class="c1"># No need to check other params for this method</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">found_param</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;full_path&#39; path parameter found in </span><span class="si">{</span><span class="n">path_key</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Cache the generated schema in the app instance</span>
    <span class="n">app</span><span class="o">.</span><span class="n">openapi_schema</span> <span class="o">=</span> <span class="n">openapi_schema</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Custom OpenAPI schema generation complete.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">app</span><span class="o">.</span><span class="n">openapi_schema</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Generate a custom OpenAPI schema for the FastAPI application.</p>
<p>This function retrieves the default schema and modifies it, specifically
to set <code>allowReserved=True</code> for the <code>full_path</code> path parameter used
in proxy routes. This is necessary for correctly handling URLs containing
reserved characters within that path segment.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app</code>
            </td>
            <td>
                  <code><span title="fastapi.FastAPI">FastAPI</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The FastAPI application instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The modified OpenAPI schema dictionary.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.db" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>db</code>


</h2>

    <div class="doc doc-contents ">

        <p>Database models and session management.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h3 id="luthien_control.db.ControlPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.ControlPolicy" class="doc-anchor"><code>ControlPolicy</code></a>


</h3>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="sqlmodel.SQLModel">SQLModel</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ControlPolicy</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;policies&quot;</span>  <span class="c1"># type: ignore (again, shut up pyright)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Database model for storing control policy configurations.&quot;&quot;&quot;</span>

    <span class="c1"># Primary key</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># --- Core Fields ---</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Unique name used for lookup</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>  <span class="c1"># Type of policy, used for instantiation</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">{},</span> <span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">JSON</span><span class="p">))</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># --- Timestamps ---</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">updated_at</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="c1"># Ensure timestamps are set on creation if not provided</span>
        <span class="k">if</span> <span class="s2">&quot;created_at&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;updated_at&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_timestamps</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure updated_at is always set/updated.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>
</code></pre></div></td></tr></table></div>
          </details>










  <div class="doc doc-children">





<h4 id="luthien_control.db.ControlPolicy.__tablename__" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>
</h4>
        <p>Database model for storing control policy configurations.</p>



<div class="doc doc-object doc-attribute">



<h4 id="luthien_control.db.ControlPolicy.__tablename__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;policies&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Database model for storing control policy configurations.</p>

    </div>

</div>

  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.ControlPolicy.validate_timestamps" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.db.ControlPolicy.validate_timestamps" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_timestamps</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_timestamps</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure updated_at is always set/updated.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">values</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Ensure updated_at is always set/updated.</p>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h3 id="luthien_control.db.LuthienLog" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.LuthienLog" class="doc-anchor"><code>LuthienLog</code></a>


</h3>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="sqlmodel.SQLModel">SQLModel</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuthienLog</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a log entry in the Luthien logging system using SQLModel.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique identifier for the log entry (primary key).</span>
<span class="sd">        transaction_id: Identifier to group related log entries.</span>
<span class="sd">        datetime: Timestamp indicating when the log entry was generated (timezone-aware).</span>
<span class="sd">        data: JSON blob containing the primary logged data.</span>
<span class="sd">        datatype: String identifier for the nature and schema of &#39;data&#39;.</span>
<span class="sd">        notes: JSON blob for additional contextual information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;luthien_log&quot;</span>  <span class="c1"># type: ignore (shut up pyright)</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">datetime</span><span class="p">:</span> <span class="n">NaiveDatetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">NaiveDatetime</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">JsonBOrJson</span><span class="p">))</span>
    <span class="n">datatype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">notes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">JsonBOrJson</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override init to ensure datetime is converted to NaiveDatetime.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;datetime&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">dt_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt_value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt_value</span><span class="p">,</span> <span class="n">NaiveDatetime</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NaiveDatetime</span><span class="p">(</span><span class="n">dt_value</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># __table_args__ = (</span>
    <span class="c1">#     Index(&quot;ix_sqlmodel_luthien_log_transaction_id&quot;, &quot;transaction_id&quot;),</span>
    <span class="c1">#     Index(&quot;ix_sqlmodel_luthien_log_datetime&quot;, &quot;datetime&quot;),</span>
    <span class="c1">#     Index(&quot;ix_sqlmodel_luthien_log_datatype&quot;, &quot;datatype&quot;),</span>
    <span class="c1">#     {&quot;extend_existing&quot;: True},</span>
    <span class="c1"># )</span>

    <span class="c1"># __repr__ is not automatically generated by SQLModel like Pydantic models,</span>
    <span class="c1"># but you can add one if desired.</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;LuthienLog(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;transaction_id=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;datetime=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;datatype=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="si">}</span><span class="s2">&#39;)&gt;&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Represents a log entry in the Luthien logging system using SQLModel.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.LuthienLog.id">id</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the log entry (primary key).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.LuthienLog.transaction_id">transaction_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Identifier to group related log entries.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.LuthienLog.datetime">datetime</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    NaiveDatetime" href="#luthien_control.db.naive_datetime.NaiveDatetime">NaiveDatetime</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timestamp indicating when the log entry was generated (timezone-aware).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.LuthienLog.data">data</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON blob containing the primary logged data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.LuthienLog.datatype">datatype</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String identifier for the nature and schema of 'data'.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.LuthienLog.notes">notes</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON blob for additional contextual information.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.LuthienLog.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.db.LuthienLog.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Override init to ensure datetime is converted to NaiveDatetime.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;datetime&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">dt_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt_value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt_value</span><span class="p">,</span> <span class="n">NaiveDatetime</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NaiveDatetime</span><span class="p">(</span><span class="n">dt_value</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Override init to ensure datetime is converted to NaiveDatetime.</p>


    </div>

</div>



  </div>


    </div>

</div>



<div class="doc doc-object doc-module">



<h3 id="luthien_control.db.client_api_key_crud" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>client_api_key_crud</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.client_api_key_crud.create_api_key" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.client_api_key_crud.create_api_key" class="doc-anchor"><code class="highlight language-python"><span class="n">create_api_key</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/client_api_key_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_api_key</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">api_key</span><span class="p">:</span> <span class="n">ClientApiKey</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientApiKey</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new API key in the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        api_key: The API key to create</span>

<span class="sd">    Returns:</span>
<span class="sd">        The created API key with updated ID</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBIntegrityError: If a constraint violation occurs</span>
<span class="sd">        LuthienDBTransactionError: If the transaction fails</span>
<span class="sd">        LuthienDBOperationError: For other database errors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully created API key with ID: </span><span class="si">{</span><span class="n">api_key</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">api_key</span>
    <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Integrity error creating API key: </span><span class="si">{</span><span class="n">ie</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBIntegrityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create API key due to constraint violation: </span><span class="si">{</span><span class="n">ie</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ie</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ie</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error creating API key: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBTransactionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database transaction failed while creating API key: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error creating API key: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during API key creation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create a new API key in the database.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>api_key</code>
            </td>
            <td>
                  <code><span title="luthien_control.db.sqlmodel_models.ClientApiKey">ClientApiKey</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The API key to create</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="luthien_control.db.sqlmodel_models.ClientApiKey">ClientApiKey</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The created API key with updated ID</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBIntegrityError" href="#luthien_control.db.exceptions.LuthienDBIntegrityError">LuthienDBIntegrityError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a constraint violation occurs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBTransactionError" href="#luthien_control.db.exceptions.LuthienDBTransactionError">LuthienDBTransactionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the transaction fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For other database errors</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.client_api_key_crud.get_api_key_by_value" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.client_api_key_crud.get_api_key_by_value" class="doc-anchor"><code class="highlight language-python"><span class="n">get_api_key_by_value</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">key_value</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/client_api_key_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_api_key_by_value</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">key_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientApiKey</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get an active API key by its value.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        key_value: The value of the API key to retrieve</span>

<span class="sd">    Returns:</span>
<span class="sd">        The API key</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the API key is not found or if the query execution fails</span>
<span class="sd">        LuthienDBOperationError: For unexpected errors during lookup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">ClientApiKey</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">ClientApiKey</span><span class="o">.</span><span class="n">key_value</span> <span class="o">==</span> <span class="n">key_value</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">ClientApiKey</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error fetching API key by value: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database query failed while fetching API key: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error fetching API key by value: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during API key lookup: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Active API key with value &#39;</span><span class="si">{</span><span class="n">key_value</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">api_key</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get an active API key by its value.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_value</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value of the API key to retrieve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="luthien_control.db.sqlmodel_models.ClientApiKey">ClientApiKey</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The API key</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the API key is not found or if the query execution fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For unexpected errors during lookup</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.client_api_key_crud.list_api_keys" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.client_api_key_crud.list_api_keys" class="doc-anchor"><code class="highlight language-python"><span class="n">list_api_keys</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/client_api_key_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_api_keys</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">active_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ClientApiKey</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of all API keys.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        active_only: If True, only return active API keys</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of API keys</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the query execution fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">active_only</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">ClientApiKey</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ClientApiKey</span><span class="o">.</span><span class="n">is_active</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">ClientApiKey</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error listing API keys: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database query failed while listing API keys: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error listing API keys: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during API key listing: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a list of all API keys.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>active_only</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only return active API keys</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="luthien_control.db.sqlmodel_models.ClientApiKey">ClientApiKey</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of API keys</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the query execution fails</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.client_api_key_crud.update_api_key" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.client_api_key_crud.update_api_key" class="doc-anchor"><code class="highlight language-python"><span class="n">update_api_key</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">key_id</span><span class="p">,</span> <span class="n">api_key_update</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/client_api_key_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_api_key</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">key_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">api_key_update</span><span class="p">:</span> <span class="n">ClientApiKey</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ClientApiKey</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update an existing API key.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        key_id: The ID of the API key to update</span>
<span class="sd">        api_key_update: The updated API key data</span>

<span class="sd">    Returns:</span>
<span class="sd">        The updated API key</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the API key is not found</span>
<span class="sd">        LuthienDBIntegrityError: If a constraint violation occurs</span>
<span class="sd">        LuthienDBTransactionError: If the transaction fails</span>
<span class="sd">        LuthienDBOperationError: For other database errors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">ClientApiKey</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ClientApiKey</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">key_id</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="n">api_key</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error updating API key: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBTransactionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database transaction failed while updating API key: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error updating API key: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during API key update: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">api_key</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API key with ID </span><span class="si">{</span><span class="n">key_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Update fields</span>
        <span class="n">api_key</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">api_key_update</span><span class="o">.</span><span class="n">name</span>
        <span class="n">api_key</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="n">api_key_update</span><span class="o">.</span><span class="n">is_active</span>
        <span class="n">api_key</span><span class="o">.</span><span class="n">metadata_</span> <span class="o">=</span> <span class="n">api_key_update</span><span class="o">.</span><span class="n">metadata_</span>

        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">api_key</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully updated API key with ID: </span><span class="si">{</span><span class="n">api_key</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">api_key</span>
    <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Integrity error updating API key: </span><span class="si">{</span><span class="n">ie</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBIntegrityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not update API key due to constraint violation: </span><span class="si">{</span><span class="n">ie</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ie</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ie</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error updating API key: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBTransactionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database transaction failed while updating API key: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error updating API key: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during API key update: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Update an existing API key.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>key_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the API key to update</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>api_key_update</code>
            </td>
            <td>
                  <code><span title="luthien_control.db.sqlmodel_models.ClientApiKey">ClientApiKey</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated API key data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="luthien_control.db.sqlmodel_models.ClientApiKey">ClientApiKey</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated API key</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the API key is not found</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBIntegrityError" href="#luthien_control.db.exceptions.LuthienDBIntegrityError">LuthienDBIntegrityError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a constraint violation occurs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBTransactionError" href="#luthien_control.db.exceptions.LuthienDBTransactionError">LuthienDBTransactionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the transaction fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For other database errors</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.db.control_policy_crud" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>control_policy_crud</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.control_policy_crud.get_policy_by_name" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.control_policy_crud.get_policy_by_name" class="doc-anchor"><code class="highlight language-python"><span class="n">get_policy_by_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/control_policy_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_policy_by_name</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DBControlPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a policy by its name.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        name: The name of the policy to retrieve</span>

<span class="sd">    Returns:</span>
<span class="sd">        The policy</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the policy is not found or if the query execution fails</span>
<span class="sd">        LuthienDBOperationError: For unexpected errors during lookup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">DBControlPolicy</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">DBControlPolicy</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
            <span class="n">DBControlPolicy</span><span class="o">.</span><span class="n">is_active</span><span class="p">,</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Policy with name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">policy</span>
    <span class="k">except</span> <span class="n">LuthienDBQueryError</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error fetching policy by name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database query failed while fetching policy &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error fetching policy by name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during policy lookup: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a policy by its name.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the policy to retrieve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.db.sqlmodel_models.ControlPolicy">ControlPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The policy</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the policy is not found or if the query execution fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For unexpected errors during lookup</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.control_policy_crud.get_policy_config_by_name" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.control_policy_crud.get_policy_config_by_name" class="doc-anchor"><code class="highlight language-python"><span class="n">get_policy_config_by_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/control_policy_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_policy_config_by_name</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DBControlPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a policy configuration by its name, regardless of its active status.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        name: The name of the policy to retrieve</span>

<span class="sd">    Returns:</span>
<span class="sd">        The policy</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the policy is not found or if the query execution fails</span>
<span class="sd">        LuthienDBOperationError: For unexpected errors during lookup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">DBControlPolicy</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DBControlPolicy</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">name</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Policy with name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">policy</span>
    <span class="k">except</span> <span class="n">LuthienDBQueryError</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error fetching policy configuration by name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database query failed while fetching policy config &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error fetching policy configuration by name &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during policy config lookup: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a policy configuration by its name, regardless of its active status.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the policy to retrieve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.db.sqlmodel_models.ControlPolicy">ControlPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The policy</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the policy is not found or if the query execution fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For unexpected errors during lookup</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.control_policy_crud.list_policies" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.control_policy_crud.list_policies" class="doc-anchor"><code class="highlight language-python"><span class="n">list_policies</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">active_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/control_policy_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_policies</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">active_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">DBControlPolicy</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of all policies.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        active_only: If True, only return active policies</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of policies</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the query execution fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">active_only</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">DBControlPolicy</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DBControlPolicy</span><span class="o">.</span><span class="n">is_active</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">DBControlPolicy</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error listing policies: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database query failed while listing policies: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error listing policies: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during policy listing: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a list of all policies.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>active_only</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, only return active policies</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.db.sqlmodel_models.ControlPolicy">ControlPolicy</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of policies</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the query execution fails</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.control_policy_crud.load_policy_from_db" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.control_policy_crud.load_policy_from_db" class="doc-anchor"><code class="highlight language-python"><span class="n">load_policy_from_db</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">container</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/control_policy_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_policy_from_db</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">container</span><span class="p">:</span> <span class="s2">&quot;DependencyContainer&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;ABCControlPolicy&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a policy configuration from the database and instantiate it using the control_policy loader.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: The name of the policy to load</span>
<span class="sd">        container: The dependency container providing access to the database session</span>

<span class="sd">    Returns:</span>
<span class="sd">        The instantiated policy</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the database query fails or policy is not found</span>
<span class="sd">        LuthienDBOperationError: If the policy cannot be instantiated or other database operation errors occur</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">container</span><span class="o">.</span><span class="n">db_session_factory</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
            <span class="n">policy_name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_policy_by_name</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

        <span class="c1"># Prepare the data for the simple loader</span>
        <span class="n">policy_data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">policy_name</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>  <span class="c1"># The loader uses this to find the class</span>
            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="n">policy_name</span><span class="o">.</span><span class="n">config</span> <span class="ow">or</span> <span class="p">{},</span>
        <span class="p">}</span>

        <span class="c1"># Construct the SerializedPolicy dataclass instance</span>
        <span class="n">serialized_policy_obj</span> <span class="o">=</span> <span class="n">SerializedPolicy</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">policy_data_dict</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">],</span> <span class="n">config</span><span class="o">=</span><span class="n">policy_data_dict</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">load_policy</span><span class="p">(</span><span class="n">serialized_policy_obj</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully loaded and instantiated policy &#39;</span><span class="si">{</span><span class="n">policy_name</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; from database.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">instance</span>
        <span class="k">except</span> <span class="n">PolicyLoadError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load policy &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; from database: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to instantiate policy &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; from database configuration: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error loading policy &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; from database: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during policy instantiation for &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">except</span> <span class="n">LuthienDBQueryError</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">LuthienDBOperationError</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during policy loading process for &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during policy loading process for &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Load a policy configuration from the database and instantiate it using the control_policy loader.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the policy to load</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>container</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dependency container providing access to the database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The instantiated policy</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the database query fails or policy is not found</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the policy cannot be instantiated or other database operation errors occur</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.control_policy_crud.save_policy_to_db" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.control_policy_crud.save_policy_to_db" class="doc-anchor"><code class="highlight language-python"><span class="n">save_policy_to_db</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">policy</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/control_policy_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">save_policy_to_db</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">DBControlPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DBControlPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a new policy in the database.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        policy: The policy to create</span>

<span class="sd">    Returns:</span>
<span class="sd">        The created policy with updated ID</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBIntegrityError: If a constraint violation occurs</span>
<span class="sd">        LuthienDBTransactionError: If the transaction fails</span>
<span class="sd">        LuthienDBOperationError: For other database errors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully created policy with ID: </span><span class="si">{</span><span class="n">policy</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">policy</span>
    <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Integrity error creating policy: </span><span class="si">{</span><span class="n">ie</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBIntegrityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not create policy due to constraint violation: </span><span class="si">{</span><span class="n">ie</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ie</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ie</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error creating policy: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBTransactionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database transaction failed while creating policy: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error creating policy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during policy creation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create a new policy in the database.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>policy</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.db.sqlmodel_models.ControlPolicy">ControlPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The policy to create</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.db.sqlmodel_models.ControlPolicy">ControlPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The created policy with updated ID</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBIntegrityError" href="#luthien_control.db.exceptions.LuthienDBIntegrityError">LuthienDBIntegrityError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a constraint violation occurs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBTransactionError" href="#luthien_control.db.exceptions.LuthienDBTransactionError">LuthienDBTransactionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the transaction fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For other database errors</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.control_policy_crud.update_policy" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.control_policy_crud.update_policy" class="doc-anchor"><code class="highlight language-python"><span class="n">update_policy</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">policy_id</span><span class="p">,</span> <span class="n">policy_update</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/control_policy_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_policy</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">policy_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">policy_update</span><span class="p">:</span> <span class="n">DBControlPolicy</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DBControlPolicy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update an existing policy.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        policy_id: The ID of the policy to update</span>
<span class="sd">        policy_update: The updated policy data</span>

<span class="sd">    Returns:</span>
<span class="sd">        The updated policy</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the policy is not found</span>
<span class="sd">        LuthienDBIntegrityError: If a constraint violation occurs</span>
<span class="sd">        LuthienDBTransactionError: If the transaction fails</span>
<span class="sd">        LuthienDBOperationError: For other database errors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">DBControlPolicy</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">DBControlPolicy</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">policy_id</span><span class="p">)</span>  <span class="c1"># type: ignore[arg-type]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">policy</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Policy with ID </span><span class="si">{</span><span class="n">policy_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

        <span class="c1"># Update fields</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">policy_update</span><span class="o">.</span><span class="n">name</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">policy_update</span><span class="o">.</span><span class="n">config</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">is_active</span> <span class="o">=</span> <span class="n">policy_update</span><span class="o">.</span><span class="n">is_active</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">policy_update</span><span class="o">.</span><span class="n">description</span>

        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully updated policy with ID: </span><span class="si">{</span><span class="n">policy</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">policy</span>
    <span class="k">except</span> <span class="n">LuthienDBQueryError</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">ie</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Integrity error updating policy: </span><span class="si">{</span><span class="n">ie</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBIntegrityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not update policy due to constraint violation: </span><span class="si">{</span><span class="n">ie</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ie</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">ie</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error updating policy: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBTransactionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database transaction failed while updating policy: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error updating policy: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during policy update: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Update an existing policy.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>policy_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the policy to update</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>policy_update</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.db.sqlmodel_models.ControlPolicy">ControlPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated policy data</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.db.sqlmodel_models.ControlPolicy">ControlPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The updated policy</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the policy is not found</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBIntegrityError" href="#luthien_control.db.exceptions.LuthienDBIntegrityError">LuthienDBIntegrityError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If a constraint violation occurs</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBTransactionError" href="#luthien_control.db.exceptions.LuthienDBTransactionError">LuthienDBTransactionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the transaction fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For other database errors</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.db.database_async" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>database_async</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.database_async.close_db_engine" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.database_async.close_db_engine" class="doc-anchor"><code class="highlight language-python"><span class="n">close_db_engine</span><span class="p">()</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/database_async.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close_db_engine</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Closes the database engine.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_db_engine</span>
    <span class="k">if</span> <span class="n">_db_engine</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">_db_engine</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database engine closed successfully.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error closing database engine: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">_db_engine</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database engine was already None or not initialized during shutdown.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Closes the database engine.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.database_async.create_db_engine" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.database_async.create_db_engine" class="doc-anchor"><code class="highlight language-python"><span class="n">create_db_engine</span><span class="p">()</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/database_async.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">create_db_engine</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AsyncEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates the asyncpg engine for the application DB.</span>
<span class="sd">    Returns:</span>
<span class="sd">        The asyncpg engine for the application DB.</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBConfigurationError: If the database configuration is invalid.</span>
<span class="sd">        LuthienDBConnectionError: If the database connection fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_db_engine</span><span class="p">,</span> <span class="n">_db_session_factory</span>
    <span class="k">if</span> <span class="n">_db_engine</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Database engine already initialized.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_db_engine</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Attempting to create database engine...&quot;</span><span class="p">)</span>

    <span class="n">db_url</span> <span class="o">=</span> <span class="n">_get_db_url</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get and validate pool sizes</span>
        <span class="n">pool_min_size</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get_main_db_pool_min_size</span><span class="p">()</span>
        <span class="n">pool_max_size</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get_main_db_pool_max_size</span><span class="p">()</span>

        <span class="n">_db_engine</span> <span class="o">=</span> <span class="n">create_async_engine</span><span class="p">(</span>
            <span class="n">db_url</span><span class="p">,</span>
            <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Set to True for debugging SQL queries</span>
            <span class="n">pool_pre_ping</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">pool_size</span><span class="o">=</span><span class="n">pool_min_size</span><span class="p">,</span>
            <span class="n">max_overflow</span><span class="o">=</span><span class="n">pool_max_size</span> <span class="o">-</span> <span class="n">pool_min_size</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_db_session_factory</span> <span class="o">=</span> <span class="n">async_sessionmaker</span><span class="p">(</span>
            <span class="n">_db_engine</span><span class="p">,</span>
            <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">class_</span><span class="o">=</span><span class="n">AsyncSession</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Database engine created successfully.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_db_engine</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">masked_url</span> <span class="o">=</span> <span class="n">_mask_password</span><span class="p">(</span><span class="n">db_url</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBConnectionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create database engine using URL (</span><span class="si">{</span><span class="n">masked_url</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Creates the asyncpg engine for the application DB.
Returns:
    The asyncpg engine for the application DB.</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBConfigurationError" href="#luthien_control.exceptions.LuthienDBConfigurationError">LuthienDBConfigurationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the database configuration is invalid.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBConnectionError" href="#luthien_control.exceptions.LuthienDBConnectionError">LuthienDBConnectionError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the database connection fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.database_async.get_db_session" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.database_async.get_db_session" class="doc-anchor"><code class="highlight language-python"><span class="n">get_db_session</span><span class="p">()</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/database_async.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextlib</span><span class="o">.</span><span class="n">asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_db_session</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">AsyncSession</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a SQLAlchemy async session for the database as a context manager.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_db_session_factory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Database session factory has not been initialized&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="n">_db_session_factory</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">session</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a SQLAlchemy async session for the database as a context manager.</p>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.db.exceptions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>exceptions</code>


</h3>

    <div class="doc doc-contents ">

        <p>Database-specific exceptions for the Luthien Control project.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.db.exceptions.LuthienDBIntegrityError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.exceptions.LuthienDBIntegrityError" class="doc-anchor"><code>LuthienDBIntegrityError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuthienDBIntegrityError</span><span class="p">(</span><span class="n">LuthienDBOperationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when a database integrity constraint is violated.</span>

<span class="sd">    This exception wraps SQLAlchemy&#39;s IntegrityError and provides a more</span>
<span class="sd">    specific error type for the Luthien Control project.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">original_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IntegrityError</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the exception.</span>

<span class="sd">        Args:</span>
<span class="sd">            message: A descriptive error message</span>
<span class="sd">            original_error: The original IntegrityError that was raised</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_error</span> <span class="o">=</span> <span class="n">original_error</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Exception raised when a database integrity constraint is violated.</p>
<p>This exception wraps SQLAlchemy's IntegrityError and provides a more
specific error type for the Luthien Control project.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.db.exceptions.LuthienDBIntegrityError.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.db.exceptions.LuthienDBIntegrityError.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">original_error</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/exceptions.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">original_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">IntegrityError</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the exception.</span>

<span class="sd">    Args:</span>
<span class="sd">        message: A descriptive error message</span>
<span class="sd">        original_error: The original IntegrityError that was raised</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">original_error</span> <span class="o">=</span> <span class="n">original_error</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Initialize the exception.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>message</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A descriptive error message</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>original_error</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="sqlalchemy.exc.IntegrityError">IntegrityError</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original IntegrityError that was raised</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.db.exceptions.LuthienDBOperationError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.exceptions.LuthienDBOperationError" class="doc-anchor"><code>LuthienDBOperationError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    LuthienDBException" href="#luthien_control.exceptions.LuthienDBException">LuthienDBException</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuthienDBOperationError</span><span class="p">(</span><span class="n">LuthienDBException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for database operation errors.</span>

<span class="sd">    This exception is raised when a database operation fails for any reason.</span>
<span class="sd">    It serves as a base class for more specific database operation errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Base exception for database operation errors.</p>
<p>This exception is raised when a database operation fails for any reason.
It serves as a base class for more specific database operation errors.</p>








    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.db.exceptions.LuthienDBQueryError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.exceptions.LuthienDBQueryError" class="doc-anchor"><code>LuthienDBQueryError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuthienDBQueryError</span><span class="p">(</span><span class="n">LuthienDBOperationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when a database query fails.</span>

<span class="sd">    This exception is raised when a SELECT query fails to execute properly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Exception raised when a database query fails.</p>
<p>This exception is raised when a SELECT query fails to execute properly.</p>








    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.db.exceptions.LuthienDBTransactionError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.exceptions.LuthienDBTransactionError" class="doc-anchor"><code>LuthienDBTransactionError</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuthienDBTransactionError</span><span class="p">(</span><span class="n">LuthienDBOperationError</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when a database transaction fails.</span>

<span class="sd">    This exception is raised when a transaction (commit, rollback) fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Exception raised when a database transaction fails.</p>
<p>This exception is raised when a transaction (commit, rollback) fails.</p>








    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.db.luthien_log_crud" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>luthien_log_crud</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.luthien_log_crud.count_logs" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.luthien_log_crud.count_logs" class="doc-anchor"><code class="highlight language-python"><span class="n">count_logs</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">transaction_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">start_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/luthien_log_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">count_logs</span><span class="p">(</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="n">transaction_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">datatype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">start_datetime</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">end_datetime</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Count logs with optional filtering.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        transaction_id: Optional filter by transaction ID</span>
<span class="sd">        datatype: Optional filter by datatype</span>
<span class="sd">        start_datetime: Optional filter for logs after this datetime</span>
<span class="sd">        end_datetime: Optional filter for logs before this datetime</span>

<span class="sd">    Returns:</span>
<span class="sd">        The count of matching logs</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the query execution fails</span>
<span class="sd">        LuthienDBOperationError: For unexpected errors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="c1"># Apply filters</span>
        <span class="k">if</span> <span class="n">transaction_id</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">transaction_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span> <span class="o">==</span> <span class="n">datatype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_datetime</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">start_datetime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end_datetime</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">end_datetime</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error counting logs: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database query failed while counting logs: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error counting logs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during log counting: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Count logs with optional filtering.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transaction_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filter by transaction ID</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>datatype</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filter by datatype</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_datetime</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="datetime.datetime">datetime</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filter for logs after this datetime</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_datetime</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="datetime.datetime">datetime</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filter for logs before this datetime</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The count of matching logs</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the query execution fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For unexpected errors</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.luthien_log_crud.get_log_by_id" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.luthien_log_crud.get_log_by_id" class="doc-anchor"><code class="highlight language-python"><span class="n">get_log_by_id</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">log_id</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/luthien_log_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_log_by_id</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">log_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LuthienLog</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a specific log by its ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        log_id: The ID of the log to retrieve</span>

<span class="sd">    Returns:</span>
<span class="sd">        The log entry</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the log is not found or if the query execution fails</span>
<span class="sd">        LuthienDBOperationError: For unexpected errors during lookup</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">LuthienLog</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">log_id</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="n">log_entry</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">scalar_one_or_none</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error fetching log by ID: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database query failed while fetching log: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error fetching log by ID: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during log lookup: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">log_entry</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Log with ID </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">log_entry</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a specific log by its ID.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>log_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The ID of the log to retrieve</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienLog" href="#luthien_control.db.sqlmodel_models.LuthienLog">LuthienLog</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The log entry</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the log is not found or if the query execution fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For unexpected errors during lookup</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.luthien_log_crud.get_unique_datatypes" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.luthien_log_crud.get_unique_datatypes" class="doc-anchor"><code class="highlight language-python"><span class="n">get_unique_datatypes</span><span class="p">(</span><span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/luthien_log_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_unique_datatypes</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of unique datatypes from the logs.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of unique datatype values</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the query execution fails</span>
<span class="sd">        LuthienDBOperationError: For unexpected errors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">datatype</span><span class="p">))</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">datatype</span><span class="p">))</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error fetching unique datatypes: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database query failed while fetching datatypes: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error fetching unique datatypes: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during datatype lookup: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a list of unique datatypes from the logs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of unique datatype values</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the query execution fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For unexpected errors</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.luthien_log_crud.get_unique_transaction_ids" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.luthien_log_crud.get_unique_transaction_ids" class="doc-anchor"><code class="highlight language-python"><span class="n">get_unique_transaction_ids</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/luthien_log_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_unique_transaction_ids</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span> <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of unique transaction IDs from recent logs.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        limit: Maximum number of transaction IDs to return (default: 100)</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of unique transaction ID values</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the query execution fails</span>
<span class="sd">        LuthienDBOperationError: For unexpected errors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Get distinct transaction_ids ordered by the most recent datetime for each transaction</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">select</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">))</span>
            <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">)))</span>
            <span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error fetching unique transaction IDs: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database query failed while fetching transaction IDs: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error fetching unique transaction IDs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during transaction ID lookup: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a list of unique transaction IDs from recent logs.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of transaction IDs to return (default: 100)</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of unique transaction ID values</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the query execution fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For unexpected errors</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.db.luthien_log_crud.list_logs" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.db.luthien_log_crud.list_logs" class="doc-anchor"><code class="highlight language-python"><span class="n">list_logs</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">transaction_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">start_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">end_datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/luthien_log_crud.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">list_logs</span><span class="p">(</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
    <span class="n">transaction_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">datatype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">start_datetime</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">end_datetime</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">LuthienLog</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a list of logs with optional filtering.</span>

<span class="sd">    Args:</span>
<span class="sd">        session: The database session</span>
<span class="sd">        transaction_id: Optional filter by transaction ID</span>
<span class="sd">        datatype: Optional filter by datatype</span>
<span class="sd">        limit: Maximum number of logs to return (default: 100)</span>
<span class="sd">        offset: Number of logs to skip (default: 0)</span>
<span class="sd">        start_datetime: Optional filter for logs after this datetime</span>
<span class="sd">        end_datetime: Optional filter for logs before this datetime</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of LuthienLog entries</span>

<span class="sd">    Raises:</span>
<span class="sd">        LuthienDBQueryError: If the query execution fails</span>
<span class="sd">        LuthienDBOperationError: For unexpected errors</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">LuthienLog</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">datetime</span><span class="p">)))</span>

        <span class="c1"># Apply filters</span>
        <span class="k">if</span> <span class="n">transaction_id</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">transaction_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">datatype</span><span class="p">)</span> <span class="o">==</span> <span class="n">datatype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_datetime</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">start_datetime</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end_datetime</span><span class="p">:</span>
            <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="n">LuthienLog</span><span class="o">.</span><span class="n">datetime</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">end_datetime</span><span class="p">)</span>

        <span class="c1"># Apply pagination</span>
        <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">scalars</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
    <span class="k">except</span> <span class="n">SQLAlchemyError</span> <span class="k">as</span> <span class="n">sqla_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SQLAlchemy error listing logs: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBQueryError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database query failed while listing logs: </span><span class="si">{</span><span class="n">sqla_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">sqla_err</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error listing logs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">LuthienDBOperationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error during log listing: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a list of logs with optional filtering.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transaction_id</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filter by transaction ID</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>datatype</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filter by datatype</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>limit</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of logs to return (default: 100)</p>
              </div>
            </td>
            <td>
                  <code>100</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>offset</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of logs to skip (default: 0)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>start_datetime</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="datetime.datetime">datetime</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filter for logs after this datetime</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>end_datetime</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="datetime.datetime">datetime</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional filter for logs before this datetime</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<a class="autorefs autorefs-internal" title="    LuthienLog" href="#luthien_control.db.sqlmodel_models.LuthienLog">LuthienLog</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of LuthienLog entries</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBQueryError" href="#luthien_control.db.exceptions.LuthienDBQueryError">LuthienDBQueryError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the query execution fails</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><a class="autorefs autorefs-internal" title="    LuthienDBOperationError" href="#luthien_control.db.exceptions.LuthienDBOperationError">LuthienDBOperationError</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>For unexpected errors</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.db.naive_datetime" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>naive_datetime</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.db.naive_datetime.NaiveDatetime" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.naive_datetime.NaiveDatetime" class="doc-anchor"><code>NaiveDatetime</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="datetime.datetime">datetime</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/naive_datetime.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NaiveDatetime</span><span class="p">(</span><span class="n">datetime</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A datetime that automatically strips timezone info.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Handle datetime object as first argument</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Convert to naive UTC if timezone-aware, otherwise keep as-is</span>
            <span class="k">if</span> <span class="n">dt</span><span class="o">.</span><span class="n">tzinfo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">microsecond</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Normal datetime constructor</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">now</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tzinfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;NaiveDatetime&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a NaiveDatetime representing the current UTC time (naive).&quot;&quot;&quot;</span>
        <span class="c1"># Always return naive UTC time regardless of tz parameter for consistency</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">__get_pydantic_core_schema__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">core_schema</span><span class="o">.</span><span class="n">CoreSchema</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pydantic schema for NaiveDatetime.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">core_schema</span><span class="o">.</span><span class="n">with_info_before_validator_function</span><span class="p">(</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">_convert_to_naive</span><span class="p">,</span>
            <span class="n">core_schema</span><span class="o">.</span><span class="n">datetime_schema</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_to_naive</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">info</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert datetime to naive before Pydantic processes it.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>  <span class="c1"># This will trigger our __new__ method</span>
        <span class="k">return</span> <span class="n">value</span>  <span class="c1"># Let Pydantic handle other types</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A datetime that automatically strips timezone info.</p>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.db.naive_datetime.NaiveDatetime.__get_pydantic_core_schema__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.db.naive_datetime.NaiveDatetime.__get_pydantic_core_schema__" class="doc-anchor"><code class="highlight language-python"><span class="n">__get_pydantic_core_schema__</span><span class="p">(</span><span class="n">source_type</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/naive_datetime.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">__get_pydantic_core_schema__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source_type</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">handler</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">core_schema</span><span class="o">.</span><span class="n">CoreSchema</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pydantic schema for NaiveDatetime.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">core_schema</span><span class="o">.</span><span class="n">with_info_before_validator_function</span><span class="p">(</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">_convert_to_naive</span><span class="p">,</span>
        <span class="n">core_schema</span><span class="o">.</span><span class="n">datetime_schema</span><span class="p">(),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Pydantic schema for NaiveDatetime.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.db.naive_datetime.NaiveDatetime.now" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.db.naive_datetime.NaiveDatetime.now" class="doc-anchor"><code class="highlight language-python"><span class="n">now</span><span class="p">(</span><span class="n">tz</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/naive_datetime.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">now</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">tz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">tzinfo</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;NaiveDatetime&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a NaiveDatetime representing the current UTC time (naive).&quot;&quot;&quot;</span>
    <span class="c1"># Always return naive UTC time regardless of tz parameter for consistency</span>
    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create a NaiveDatetime representing the current UTC time (naive).</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.db.sqlmodel_models" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>sqlmodel_models</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.db.sqlmodel_models.AdminSession" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.sqlmodel_models.AdminSession" class="doc-anchor"><code>AdminSession</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="sqlmodel.SQLModel">SQLModel</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdminSession</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Admin session model for managing active sessions.&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;admin_sessions&quot;</span>  <span class="c1"># type: ignore</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">session_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">admin_user_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">foreign_key</span><span class="o">=</span><span class="s2">&quot;admin_users.id&quot;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Reference to admin user&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">expires_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span>
        <span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;idx_session_token&quot;</span><span class="p">,</span> <span class="s2">&quot;session_token&quot;</span><span class="p">),</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;idx_session_expires&quot;</span><span class="p">,</span> <span class="s2">&quot;expires_at&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Admin session model for managing active sessions.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.db.sqlmodel_models.AdminUser" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.sqlmodel_models.AdminUser" class="doc-anchor"><code>AdminUser</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="sqlmodel.SQLModel">SQLModel</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdminUser</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Admin user model for authentication and authorization.&quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;admin_users&quot;</span>  <span class="c1"># type: ignore</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">password_hash</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">is_superuser</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">last_login</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span>
        <span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
    <span class="p">)</span>
    <span class="n">updated_at</span><span class="p">:</span> <span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">,</span>
        <span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">()),</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;idx_admin_username&quot;</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">),</span>
        <span class="n">Index</span><span class="p">(</span><span class="s2">&quot;idx_admin_active&quot;</span><span class="p">,</span> <span class="s2">&quot;is_active&quot;</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Admin user model for authentication and authorization.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.db.sqlmodel_models.ControlPolicy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.sqlmodel_models.ControlPolicy" class="doc-anchor"><code>ControlPolicy</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="sqlmodel.SQLModel">SQLModel</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ControlPolicy</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;policies&quot;</span>  <span class="c1"># type: ignore (again, shut up pyright)</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Database model for storing control policy configurations.&quot;&quot;&quot;</span>

    <span class="c1"># Primary key</span>
    <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># --- Core Fields ---</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Unique name used for lookup</span>
    <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">()</span>  <span class="c1"># Type of policy, used for instantiation</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="p">{},</span> <span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">JSON</span><span class="p">))</span>
    <span class="n">is_active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="c1"># --- Timestamps ---</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">updated_at</span><span class="p">:</span> <span class="n">dt</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="c1"># Ensure timestamps are set on creation if not provided</span>
        <span class="k">if</span> <span class="s2">&quot;created_at&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;updated_at&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_timestamps</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure updated_at is always set/updated.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">values</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span>
</code></pre></div></td></tr></table></div>
          </details>










  <div class="doc doc-children">





<h5 id="luthien_control.db.sqlmodel_models.ControlPolicy.__tablename__" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>
</h5>
        <p>Database model for storing control policy configurations.</p>



<div class="doc doc-object doc-attribute">



<h5 id="luthien_control.db.sqlmodel_models.ControlPolicy.__tablename__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;policies&#39;</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-class-attribute"><code>class-attribute</code></small>
      <small class="doc doc-label doc-label-instance-attribute"><code>instance-attribute</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <p>Database model for storing control policy configurations.</p>

    </div>

</div>

  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.db.sqlmodel_models.ControlPolicy.validate_timestamps" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.db.sqlmodel_models.ControlPolicy.validate_timestamps" class="doc-anchor"><code class="highlight language-python"><span class="n">validate_timestamps</span><span class="p">(</span><span class="n">values</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;before&quot;</span><span class="p">)</span>
<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">validate_timestamps</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Ensure updated_at is always set/updated.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">values</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">values</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Ensure updated_at is always set/updated.</p>


    </div>

</div>



  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.db.sqlmodel_models.JsonBOrJson" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.sqlmodel_models.JsonBOrJson" class="doc-anchor"><code>JsonBOrJson</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="sqlalchemy.types.TypeDecorator">TypeDecorator</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">JsonBOrJson</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">TypeDecorator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a JSON type that uses JSONB for PostgreSQL and JSON for other dialects (like SQLite).</span>

<span class="sd">    This is mostly a hack for unit testing, as SQLite does not support JSONB.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">impl</span> <span class="o">=</span> <span class="n">JSON</span>  <span class="c1"># Default implementation if dialect-specific is not found</span>
    <span class="n">cache_ok</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Safe to cache this type decorator</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_dialect_impl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dialect</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;postgresql&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dialect</span><span class="o">.</span><span class="n">type_descriptor</span><span class="p">(</span><span class="n">JSONB</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dialect</span><span class="o">.</span><span class="n">type_descriptor</span><span class="p">(</span><span class="n">JSON</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Represents a JSON type that uses JSONB for PostgreSQL and JSON for other dialects (like SQLite).</p>
<p>This is mostly a hack for unit testing, as SQLite does not support JSONB.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.db.sqlmodel_models.LuthienLog" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.db.sqlmodel_models.LuthienLog" class="doc-anchor"><code>LuthienLog</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="sqlmodel.SQLModel">SQLModel</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuthienLog</span><span class="p">(</span><span class="n">SQLModel</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a log entry in the Luthien logging system using SQLModel.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        id: Unique identifier for the log entry (primary key).</span>
<span class="sd">        transaction_id: Identifier to group related log entries.</span>
<span class="sd">        datetime: Timestamp indicating when the log entry was generated (timezone-aware).</span>
<span class="sd">        data: JSON blob containing the primary logged data.</span>
<span class="sd">        datatype: String identifier for the nature and schema of &#39;data&#39;.</span>
<span class="sd">        notes: JSON blob for additional contextual information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;luthien_log&quot;</span>  <span class="c1"># type: ignore (shut up pyright)</span>

    <span class="nb">id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">datetime</span><span class="p">:</span> <span class="n">NaiveDatetime</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">NaiveDatetime</span><span class="o">.</span><span class="n">now</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">JsonBOrJson</span><span class="p">))</span>
    <span class="n">datatype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">notes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sa_column</span><span class="o">=</span><span class="n">Column</span><span class="p">(</span><span class="n">JsonBOrJson</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Override init to ensure datetime is converted to NaiveDatetime.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;datetime&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">dt_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt_value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt_value</span><span class="p">,</span> <span class="n">NaiveDatetime</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NaiveDatetime</span><span class="p">(</span><span class="n">dt_value</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>

    <span class="c1"># __table_args__ = (</span>
    <span class="c1">#     Index(&quot;ix_sqlmodel_luthien_log_transaction_id&quot;, &quot;transaction_id&quot;),</span>
    <span class="c1">#     Index(&quot;ix_sqlmodel_luthien_log_datetime&quot;, &quot;datetime&quot;),</span>
    <span class="c1">#     Index(&quot;ix_sqlmodel_luthien_log_datatype&quot;, &quot;datatype&quot;),</span>
    <span class="c1">#     {&quot;extend_existing&quot;: True},</span>
    <span class="c1"># )</span>

    <span class="c1"># __repr__ is not automatically generated by SQLModel like Pydantic models,</span>
    <span class="c1"># but you can add one if desired.</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&lt;LuthienLog(id=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;transaction_id=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;datetime=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;datatype=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">datatype</span><span class="si">}</span><span class="s2">&#39;)&gt;&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Represents a log entry in the Luthien logging system using SQLModel.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.sqlmodel_models.LuthienLog.id">id</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Unique identifier for the log entry (primary key).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.sqlmodel_models.LuthienLog.transaction_id">transaction_id</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Identifier to group related log entries.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.sqlmodel_models.LuthienLog.datetime">datetime</span></code></td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    NaiveDatetime" href="#luthien_control.db.naive_datetime.NaiveDatetime">NaiveDatetime</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Timestamp indicating when the log entry was generated (timezone-aware).</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.sqlmodel_models.LuthienLog.data">data</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON blob containing the primary logged data.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.sqlmodel_models.LuthienLog.datatype">datatype</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>String identifier for the nature and schema of 'data'.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.db.sqlmodel_models.LuthienLog.notes">notes</span></code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="dict">dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON blob for additional contextual information.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h5 id="luthien_control.db.sqlmodel_models.LuthienLog.__init__" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.db.sqlmodel_models.LuthienLog.__init__" class="doc-anchor"><code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span></code></a>


</h5>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/db/sqlmodel_models.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Override init to ensure datetime is converted to NaiveDatetime.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;datetime&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">dt_value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt_value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt_value</span><span class="p">,</span> <span class="n">NaiveDatetime</span><span class="p">):</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NaiveDatetime</span><span class="p">(</span><span class="n">dt_value</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Override init to ensure datetime is converted to NaiveDatetime.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.exceptions" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>exceptions</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h3 id="luthien_control.exceptions.LuthienDBConfigurationError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.exceptions.LuthienDBConfigurationError" class="doc-anchor"><code>LuthienDBConfigurationError</code></a>


</h3>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    LuthienDBException" href="#luthien_control.exceptions.LuthienDBException">LuthienDBException</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuthienDBConfigurationError</span><span class="p">(</span><span class="n">LuthienDBException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when a database configuration is invalid or missing required variables.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Exception raised when a database configuration is invalid or missing required variables.</p>








    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h3 id="luthien_control.exceptions.LuthienDBConnectionError" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.exceptions.LuthienDBConnectionError" class="doc-anchor"><code>LuthienDBConnectionError</code></a>


</h3>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    LuthienDBException" href="#luthien_control.exceptions.LuthienDBException">LuthienDBException</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuthienDBConnectionError</span><span class="p">(</span><span class="n">LuthienDBException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception raised when a connection to the database fails.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Exception raised when a connection to the database fails.</p>








    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h3 id="luthien_control.exceptions.LuthienDBException" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.exceptions.LuthienDBException" class="doc-anchor"><code>LuthienDBException</code></a>


</h3>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><a class="autorefs autorefs-internal" title="    LuthienException" href="#luthien_control.exceptions.LuthienException">LuthienException</a></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuthienDBException</span><span class="p">(</span><span class="n">LuthienException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for all Luthien DB related errors.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Base exception for all Luthien DB related errors.</p>








    </div>

</div>  

  

<div class="doc doc-object doc-class">



<h3 id="luthien_control.exceptions.LuthienException" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.exceptions.LuthienException" class="doc-anchor"><code>LuthienException</code></a>


</h3>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="Exception">Exception</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/exceptions.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LuthienException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for all Luthien errors.&quot;&quot;&quot;</span>

    <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Base exception for all Luthien errors.</p>








    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.logs" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>logs</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="luthien_control.logs.router" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>router</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.logs.router.get_datatypes" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.logs.router.get_datatypes" class="doc-anchor"><code class="highlight language-python"><span class="n">get_datatypes</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/logs/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/admin/logs-api/metadata/datatypes&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_datatypes</span><span class="p">(</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get list of unique datatypes from logs.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">get_unique_datatypes</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">LuthienDBQueryError</span><span class="p">,</span> <span class="n">LuthienDBOperationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database error getting datatypes: </span><span class="si">{</span><span class="n">db_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Failed to retrieve datatypes from database&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error getting datatypes: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;An unexpected error occurred&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get list of unique datatypes from logs.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.logs.router.get_log" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.logs.router.get_log" class="doc-anchor"><code class="highlight language-python"><span class="n">get_log</span><span class="p">(</span><span class="n">log_id</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/logs/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/admin/logs-api/logs/</span><span class="si">{log_id}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_log</span><span class="p">(</span>
    <span class="n">log_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a specific log by ID.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="k">await</span> <span class="n">get_log_by_id</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">log_id</span><span class="o">=</span><span class="n">log_id</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">,</span>
            <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">datetime</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">notes</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="n">LuthienDBQueryError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Log with ID </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2"> not found&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">LuthienDBOperationError</span> <span class="k">as</span> <span class="n">db_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database error getting log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">db_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Failed to retrieve log from database&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error getting log </span><span class="si">{</span><span class="n">log_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;An unexpected error occurred&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get a specific log by ID.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.logs.router.get_logs" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.logs.router.get_logs" class="doc-anchor"><code class="highlight language-python"><span class="n">get_logs</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span> <span class="n">transaction_id</span><span class="o">=</span><span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Filter by transaction ID&#39;</span><span class="p">),</span> <span class="n">datatype</span><span class="o">=</span><span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Filter by datatype&#39;</span><span class="p">),</span> <span class="n">limit</span><span class="o">=</span><span class="n">Query</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Maximum number of logs to return&#39;</span><span class="p">),</span> <span class="n">offset</span><span class="o">=</span><span class="n">Query</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Number of logs to skip&#39;</span><span class="p">),</span> <span class="n">start_datetime</span><span class="o">=</span><span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Start datetime (ISO format)&#39;</span><span class="p">),</span> <span class="n">end_datetime</span><span class="o">=</span><span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;End datetime (ISO format)&#39;</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/logs/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/admin/logs-api/logs&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_logs</span><span class="p">(</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
    <span class="n">transaction_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Filter by transaction ID&quot;</span><span class="p">),</span>
    <span class="n">datatype</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Filter by datatype&quot;</span><span class="p">),</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum number of logs to return&quot;</span><span class="p">),</span>
    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Number of logs to skip&quot;</span><span class="p">),</span>
    <span class="n">start_datetime</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Start datetime (ISO format)&quot;</span><span class="p">),</span>
    <span class="n">end_datetime</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;End datetime (ISO format)&quot;</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get logs with optional filtering and pagination.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary containing logs, pagination info, and metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Parse datetime strings if provided</span>
        <span class="n">start_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">end_dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">start_datetime</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">start_datetime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid start_datetime format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">end_datetime</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">end_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">end_datetime</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">,</span> <span class="s2">&quot;+00:00&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Invalid end_datetime format: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Get logs and total count</span>
        <span class="n">logs</span> <span class="o">=</span> <span class="k">await</span> <span class="n">list_logs</span><span class="p">(</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="n">transaction_id</span><span class="p">,</span>
            <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span>
            <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
            <span class="n">start_datetime</span><span class="o">=</span><span class="n">start_dt</span><span class="p">,</span>
            <span class="n">end_datetime</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">total_count</span> <span class="o">=</span> <span class="k">await</span> <span class="n">count_logs</span><span class="p">(</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="n">transaction_id</span><span class="p">,</span>
            <span class="n">datatype</span><span class="o">=</span><span class="n">datatype</span><span class="p">,</span>
            <span class="n">start_datetime</span><span class="o">=</span><span class="n">start_dt</span><span class="p">,</span>
            <span class="n">end_datetime</span><span class="o">=</span><span class="n">end_dt</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Convert logs to dict format for JSON response</span>
        <span class="n">logs_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">log</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
            <span class="n">log_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">,</span>
                <span class="s2">&quot;datetime&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="k">if</span> <span class="n">log</span><span class="o">.</span><span class="n">datetime</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">datatype</span><span class="p">,</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="s2">&quot;notes&quot;</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">notes</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">logs_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_dict</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;logs&quot;</span><span class="p">:</span> <span class="n">logs_data</span><span class="p">,</span>
            <span class="s2">&quot;pagination&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;limit&quot;</span><span class="p">:</span> <span class="n">limit</span><span class="p">,</span>
                <span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="n">offset</span><span class="p">,</span>
                <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total_count</span><span class="p">,</span>
                <span class="s2">&quot;has_next&quot;</span><span class="p">:</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">limit</span> <span class="o">&lt;</span> <span class="n">total_count</span><span class="p">,</span>
                <span class="s2">&quot;has_prev&quot;</span><span class="p">:</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
                <span class="s2">&quot;datatype&quot;</span><span class="p">:</span> <span class="n">datatype</span><span class="p">,</span>
                <span class="s2">&quot;start_datetime&quot;</span><span class="p">:</span> <span class="n">start_datetime</span><span class="p">,</span>
                <span class="s2">&quot;end_datetime&quot;</span><span class="p">:</span> <span class="n">end_datetime</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">except</span> <span class="n">HTTPException</span><span class="p">:</span>
        <span class="c1"># Re-raise HTTPExceptions (like 400 Bad Request) without modification</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">LuthienDBQueryError</span><span class="p">,</span> <span class="n">LuthienDBOperationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database error getting logs: </span><span class="si">{</span><span class="n">db_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Failed to retrieve logs from database&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error getting logs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;An unexpected error occurred&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get logs with optional filtering and pagination.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary containing logs, pagination info, and metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.logs.router.get_transaction_ids" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.logs.router.get_transaction_ids" class="doc-anchor"><code class="highlight language-python"><span class="n">get_transaction_ids</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="n">Query</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Maximum number of transaction IDs to return&#39;</span><span class="p">),</span> <span class="n">session</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/logs/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/admin/logs-api/metadata/transaction-ids&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_transaction_ids</span><span class="p">(</span>
    <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Maximum number of transaction IDs to return&quot;</span><span class="p">),</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get list of unique transaction IDs from recent logs.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">get_unique_transaction_ids</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">LuthienDBQueryError</span><span class="p">,</span> <span class="n">LuthienDBOperationError</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_err</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database error getting transaction IDs: </span><span class="si">{</span><span class="n">db_err</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Failed to retrieve transaction IDs from database&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error getting transaction IDs: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;An unexpected error occurred&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Get list of unique transaction IDs from recent logs.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.logs.router.logs_ui" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.logs.router.logs_ui" class="doc-anchor"><code class="highlight language-python"><span class="n">logs_ui</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/logs/router.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/admin/logs&quot;</span><span class="p">,</span> <span class="n">response_class</span><span class="o">=</span><span class="n">HTMLResponse</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">logs_ui</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Serve the logs exploration UI.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">TemplateResponse</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;logs.html&quot;</span><span class="p">,</span> <span class="p">{})</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Serve the logs exploration UI.</p>


    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.main" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>main</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h3 id="luthien_control.main.health_check" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.main.health_check" class="doc-anchor"><code class="highlight language-python"><span class="n">health_check</span><span class="p">()</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/main.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/health&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;General&quot;</span><span class="p">],</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">health_check</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Perform a basic health check.</span>

<span class="sd">    This endpoint can be used to verify that the application is running</span>
<span class="sd">    and responsive.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dictionary indicating the application status.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;ok&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Perform a basic health check.</p>
<p>This endpoint can be used to verify that the application is running
and responsive.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary indicating the application status.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h3 id="luthien_control.main.lifespan" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.main.lifespan" class="doc-anchor"><code class="highlight language-python"><span class="n">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/main.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@asynccontextmanager</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">lifespan</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manage the lifespan of the application resources.</span>

<span class="sd">    This asynchronous context manager handles the startup and shutdown events</span>
<span class="sd">    of the FastAPI application. It initializes dependencies on startup</span>
<span class="sd">    and ensures they are properly cleaned up on shutdown.</span>

<span class="sd">    Args:</span>
<span class="sd">        app: The FastAPI application instance.</span>

<span class="sd">    Yields:</span>
<span class="sd">        None: After startup procedures are complete, allowing the application to run.</span>

<span class="sd">    Raises:</span>
<span class="sd">        RuntimeError: If critical application dependencies fail to initialize during startup.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Application startup sequence initiated.&quot;</span><span class="p">)</span>

    <span class="c1"># Startup: Load Settings</span>
    <span class="n">app_settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Settings loaded.&quot;</span><span class="p">)</span>

    <span class="c1"># Startup: Initialize Application Dependencies via helper</span>
    <span class="c1"># This variable will hold the container if successfully created.</span>
    <span class="n">initialized_dependencies</span><span class="p">:</span> <span class="n">DependencyContainer</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">initialized_dependencies</span> <span class="o">=</span> <span class="k">await</span> <span class="n">initialize_app_dependencies</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="n">initialized_dependencies</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Core application dependencies initialized and stored in app state.&quot;</span><span class="p">)</span>

        <span class="c1"># Ensure default admin user exists</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">get_db_session</span><span class="p">(</span><span class="n">initialized_dependencies</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">admin_auth_service</span><span class="o">.</span><span class="n">ensure_default_admin</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">init_exc</span><span class="p">:</span>
        <span class="c1"># _initialize_app_dependencies is responsible for cleaning up resources it</span>
        <span class="c1"># attempted to create (like its own http_client) if it fails internally.</span>
        <span class="c1"># The main concern here is logging and ensuring the app doesn&#39;t start.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fatal error during application dependency initialization: </span><span class="si">{</span><span class="n">init_exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># If _initialize_app_dependencies failed before creating db_engine, close_db_engine is safe.</span>
        <span class="c1"># If it failed *after* db_engine creation but before container, db_engine might be open.</span>
        <span class="c1"># The helper itself doesn&#39;t call close_db_engine(); it expects lifespan to do so.</span>
        <span class="c1"># Global close_db_engine handles if engine was never set or already closed.</span>
        <span class="k">await</span> <span class="n">close_db_engine</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;DB Engine closed due to dependency initialization failure during startup.&quot;</span><span class="p">)</span>
        <span class="c1"># Re-raise to prevent application from starting up in a bad state.</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Application startup failed due to dependency initialization error: </span><span class="si">{</span><span class="n">init_exc</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">init_exc</span>

    <span class="k">yield</span>  <span class="c1"># Application runs here</span>

    <span class="c1"># Shutdown: Clean up resources</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Application shutdown sequence initiated.&quot;</span><span class="p">)</span>

    <span class="c1"># Close main DB engine (handles its own check if already closed or never initialized)</span>
    <span class="k">await</span> <span class="n">close_db_engine</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Main DB Engine closed.&quot;</span><span class="p">)</span>

    <span class="c1"># Shutdown: Close the HTTP client via the container if available</span>
    <span class="k">await</span> <span class="n">initialized_dependencies</span><span class="o">.</span><span class="n">http_client</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;HTTP Client from DependencyContainer closed.&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Application shutdown complete.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Manage the lifespan of the application resources.</p>
<p>This asynchronous context manager handles the startup and shutdown events
of the FastAPI application. It initializes dependencies on startup
and ensures they are properly cleaned up on shutdown.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>app</code>
            </td>
            <td>
                  <code><span title="fastapi.FastAPI">FastAPI</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The FastAPI application instance.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>None</code></td>            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>After startup procedures are complete, allowing the application to run.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If critical application dependencies fail to initialize during startup.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h3 id="luthien_control.main.read_root" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.main.read_root" class="doc-anchor"><code class="highlight language-python"><span class="n">read_root</span><span class="p">()</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/main.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">read_root</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide a simple root endpoint.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A welcome message indicating the proxy is running.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Luthien Control Proxy is running.&quot;</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Provide a simple root endpoint.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A welcome message indicating the proxy is running.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.proxy" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>proxy</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">










<div class="doc doc-object doc-module">



<h3 id="luthien_control.proxy.debugging" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>debugging</code>


</h3>

    <div class="doc doc-contents ">

        <p>Enhanced debugging utilities for the proxy pipeline.</p>









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.proxy.debugging.DebugLoggingMiddleware" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.proxy.debugging.DebugLoggingMiddleware" class="doc-anchor"><code>DebugLoggingMiddleware</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="starlette.middleware.base.BaseHTTPMiddleware">BaseHTTPMiddleware</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/proxy/debugging.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DebugLoggingMiddleware</span><span class="p">(</span><span class="n">BaseHTTPMiddleware</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Middleware to add detailed request/response logging for debugging.&quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">call_next</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">request_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;x-request-id&quot;</span><span class="p">,</span> <span class="s2">&quot;no-id&quot;</span><span class="p">)</span>

        <span class="c1"># Log request details</span>
        <span class="n">request_body</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;PATCH&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">request_body</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">()</span>

                <span class="c1"># Reconstruct request for downstream processing</span>
                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">receive</span><span class="p">():</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;http.request&quot;</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">request_body</span><span class="p">}</span>

                <span class="n">request</span><span class="o">.</span><span class="n">_receive</span> <span class="o">=</span> <span class="n">receive</span>

                <span class="c1"># Try to parse JSON for logging</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parsed_body</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request_body</span><span class="p">)</span> <span class="k">if</span> <span class="n">request_body</span> <span class="k">else</span> <span class="kc">None</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Incoming </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> request&quot;</span><span class="p">,</span>
                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                            <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">),</span>
                            <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">parsed_body</span><span class="p">,</span>
                            <span class="s2">&quot;query_params&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Incoming </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> request (non-JSON body)&quot;</span><span class="p">,</span>
                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                            <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                            <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">),</span>
                            <span class="s2">&quot;body_length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">request_body</span><span class="p">)</span> <span class="k">if</span> <span class="n">request_body</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
                            <span class="s2">&quot;query_params&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">),</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Error reading request body: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Incoming </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> request&quot;</span><span class="p">,</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                    <span class="s2">&quot;headers&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">),</span>
                    <span class="s2">&quot;query_params&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">)</span>

        <span class="c1"># Process request</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">call_next</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Calculate duration</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

        <span class="c1"># Log response details</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">request_id</span><span class="si">}</span><span class="s2">] Request completed&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                <span class="s2">&quot;status_code&quot;</span><span class="p">:</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
                <span class="s2">&quot;duration_seconds&quot;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Add debug headers</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Request-ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request_id</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s2">&quot;X-Processing-Time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">s&quot;</span>

        <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Middleware to add detailed request/response logging for debugging.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>
  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.proxy.debugging.create_debug_response" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.proxy.debugging.create_debug_response" class="doc-anchor"><code class="highlight language-python"><span class="n">create_debug_response</span><span class="p">(</span><span class="n">status_code</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">transaction_id</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">include_debug_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/proxy/debugging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_debug_response</span><span class="p">(</span>
    <span class="n">status_code</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">include_debug_info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a detailed error response for debugging.&quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
        <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">include_debug_info</span> <span class="ow">and</span> <span class="n">details</span><span class="p">:</span>
        <span class="n">response</span><span class="p">[</span><span class="s2">&quot;debug&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="o">**</span><span class="n">details</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">response</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Create a detailed error response for debugging.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.proxy.debugging.log_policy_execution" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.proxy.debugging.log_policy_execution" class="doc-anchor"><code class="highlight language-python"><span class="n">log_policy_execution</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">,</span> <span class="n">policy_name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/proxy/debugging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_policy_execution</span><span class="p">(</span>
    <span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">policy_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">status</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">duration</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">details</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log policy execution details.&quot;&quot;&quot;</span>
    <span class="n">log_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="n">transaction_id</span><span class="p">,</span>
        <span class="s2">&quot;policy_name&quot;</span><span class="p">:</span> <span class="n">policy_name</span><span class="p">,</span>
        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">status</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">duration</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;duration_seconds&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">error</span><span class="p">:</span>
        <span class="n">log_data</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>

    <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
        <span class="n">log_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">details</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2">] Policy </span><span class="si">{</span><span class="n">policy_name</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">log_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2">] Policy </span><span class="si">{</span><span class="n">policy_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">log_data</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Log policy execution details.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.proxy.debugging.log_transaction_state" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.proxy.debugging.log_transaction_state" class="doc-anchor"><code class="highlight language-python"><span class="n">log_transaction_state</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">,</span> <span class="n">stage</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/proxy/debugging.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">log_transaction_state</span><span class="p">(</span><span class="n">transaction_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Log transaction state at various stages of processing.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2">] Transaction state at </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="n">stage</span><span class="p">,</span> <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">UTC</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span> <span class="o">**</span><span class="n">details</span><span class="p">},</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Log transaction state at various stages of processing.</p>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.proxy.orchestration" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>orchestration</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.proxy.orchestration.run_policy_flow" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.proxy.orchestration.run_policy_flow" class="doc-anchor"><code class="highlight language-python"><span class="n">run_policy_flow</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">main_policy</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/proxy/orchestration.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_policy_flow</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">fastapi</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span>
    <span class="n">main_policy</span><span class="p">:</span> <span class="n">ControlPolicy</span><span class="p">,</span>
    <span class="n">dependencies</span><span class="p">:</span> <span class="n">DependencyContainer</span><span class="p">,</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">fastapi</span><span class="o">.</span><span class="n">Response</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Orchestrates the execution of the main ControlPolicy using injected dependencies.</span>
<span class="sd">    Exceptions raised by policies are expected to be caught by FastAPI exception handlers.</span>

<span class="sd">    Args:</span>
<span class="sd">        request: The incoming FastAPI request.</span>
<span class="sd">        main_policy: The main policy instance to execute.</span>
<span class="sd">        dependencies: The application&#39;s dependency container.</span>
<span class="sd">        session: The database session for this request.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The final FastAPI response.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Initialize Context</span>
    <span class="n">body</span> <span class="o">=</span> <span class="k">await</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">()</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="p">[</span><span class="s2">&quot;full_path&quot;</span><span class="p">]</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;authorization&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Bearer &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">transaction</span> <span class="o">=</span> <span class="n">_initialize_transaction</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">api_key</span><span class="p">)</span>

    <span class="c1"># Log initial transaction state</span>
    <span class="n">log_transaction_state</span><span class="p">(</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
        <span class="s2">&quot;initialization&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="s2">&quot;has_api_key&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">api_key</span><span class="p">),</span>
            <span class="s2">&quot;body_length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="k">if</span> <span class="n">body</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;headers_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="p">),</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="c1"># 2. Apply the main policy</span>
    <span class="n">policy_start_time</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Applying control policy&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
                <span class="s2">&quot;policy_name&quot;</span><span class="p">:</span> <span class="n">main_policy</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
                <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="n">policy_start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="k">await</span> <span class="n">main_policy</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">transaction</span><span class="o">=</span><span class="n">transaction</span><span class="p">,</span> <span class="n">container</span><span class="o">=</span><span class="n">dependencies</span><span class="p">,</span> <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">)</span>

        <span class="c1"># Log successful policy execution</span>
        <span class="n">log_policy_execution</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
            <span class="n">main_policy</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;completed&quot;</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">policy_start_time</span> <span class="k">if</span> <span class="n">policy_start_time</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;has_response&quot;</span><span class="p">:</span> <span class="n">transaction</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Policy execution complete&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
                <span class="s2">&quot;policy_name&quot;</span><span class="p">:</span> <span class="n">main_policy</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;duration_seconds&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">policy_start_time</span> <span class="k">if</span> <span class="n">policy_start_time</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">transaction</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">payload</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">final_response</span> <span class="o">=</span> <span class="n">openai_chat_completions_response_to_fastapi_response</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">final_response</span> <span class="o">=</span> <span class="n">JSONResponse</span><span class="p">(</span>
                <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
                <span class="n">content</span><span class="o">=</span><span class="p">{</span>
                    <span class="s2">&quot;detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Internal Server Error: No response payload&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
                    <span class="s2">&quot;policy_name&quot;</span><span class="p">:</span> <span class="n">main_policy</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">)</span>

    <span class="k">except</span> <span class="n">ControlPolicyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Log policy error</span>
        <span class="n">policy_duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">policy_start_time</span> <span class="k">if</span> <span class="n">policy_start_time</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">log_policy_execution</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
            <span class="n">main_policy</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">policy_duration</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s2">&quot;policy_name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;policy_name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Control policy error - transaction </span><span class="si">{</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s2">&quot;policy_name&quot;</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;policy_name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># Directly build a JSONResponse for policy errors</span>
        <span class="n">policy_name_for_error</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;policy_name&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
        <span class="n">status_code</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;status_code&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">status</span><span class="o">.</span><span class="n">HTTP_400_BAD_REQUEST</span>  <span class="c1"># Use 400 if None or not specified</span>
        <span class="n">error_detail</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;detail&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>  <span class="c1"># Use str(e) if no detail attribute</span>

        <span class="c1"># Check if we&#39;re in dev mode and if the exception has debug info</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
        <span class="n">debug_details</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">dev_mode</span><span class="p">():</span>
            <span class="c1"># Check if the ControlPolicyError itself has debug info</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;debug_info&quot;</span><span class="p">):</span>
                <span class="n">debug_details</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">debug_info</span>  <span class="c1"># type: ignore</span>
            <span class="c1"># Check if the underlying exception (__cause__) has debug info</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;__cause__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__cause__</span><span class="p">,</span> <span class="s2">&quot;debug_info&quot;</span><span class="p">):</span>
                <span class="n">debug_details</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">__cause__</span><span class="o">.</span><span class="n">debug_info</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Use create_debug_response to generate the response</span>
        <span class="n">response_content</span> <span class="o">=</span> <span class="n">create_debug_response</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Policy error in &#39;</span><span class="si">{</span><span class="n">policy_name_for_error</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">error_detail</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
            <span class="n">details</span><span class="o">=</span><span class="n">debug_details</span><span class="p">,</span>
            <span class="n">include_debug_info</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">dev_mode</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="n">final_response</span> <span class="o">=</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status_code</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">response_content</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># Log unexpected error</span>
        <span class="n">policy_duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">policy_start_time</span> <span class="k">if</span> <span class="n">policy_start_time</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">log_policy_execution</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
            <span class="n">main_policy</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="s2">&quot;unknown&quot;</span><span class="p">,</span>
            <span class="s2">&quot;error&quot;</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="n">policy_duration</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
            <span class="n">details</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s2">&quot;unexpected&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>

        <span class="c1"># Handle unexpected errors during initialization or policy execution</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unhandled exception during policy flow - transaction </span><span class="si">{</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;transaction_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
                <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
                <span class="s2">&quot;error_type&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="c1"># Try to build an error response using the builder</span>
        <span class="n">policy_name_for_error</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">main_policy</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">main_policy</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="c1"># Check if we&#39;re in dev mode and if the exception has debug info</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="n">Settings</span><span class="p">()</span>
        <span class="n">debug_details</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">dev_mode</span><span class="p">()</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s2">&quot;debug_info&quot;</span><span class="p">):</span>
            <span class="n">debug_details</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">debug_info</span>  <span class="c1"># type: ignore</span>

        <span class="c1"># Use create_debug_response to generate the response</span>
        <span class="n">response_content</span> <span class="o">=</span> <span class="n">create_debug_response</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Internal Server Error&quot;</span><span class="p">,</span>
            <span class="n">transaction_id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">transaction</span><span class="o">.</span><span class="n">transaction_id</span><span class="p">),</span>
            <span class="n">details</span><span class="o">=</span><span class="n">debug_details</span><span class="p">,</span>
            <span class="n">include_debug_info</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">dev_mode</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="c1"># Add policy name to the response</span>
        <span class="n">response_content</span><span class="p">[</span><span class="s2">&quot;policy_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">policy_name_for_error</span>

        <span class="n">final_response</span> <span class="o">=</span> <span class="n">JSONResponse</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="n">status</span><span class="o">.</span><span class="n">HTTP_500_INTERNAL_SERVER_ERROR</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="n">response_content</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">final_response</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Orchestrates the execution of the main ControlPolicy using injected dependencies.
Exceptions raised by policies are expected to be caught by FastAPI exception handlers.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>request</code>
            </td>
            <td>
                  <code><span title="fastapi.Request">Request</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The incoming FastAPI request.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>main_policy</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    ControlPolicy" href="#luthien_control.control_policy.control_policy.ControlPolicy">ControlPolicy</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The main policy instance to execute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dependencies</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="    DependencyContainer" href="#luthien_control.core.dependency_container.DependencyContainer">DependencyContainer</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The application's dependency container.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>session</code>
            </td>
            <td>
                  <code><span title="sqlalchemy.ext.asyncio.AsyncSession">AsyncSession</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The database session for this request.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="fastapi.Response">Response</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The final FastAPI response.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.proxy.server" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>server</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">







  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.proxy.server.api_proxy_endpoint" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.proxy.server.api_proxy_endpoint" class="doc-anchor"><code class="highlight language-python"><span class="n">api_proxy_endpoint</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">full_path</span><span class="o">=</span><span class="n">default_path</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_dependencies</span><span class="p">),</span> <span class="n">main_policy</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_main_control_policy</span><span class="p">),</span> <span class="n">session</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span> <span class="n">payload</span><span class="o">=</span><span class="n">default_payload</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">Security</span><span class="p">(</span><span class="n">http_bearer_auth</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/proxy/server.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
    <span class="s2">&quot;/api/{full_path:path}&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_proxy_endpoint</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">full_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">default_path</span><span class="p">,</span>
    <span class="c1"># --- Core Dependencies ---</span>
    <span class="n">dependencies</span><span class="p">:</span> <span class="n">DependencyContainer</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_dependencies</span><span class="p">),</span>
    <span class="n">main_policy</span><span class="p">:</span> <span class="n">ControlPolicy</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_main_control_policy</span><span class="p">),</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
    <span class="c1"># --- Swagger UI Enhancements ---</span>
    <span class="c1"># The &#39;payload&#39; and &#39;token&#39; parameters enhance the Swagger UI:</span>
    <span class="c1"># - &#39;payload&#39; (dict[str, Any], optional): Provides a schema for the request body.</span>
    <span class="c1">#   Actual body content is read directly from the &#39;request&#39; object.</span>
    <span class="c1"># - &#39;token&#39; (Optional[str]): Enables the &#39;Authorize&#39; button (Bearer token).</span>
    <span class="c1">#   Actual token validation is handled by the policy flow.</span>
    <span class="n">payload</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_payload</span><span class="p">,</span>
    <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">http_bearer_auth</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main API proxy endpoint using the policy orchestration flow.</span>
<span class="sd">    Handles requests starting with /api/.</span>
<span class="sd">    Uses Dependency Injection Container and provides a DB session.</span>

<span class="sd">    **Authentication Note:** This endpoint uses Bearer Token authentication</span>
<span class="sd">    (Authorization: Bearer &lt;token&gt;). However, the requirement for a valid token</span>
<span class="sd">    depends on whether the currently configured control policy includes client</span>
<span class="sd">    authentication (e.g., ClientApiKeyAuthPolicy). If the policy does not require</span>
<span class="sd">    authentication, the token field can be left blank.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">_handle_api_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">main_policy</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Main API proxy endpoint using the policy orchestration flow.
Handles requests starting with /api/.
Uses Dependency Injection Container and provides a DB session.</p>
<p><strong>Authentication Note:</strong> This endpoint uses Bearer Token authentication
(Authorization: Bearer <token>). However, the requirement for a valid token
depends on whether the currently configured control policy includes client
authentication (e.g., ClientApiKeyAuthPolicy). If the policy does not require
authentication, the token field can be left blank.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.proxy.server.api_proxy_get_endpoint" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.proxy.server.api_proxy_get_endpoint" class="doc-anchor"><code class="highlight language-python"><span class="n">api_proxy_get_endpoint</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">full_path</span><span class="o">=</span><span class="n">default_path</span><span class="p">,</span> <span class="n">dependencies</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_dependencies</span><span class="p">),</span> <span class="n">main_policy</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_main_control_policy</span><span class="p">),</span> <span class="n">session</span><span class="o">=</span><span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span> <span class="n">token</span><span class="o">=</span><span class="n">Security</span><span class="p">(</span><span class="n">http_bearer_auth</span><span class="p">))</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/proxy/server.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="s2">&quot;/api/{full_path:path}&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_proxy_get_endpoint</span><span class="p">(</span>
    <span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span>
    <span class="n">full_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">default_path</span><span class="p">,</span>
    <span class="c1"># --- Core Dependencies ---</span>
    <span class="n">dependencies</span><span class="p">:</span> <span class="n">DependencyContainer</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_dependencies</span><span class="p">),</span>
    <span class="n">main_policy</span><span class="p">:</span> <span class="n">ControlPolicy</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_main_control_policy</span><span class="p">),</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_session</span><span class="p">),</span>
    <span class="c1"># --- Swagger UI Enhancements ---</span>
    <span class="c1"># - &#39;token&#39; (Optional[str]): Enables the &#39;Authorize&#39; button (Bearer token).</span>
    <span class="c1">#   Actual token validation is handled by the policy flow.</span>
    <span class="n">token</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Security</span><span class="p">(</span><span class="n">http_bearer_auth</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main API proxy endpoint for GET requests using the policy orchestration flow.</span>
<span class="sd">    Handles GET requests starting with /api/.</span>
<span class="sd">    Uses Dependency Injection Container and provides a DB session.</span>

<span class="sd">    **Authentication Note:** This endpoint uses Bearer Token authentication</span>
<span class="sd">    (Authorization: Bearer &lt;token&gt;). However, the requirement for a valid token</span>
<span class="sd">    depends on whether the currently configured control policy includes client</span>
<span class="sd">    authentication (e.g., ClientApiKeyAuthPolicy). If the policy does not require</span>
<span class="sd">    authentication, the token field can be left blank.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">_handle_api_request</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">main_policy</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Main API proxy endpoint for GET requests using the policy orchestration flow.
Handles GET requests starting with /api/.
Uses Dependency Injection Container and provides a DB session.</p>
<p><strong>Authentication Note:</strong> This endpoint uses Bearer Token authentication
(Authorization: Bearer <token>). However, the requirement for a valid token
depends on whether the currently configured control policy includes client
authentication (e.g., ClientApiKeyAuthPolicy). If the policy does not require
authentication, the token field can be left blank.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.proxy.server.api_proxy_options_handler" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>    <a href="#luthien_control.proxy.server.api_proxy_options_handler" class="doc-anchor"><code class="highlight language-python"><span class="n">api_proxy_options_handler</span><span class="p">(</span><span class="n">full_path</span><span class="o">=</span><span class="n">default_path</span><span class="p">)</span></code></a>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/proxy/server.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@router</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="s2">&quot;/api/{full_path:path}&quot;</span><span class="p">)</span>
<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">api_proxy_options_handler</span><span class="p">(</span>
    <span class="n">full_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">default_path</span><span class="p">,</span>  <span class="c1"># Keep for path consistency, though not used in this simple handler</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles OPTIONS requests for the API proxy endpoint, indicating allowed methods.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Explicit OPTIONS request received for /api/</span><span class="si">{</span><span class="n">full_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;Allow&quot;</span><span class="p">:</span> <span class="s2">&quot;GET, POST, OPTIONS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Access-Control-Allow-Origin&quot;</span><span class="p">:</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span>  <span class="c1"># Allow any origin</span>
        <span class="s2">&quot;Access-Control-Allow-Methods&quot;</span><span class="p">:</span> <span class="s2">&quot;GET, POST, OPTIONS&quot;</span><span class="p">,</span>  <span class="c1"># Allowed methods</span>
        <span class="s2">&quot;Access-Control-Allow-Headers&quot;</span><span class="p">:</span> <span class="s2">&quot;Authorization, Content-Type&quot;</span><span class="p">,</span>  <span class="c1"># Allowed headers</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Handles OPTIONS requests for the API proxy endpoint, indicating allowed methods.</p>


    </div>

</div>



  </div>

    </div>

</div>


  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.settings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>settings</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h3 id="luthien_control.settings.Settings" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.settings.Settings" class="doc-anchor"><code>Settings</code></a>


</h3>


    <div class="doc doc-contents ">


          <details class="quote">
            <summary>Source code in <code>luthien_control/settings.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Settings</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Application configuration settings loaded from environment variables.&quot;&quot;&quot;</span>

    <span class="c1"># --- Core Settings ---</span>
    <span class="n">BACKEND_URL</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># Comma-separated list of control policies for the beta framework</span>

    <span class="c1"># --- Database Settings ---</span>
    <span class="n">DB_SERVER</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
    <span class="n">DB_USER</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">DB_PASSWORD</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">DB_NAME</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">DB_HOST</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">DB_PORT</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5432</span>

    <span class="c1"># --- OpenAI Settings ---</span>
    <span class="n">OPENAI_API_KEY</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># --- Helper Methods using os.getenv ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_backend_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the backend URL as a string, if set.&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BACKEND_URL&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
            <span class="c1"># Basic validation (can be enhanced)</span>
            <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid BACKEND_URL format: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">url</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_database_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the primary DATABASE_URL, if set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_URL&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_openai_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the OpenAI API key, if set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_top_level_policy_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the name of the top-level policy instance to load.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TOP_LEVEL_POLICY_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_policy_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the path to the policy file, if set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POLICY_FILEPATH&quot;</span><span class="p">)</span>

    <span class="c1"># --- Database settings Getters using os.getenv ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_postgres_user</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_USER&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_postgres_password</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_PASSWORD&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_postgres_db</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_NAME&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_postgres_host</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_HOST&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_postgres_port</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the PostgreSQL port as an integer, or None if not set.&quot;&quot;&quot;</span>
        <span class="n">port_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_PORT&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">port_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">port_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DB_PORT environment variable must be an integer.&quot;</span><span class="p">)</span>

    <span class="c1"># --- DB Pool Size Getters ---</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_main_db_pool_min_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the minimum pool size for the main DB.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MAIN_DB_POOL_MIN_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MAIN_DB_POOL_MIN_SIZE environment variable must be an integer.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_main_db_pool_max_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the maximum pool size for the main DB.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MAIN_DB_POOL_MAX_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MAIN_DB_POOL_MAX_SIZE environment variable must be an integer.&quot;</span><span class="p">)</span>

    <span class="c1"># --- Logging Settings --- #</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_log_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the configured log level, defaulting if not set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOG_LEVEL&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

    <span class="c1"># uvicorn</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_app_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the configured app host, defaulting if not set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTHIEN_CONTROL_HOST&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_app_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the configured app port, defaulting if not set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTHIEN_CONTROL_PORT&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_app_reload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Gets the configured app reload, defaulting if not set.&quot;&quot;&quot;</span>
        <span class="n">reload</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTHIEN_CONTROL_RELOAD&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">reload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">default</span>
        <span class="k">elif</span> <span class="n">reload</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="n">reload</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LUTHIEN_CONTROL_RELOAD environment variable must be &#39;true&#39; or &#39;false&#39; (got </span><span class="si">{</span><span class="n">reload</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

    <span class="c1"># get_log_level is reused</span>

    <span class="c1"># --- Database DSN Helper Properties using Getters ---</span>
    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">admin_dsn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DSN for connecting to the default &#39;postgres&#39; db for admin tasks.</span>
<span class="sd">        Raises ValueError if required DB settings are missing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_user</span><span class="p">()</span>
        <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_password</span><span class="p">()</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_host</span><span class="p">()</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_port</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">]):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">name</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;PASSWORD&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;HOST&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span>
            <span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required database settings (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">) for admin_dsn&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;postgresql://</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">/postgres&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">base_dsn</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Base DSN without a specific database name.</span>
<span class="sd">        Raises ValueError if required DB settings are missing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_user</span><span class="p">()</span>
        <span class="n">password</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_password</span><span class="p">()</span>
        <span class="n">host</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_host</span><span class="p">()</span>
        <span class="n">port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_port</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">]):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">name</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;USER&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;PASSWORD&quot;</span><span class="p">,</span> <span class="n">password</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;HOST&quot;</span><span class="p">,</span> <span class="n">host</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;PORT&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">val</span>
            <span class="p">]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required database settings (</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">) for base_dsn&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;postgresql://</span><span class="si">{</span><span class="n">user</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">password</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_db_dsn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the DSN for a specific database name, or the default DB_NAME.</span>
<span class="sd">        Raises ValueError if required DB settings or the target db_name are missing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">target_db</span> <span class="o">=</span> <span class="n">db_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_db</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">target_db</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing target database name (either provide db_name or set DB_NAME env var)&quot;</span><span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dsn</span>  <span class="c1"># Use property</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">target_db</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_run_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the run mode, defaulting to &#39;prod&#39; if not set.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RUN_MODE&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dev_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns True if the run mode is &#39;dev&#39;, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_mode</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;dev&quot;</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>Application configuration settings loaded from environment variables.</p>









  <div class="doc doc-children">





<h4 id="luthien_control.settings.Settings.admin_dsn" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>
</h4>
        <p>DSN for connecting to the default 'postgres' db for admin tasks.
Raises ValueError if required DB settings are missing.</p>



<div class="doc doc-object doc-attribute">



<h4 id="luthien_control.settings.Settings.admin_dsn" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">admin_dsn</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>DSN for connecting to the default 'postgres' db for admin tasks.
Raises ValueError if required DB settings are missing.</p>

    </div>

</div><h4 id="luthien_control.settings.Settings.base_dsn" class="doc doc-heading"><code class="highlight language-python"></code>
  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>
</h4>
        <p>Base DSN without a specific database name.
Raises ValueError if required DB settings are missing.</p>



<div class="doc doc-object doc-attribute">



<h4 id="luthien_control.settings.Settings.base_dsn" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">base_dsn</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h4>


    <div class="doc doc-contents ">

        <p>Base DSN without a specific database name.
Raises ValueError if required DB settings are missing.</p>

    </div>

</div>

  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.dev_mode" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.dev_mode" class="doc-anchor"><code class="highlight language-python"><span class="n">dev_mode</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dev_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True if the run mode is &#39;dev&#39;, False otherwise.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_run_mode</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;dev&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns True if the run mode is 'dev', False otherwise.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_app_host" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_app_host" class="doc-anchor"><code class="highlight language-python"><span class="n">get_app_host</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_app_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the configured app host, defaulting if not set.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTHIEN_CONTROL_HOST&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Gets the configured app host, defaulting if not set.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_app_port" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_app_port" class="doc-anchor"><code class="highlight language-python"><span class="n">get_app_port</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">8000</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_app_port</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the configured app port, defaulting if not set.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTHIEN_CONTROL_PORT&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Gets the configured app port, defaulting if not set.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_app_reload" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_app_reload" class="doc-anchor"><code class="highlight language-python"><span class="n">get_app_reload</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_app_reload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the configured app reload, defaulting if not set.&quot;&quot;&quot;</span>
    <span class="n">reload</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LUTHIEN_CONTROL_RELOAD&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">reload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>
    <span class="k">elif</span> <span class="n">reload</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">reload</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;LUTHIEN_CONTROL_RELOAD environment variable must be &#39;true&#39; or &#39;false&#39; (got </span><span class="si">{</span><span class="n">reload</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Gets the configured app reload, defaulting if not set.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_backend_url" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_backend_url" class="doc-anchor"><code class="highlight language-python"><span class="n">get_backend_url</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_backend_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the backend URL as a string, if set.&quot;&quot;&quot;</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;BACKEND_URL&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">url</span><span class="p">:</span>
        <span class="c1"># Basic validation (can be enhanced)</span>
        <span class="n">parsed</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">parsed</span><span class="o">.</span><span class="n">scheme</span><span class="p">,</span> <span class="n">parsed</span><span class="o">.</span><span class="n">netloc</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid BACKEND_URL format: </span><span class="si">{</span><span class="n">url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">url</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns the backend URL as a string, if set.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_database_url" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_database_url" class="doc-anchor"><code class="highlight language-python"><span class="n">get_database_url</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_database_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the primary DATABASE_URL, if set.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DATABASE_URL&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns the primary DATABASE_URL, if set.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_db_dsn" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_db_dsn" class="doc-anchor"><code class="highlight language-python"><span class="n">get_db_dsn</span><span class="p">(</span><span class="n">db_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_db_dsn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the DSN for a specific database name, or the default DB_NAME.</span>
<span class="sd">    Raises ValueError if required DB settings or the target db_name are missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">target_db</span> <span class="o">=</span> <span class="n">db_name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_postgres_db</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">target_db</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing target database name (either provide db_name or set DB_NAME env var)&quot;</span><span class="p">)</span>
    <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_dsn</span>  <span class="c1"># Use property</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">target_db</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns the DSN for a specific database name, or the default DB_NAME.
Raises ValueError if required DB settings or the target db_name are missing.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_log_level" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_log_level" class="doc-anchor"><code class="highlight language-python"><span class="n">get_log_level</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;INFO&#39;</span><span class="p">)</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_log_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;INFO&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the configured log level, defaulting if not set.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;LOG_LEVEL&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Gets the configured log level, defaulting if not set.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_main_db_pool_max_size" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_main_db_pool_max_size" class="doc-anchor"><code class="highlight language-python"><span class="n">get_main_db_pool_max_size</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_main_db_pool_max_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the maximum pool size for the main DB.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MAIN_DB_POOL_MAX_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MAIN_DB_POOL_MAX_SIZE environment variable must be an integer.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns the maximum pool size for the main DB.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_main_db_pool_min_size" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_main_db_pool_min_size" class="doc-anchor"><code class="highlight language-python"><span class="n">get_main_db_pool_min_size</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_main_db_pool_min_size</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the minimum pool size for the main DB.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;MAIN_DB_POOL_MIN_SIZE&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;MAIN_DB_POOL_MIN_SIZE environment variable must be an integer.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns the minimum pool size for the main DB.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_openai_api_key" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_openai_api_key" class="doc-anchor"><code class="highlight language-python"><span class="n">get_openai_api_key</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_openai_api_key</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the OpenAI API key, if set.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns the OpenAI API key, if set.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_policy_filepath" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_policy_filepath" class="doc-anchor"><code class="highlight language-python"><span class="n">get_policy_filepath</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_policy_filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the path to the policy file, if set.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;POLICY_FILEPATH&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns the path to the policy file, if set.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_postgres_port" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_postgres_port" class="doc-anchor"><code class="highlight language-python"><span class="n">get_postgres_port</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_postgres_port</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the PostgreSQL port as an integer, or None if not set.&quot;&quot;&quot;</span>
    <span class="n">port_str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;DB_PORT&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">port_str</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">port_str</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DB_PORT environment variable must be an integer.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns the PostgreSQL port as an integer, or None if not set.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_run_mode" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_run_mode" class="doc-anchor"><code class="highlight language-python"><span class="n">get_run_mode</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_run_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the run mode, defaulting to &#39;prod&#39; if not set.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;RUN_MODE&quot;</span><span class="p">,</span> <span class="s2">&quot;prod&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns the run mode, defaulting to 'prod' if not set.</p>


    </div>

</div>  

  

<div class="doc doc-object doc-function">


<h4 id="luthien_control.settings.Settings.get_top_level_policy_name" class="doc doc-heading">


<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>    <a href="#luthien_control.settings.Settings.get_top_level_policy_name" class="doc-anchor"><code class="highlight language-python"><span class="n">get_top_level_policy_name</span><span class="p">()</span></code></a>


</h4>


    <div class="doc doc-contents ">

        <details class="quote">
          <summary>Source code in <code>luthien_control/settings.py</code></summary>
          <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_top_level_policy_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the name of the top-level policy instance to load.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;TOP_LEVEL_POLICY_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
        </details>


        <p>Returns the name of the top-level policy instance to load.</p>


    </div>

</div>



  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="luthien_control.utils" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>utils</code>


</h2>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h3 id="luthien_control.utils.DeepEventedModel" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.utils.DeepEventedModel" class="doc-anchor"><code>DeepEventedModel</code></a>


</h3>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="psygnal.EventedModel">EventedModel</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/utils/deep_evented_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DeepEventedModel</span><span class="p">(</span><span class="n">EventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Pydantic EventedModel that emits a single `changed` signal on any change.</span>

<span class="sd">    This includes changes to top-level fields as well as changes within</span>
<span class="sd">    nested evented containers (like EventedList, EventedDict) or other</span>
<span class="sd">    DeepEventedModel instances.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        changed: A signal that is emitted with no arguments when any value</span>
<span class="sd">                 in the model or its nested evented children changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">changed</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Signal</span><span class="p">]</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Connect our master `changed` signal to the base model&#39;s event group.</span>
        <span class="c1"># This handles all top-level field assignments.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
        <span class="c1"># Connect to the event groups of any initial child objects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connect_children</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Before the attribute is set, we must disconnect from the old child object.</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
            <span class="n">old_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_child</span><span class="p">(</span><span class="n">old_value</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># After the attribute is set, we connect to the new child object.</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
            <span class="c1"># The base EventedModel handles emitting the field-specific signal,</span>
            <span class="c1"># which is already piped to our `changed` signal.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If `child` is an evented object, connect its events to our signal.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">DeepEventedModel</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">EventedList</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_inserted</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">removed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_removed</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">child</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">EventedDict</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">added</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_added</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_evented</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_disconnect_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If `child` is an evented object, disconnect its events.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">DeepEventedModel</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">EventedList</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_inserted</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">removed</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_removed</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">child</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">EventedDict</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">added</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_added</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_evented</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_on_item_inserted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_on_item_removed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_child</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_on_item_added</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect to the events of all evented children in the model.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_evented</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an object has a connectable `events` signal group.&quot;&quot;&quot;</span>
        <span class="n">events</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">events</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="nd">@model_serializer</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wrap&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom model serializer that converts EventedList and EventedDict to regular containers.&quot;&quot;&quot;</span>
        <span class="c1"># First, check if this model actually has any EventedList or EventedDict fields</span>
        <span class="n">has_evented_containers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">EventedList</span><span class="p">,</span> <span class="n">EventedDict</span><span class="p">)):</span>
                <span class="n">has_evented_containers</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="c1"># If no evented containers, use default serialization</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_evented_containers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Otherwise, handle evented containers specially</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">EventedList</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">EventedDict</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For other types, use the default field serialization</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A Pydantic EventedModel that emits a single <code>changed</code> signal on any change.</p>
<p>This includes changes to top-level fields as well as changes within
nested evented containers (like EventedList, EventedDict) or other
DeepEventedModel instances.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.utils.DeepEventedModel.changed">changed</span></code></td>
            <td>
                  <code><span title="psygnal.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A signal that is emitted with no arguments when any value
     in the model or its nested evented children changes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">











  </div>


    </div>

</div>



<div class="doc doc-object doc-module">



<h3 id="luthien_control.utils.backend_call_spec" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>backend_call_spec</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.utils.backend_call_spec.BackendCallSpec" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.utils.backend_call_spec.BackendCallSpec" class="doc-anchor"><code>BackendCallSpec</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/utils/backend_call_spec.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BackendCallSpec</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A specification for a backend LLM call.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;gpt-4o-mini&quot;</span><span class="p">)</span>
    <span class="n">api_endpoint</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;https://api.openai.com/v1&quot;</span><span class="p">)</span>
    <span class="n">api_key_env_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;OPENAI_API_KEY&quot;</span><span class="p">)</span>
    <span class="n">request_args</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Arguments to be passed to OpenAIChatCompletionsRequest.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A specification for a backend LLM call.</p>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h3 id="luthien_control.utils.deep_evented_model" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>deep_evented_model</code>


</h3>

    <div class="doc doc-contents ">









  <div class="doc doc-children">






  

  

<div class="doc doc-object doc-class">



<h4 id="luthien_control.utils.deep_evented_model.DeepEventedModel" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>    <a href="#luthien_control.utils.deep_evented_model.DeepEventedModel" class="doc-anchor"><code>DeepEventedModel</code></a>


</h4>


    <div class="doc doc-contents ">

        <p class="doc doc-class-bases">
          Bases: <code><span title="psygnal.EventedModel">EventedModel</span></code></p>

          <details class="quote">
            <summary>Source code in <code>luthien_control/utils/deep_evented_model.py</code></summary>
            <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  8</span>
<span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DeepEventedModel</span><span class="p">(</span><span class="n">EventedModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A Pydantic EventedModel that emits a single `changed` signal on any change.</span>

<span class="sd">    This includes changes to top-level fields as well as changes within</span>
<span class="sd">    nested evented containers (like EventedList, EventedDict) or other</span>
<span class="sd">    DeepEventedModel instances.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        changed: A signal that is emitted with no arguments when any value</span>
<span class="sd">                 in the model or its nested evented children changes.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_config</span> <span class="o">=</span> <span class="n">ConfigDict</span><span class="p">(</span><span class="n">arbitrary_types_allowed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">changed</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Signal</span><span class="p">]</span> <span class="o">=</span> <span class="n">Signal</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Connect our master `changed` signal to the base model&#39;s event group.</span>
        <span class="c1"># This handles all top-level field assignments.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
        <span class="c1"># Connect to the event groups of any initial child objects.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connect_children</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Before the attribute is set, we must disconnect from the old child object.</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
            <span class="n">old_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_child</span><span class="p">(</span><span class="n">old_value</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c1"># After the attribute is set, we connect to the new child object.</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
            <span class="n">new_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
            <span class="c1"># The base EventedModel handles emitting the field-specific signal,</span>
            <span class="c1"># which is already piped to our `changed` signal.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If `child` is an evented object, connect its events to our signal.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">DeepEventedModel</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">EventedList</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_inserted</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">removed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_removed</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">child</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">EventedDict</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">added</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_added</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_evented</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_disconnect_child</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;If `child` is an evented object, disconnect its events.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">DeepEventedModel</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">changed</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">EventedList</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_inserted</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">removed</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_removed</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">child</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">EventedDict</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">added</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_item_added</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_child</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_evented</span><span class="p">(</span><span class="n">child</span><span class="p">):</span>
            <span class="n">child</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_on_item_inserted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_on_item_removed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_disconnect_child</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_on_item_added</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_connect_children</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connect to the events of all evented children in the model.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_connect_child</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_evented</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if an object has a connectable `events` signal group.&quot;&quot;&quot;</span>
        <span class="n">events</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">events</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

    <span class="nd">@model_serializer</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;wrap&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_serialize_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serializer</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom model serializer that converts EventedList and EventedDict to regular containers.&quot;&quot;&quot;</span>
        <span class="c1"># First, check if this model actually has any EventedList or EventedDict fields</span>
        <span class="n">has_evented_containers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">EventedList</span><span class="p">,</span> <span class="n">EventedDict</span><span class="p">)):</span>
                <span class="n">has_evented_containers</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>

        <span class="c1"># If no evented containers, use default serialization</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_evented_containers</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">serializer</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Otherwise, handle evented containers specially</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">field_info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">EventedList</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">EventedDict</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># For other types, use the default field serialization</span>
                <span class="n">data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="n">data</span>
</code></pre></div></td></tr></table></div>
          </details>


        <p>A Pydantic EventedModel that emits a single <code>changed</code> signal on any change.</p>
<p>This includes changes to top-level fields as well as changes within
nested evented containers (like EventedList, EventedDict) or other
DeepEventedModel instances.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="luthien_control.utils.deep_evented_model.DeepEventedModel.changed">changed</span></code></td>
            <td>
                  <code><span title="psygnal.Signal">Signal</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A signal that is emitted with no arguments when any value
     in the model or its nested evented children changes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>









  <div class="doc doc-children">











  </div>


    </div>

</div>




  </div>

    </div>

</div>


  </div>

    </div>

</div>


  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["toc.integrate", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotation", "content.code.copy"], "search": "assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="js/custom_toc.js"></script>
      
    
  </body>
</html>